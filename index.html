<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Учет закупки</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #171e26;
            color: #c7d5e0;
            display: flex;
            min-height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
            position: relative;
            zoom: 1;
            height: 100vh;
        }
        html {
            transform-origin: top left;
            font-size: 13.4px;
        }
        /* Сайдбар в стиле Steam */
        .sidebar {
            width: 20px;
            background: linear-gradient(180deg, #171a21 0%, #1b2838 100%);
            padding: 6.7px 0;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            border-right: 0.67px solid #3d4450;
            box-shadow: 1.34px 0 6.7px rgba(0,0,0,0.3);
            z-index: 1000;
            overflow-y: hidden;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 10.05px;
            max-height: calc(100vh - 134.0px);
        }

        .sidebar-divider {
            height: 0.67px;
            background: linear-gradient(90deg, transparent 0%, #3d4450 50%, transparent 100%);
            margin: 5.36px 10.05px;
            opacity: 0.5;
            width: 13px;
        }

        .sidebar-cell {
            width: 15px;
            height: 15px;
            margin: 3.35px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4.02px;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .sidebar-cell.menu-item {
            background: transparent;
            border: 0.67px solid rgba(102, 192, 244, 0.3);
            border-radius: 4.02px;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 15px;
            height: 15px;
            margin: 3.35px 0;
        }

        .sidebar-cell.menu-item:hover {
            background: linear-gradient(135deg, rgba(62, 126, 167, 0.3) 0%, transparent 100%) !important;
            border-color: #66c0f4 !important;
            box-shadow: 0 0 6.7px rgba(102, 192, 244, 0.5);
        }

        .sidebar-cell.menu-item.active {
            background: linear-gradient(135deg, rgba(62, 126, 167, 0.5) 0%, transparent 100%);
            border-color: #66c0f4;
            box-shadow: 0 0 10.05px rgba(102, 192, 244, 0.7);
        }

        .sidebar-cell.button {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 0.67px solid #3d4450;
            border-radius: 4.02px;
        }

        .sidebar-cell.button:hover {
            background: linear-gradient(135deg, #75c9ff 0%, #5a9bdb 100%);
            transform: translateY(-1.34px);
            box-shadow: 0 2.68px 5.36px rgba(0,0,0,0.2);
        }

        .sidebar-cell.menu-item.danger .sidebar-icon {
            color: #be463c;
        }

        .sidebar-cell.menu-item.danger:hover .sidebar-icon {
            color: #be463c;
        }

        .sidebar-cell.button.success {
            background: linear-gradient(135deg, #5c7e10 0%, #4c6b22 100%);
        }

        .sidebar-cell.button.success:hover {
            background: linear-gradient(135deg, #6b8f12 0%, #5c7e10 100%);
        }

        .sidebar-icon {
            font-size: 10px;
            color: #c7d5e0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .sidebar-cell.menu-item.active .sidebar-icon,
        .sidebar-cell.menu-item:hover .sidebar-icon {
            color: #66c0f4;
        }

        .sidebar-cell.button .sidebar-icon {
            color: white;
        }

        .sidebar-badge {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #be9e3c 0%, #8c2c24 100%);
    color: white;
    border-radius: 50%;
    width: 10px;
    height: 10px;
    font-size: 6.7px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    box-shadow: 0 1.34px 2.68px rgba(0,0,0,0.3);
    animation: pulse 2s infinite;
    pointer-events: none; /* Чтобы не мешал кликам */
    z-index: 10;
}

.sidebar-badge.warning {
    background: linear-gradient(135deg, #ff6200 0%, #ffa500 100%);
    color: #1b2838;
}

        @keyframes pulse {
    0% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.1); }
    100% { transform: translate(-50%, -50%) scale(1); }
}

        /* Подсказки при наведении */
        .sidebar-cell {
            position: relative;
        }

        .sidebar-tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 6.7px;
            background: rgba(27, 40, 56, 0.95);
            color: #c7d5e0;
            padding: 5.36px 8.04px;
            border-radius: 2.68px;
            font-size: 8.04px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1001;
            border: 0.67px solid #3d4450;
            box-shadow: 0 2.68px 8.04px rgba(0,0,0,0.3);
        }

        .sidebar-cell:hover .sidebar-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Адаптивность */
        @media (max-width: 514.56px) {
            .sidebar-cell.menu-item {
                width: 30.15px;
                height: 30.15px;
            }
            
            .sidebar-cell {
                width: 30.15px;
                height: 30.15px;
            }
            
            .sidebar-icon {
                font-size: 12.06px;
            }
        }

        .menu-item {
            padding: 10.05px 13.4px;
            color: #8f98a0;
            text-decoration: none;
            display: block;
            transition: all 0.3s;
            border-left: 2.01px solid transparent;
            font-size: 12.06px;
        }

        .menu-item:hover {
            background: linear-gradient(90deg, rgba(62, 126, 167, 0.3) 0%, transparent 100%);
            color: #ffffff;
            border-left-color: #66c0f4;
        }

        .menu-item.active {
            background: linear-gradient(90deg, rgba(62, 126, 167, 0.5) 0%, transparent 100%);
            color: #66c0f4;
            border-left-color: #66c0f4;
        }

        .modal-content .delete-btn {
            background: linear-gradient(135deg, #be463c 0%, #8c2c24 100%) !important;
            color: white;
            border: none;
            padding: 6.7px 10.05px;
            border-radius: 2.68px;
            cursor: pointer;
            margin-left: 6.7px;
        }

        .modal-content .delete-btn:hover {
            background: linear-gradient(135deg, #d1544a 0%, #9e342a 100%) !important;
            transform: translateY(-0.67px);
        }

        /* Основной контент */
        .main-content {
            flex: 1;
            margin-left: 50px;
            padding: 13.4px;
            overflow: hidden;
            background: transparent;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            background: rgba(27, 40, 56, 0.9);
            padding: 13.4px;
            border-radius: 5.36px;
            box-shadow: 0 2.68px 8.04px rgba(0,0,0,0.4);
            overflow: hidden;
            border: 0.67px solid #3d4450;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .table-scroll-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
            min-height: 0;
        }

        .application-filter {
            min-width: 100.5px;
            width: 100%;
        }

        table thead th {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #2a475e 0%, #1f3549 100%) !important;
            border-bottom: 1.34px solid #66c0f4;
        }

        .sidebar, .main-content {
            display: block !important;
        }

        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1b2838 0%, #2a475e 100%);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 2000;
        }

        #login-page:not(.active) {
            display: none;
        }

        .page.active {
            display: block;
        }

        .clickable-row:hover {
            background-color: rgba(102, 192, 244, 0.2) !important;
            box-shadow: inset 0 0 0 1.34px #7a9eb5;
            transform: translateY(-0.67px);
        }

        .clickable-row {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .clickable-row.guest-mode {
            cursor: default !important;
        }

        /* Закрепление панели управления */
        .controls-container {
            position: sticky;
            top: 0;
            z-index: 200;
            background: rgba(27, 40, 56, 0.98);
            backdrop-filter: blur(6.7px);
            padding: 10.05px 0 6.7px 0;
            border-bottom: 0.67px solid #3d4450;
            margin: -13.4px -13.4px 10.05px -13.4px;
            padding-left: 13.4px;
            padding-right: 13.4px;
            flex-shrink: 0;
        }

        .menu-item.active {
            background: linear-gradient(90deg, rgba(62, 126, 167, 0.5) 0%, transparent 100%) !important;
            color: #66c0f4 !important;
            border-left-color: #66c0f4 !important;
        }

        .warning {
            color: #ffd700 !important;
            font-weight: bold;
        }

        .stats-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8.71px;
        }

        .stats-table th {
            background: linear-gradient(135deg, #2a475e 0%, #1f3549 100%);
            color: #66c0f4;
            padding: 5.36px;
            text-align: left;
            border: 0.67px solid #3d4450;
            font-size: 8.04px;
        }

        .stats-table td {
            padding: 5.36px;
            border: 0.67px solid #3d4450;
            color: #c7d5e0;
            font-size: 8.04px;
        }
/* ========== АВТОМАТИЧЕСКОЕ РАСПРЕДЕЛЕНИЕ ШИРИНЫ СТОЛБЦОВ ========== */

/* Автоматическое распределение для всех таблиц */
#counterpartiesTable,
#settlementTable,
#mailTable,
#proxyTable {
    table-layout: auto !important;
    width: 100% !important;
}

/* Убираем все фиксированные ширины */
#counterpartiesTable td,
#counterpartiesTable th,
#paymentsTable th,
#settlementTable td,
#settlementTable th,
#mailTable td,
#mailTable th,
#proxyTable td,
#proxyTable th {
    width: auto !important;
    min-width: 0 !important;
    max-width: none !important;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
#accountingTable {
    width: 100% !important;
    table-layout: fixed !important;
}

/* Новые ширины столбцов таблицы учета после перемещения "План" */
#accountingTable th:nth-child(1) { width: 53.6px !important; }   /* Подразделение */
#accountingTable th:nth-child(2) { width: 40.2px !important; }   /* Заявка */
#accountingTable th:nth-child(3) { width: 33.5px !important; }   /* Статус */
#accountingTable th:nth-child(4) { width: 40.2px !important; }   /* ID */
#accountingTable th:nth-child(5) { width: 120.6px !important; }  /* Наименование позиции */
#accountingTable th:nth-child(6) { width: 26.8px !important; }   /* Кол-во */
#accountingTable th:nth-child(7) { width: 26.8px !important; }   /* Ед. изм. */
#accountingTable th:nth-child(8) { width: 120.6px !important; }  /* Наименование закупки */
#accountingTable th:nth-child(9) { width: 26.8px !important; }   /* Кол-во (закуп) */
#accountingTable th:nth-child(10) { width: 26.8px !important; }  /* Ед.изм. (закуп) */
#accountingTable th:nth-child(11) { width: 46.9px !important; }  /* Сумма, НДС */
#accountingTable th:nth-child(12) { width: 80.4px !important; } /* Контрагент */
#accountingTable th:nth-child(13) { width: 67.0px !important; } /* Договор */
#accountingTable th:nth-child(14) { width: 67.0px !important; } /* Оплата */
#accountingTable th:nth-child(15) { width: 26.8px !important; }  /* Срок */
#accountingTable th:nth-child(16) { width: 33.5px !important; }  /* Поставка */
#accountingTable th:nth-child(17) { width: 33.5px !important; }  /* Утверждено (Дата) */
#accountingTable th:nth-child(18) { width: 33.5px !important; }  /* План */
#accountingTable th:nth-child(19) { width: 33.5px !important; }  /* Факт */
#accountingTable th:nth-child(20) { width: 60.3px !important; }  /* Документ */

/* Применить те же ширины к ячейкам */
#accountingTable td:nth-child(1) { width: 53.6px !important; }
#accountingTable td:nth-child(2) { width: 40.2px !important; }
#accountingTable td:nth-child(3) { width: 33.5px !important; }
#accountingTable td:nth-child(4) { width: 40.2px !important; }
#accountingTable td:nth-child(5) { width: 120.6px !important; }
#accountingTable td:nth-child(6) { width: 26.8px !important; }
#accountingTable td:nth-child(7) { width: 26.8px !important; }
#accountingTable td:nth-child(8) { width: 120.6px !important; }
#accountingTable td:nth-child(9) { width: 26.8px !important; }
#accountingTable td:nth-child(10) { width: 26.8px !important; }
#accountingTable td:nth-child(11) { width: 46.9px !important; }
#accountingTable td:nth-child(12) { width: 80.4px !important; }
#accountingTable td:nth-child(13) { width: 67.0px !important; }
#accountingTable td:nth-child(14) { width: 67.0px !important; }
#accountingTable td:nth-child(15) { width: 26.8px !important; }
#accountingTable td:nth-child(16) { width: 33.5px !important; }
#accountingTable td:nth-child(17) { width: 33.5px !important; }
#accountingTable td:nth-child(18) { width: 33.5px !important; }
#accountingTable td:nth-child(19) { width: 33.5px !important; }
#accountingTable td:nth-child(20) { width: 60.3px !important; }
/* Гарантируем, что таблицы растягиваются на всю ширину */
.table-scroll-container table {
    width: 100% !important;
    table-layout: auto !important;
}
/* ========== АВТОМАТИЧЕСКАЯ РАСПРЕДЕЛЕНИЕ ШИРИНЫ СТОЛБЦОВ ========== */

/* Убираем фиксированные ширины и делаем адаптивными */
#counterpartiesTable th,
#settlementTable th,
#mailTable th,
#proxyTable th {
    width: auto !important;
    min-width: 0 !important;
    max-width: none !important;
}

/* Для таблицы учета - более сложное распределение */
#accountingTable th {
    width: auto !important;
    min-width: 26.8px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}
#accountingTable td {
    min-width: 26.8px !important;
    max-width: 201.0px !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: normal !important;
}
/* Убедитесь, что таблицы занимают всю ширину */
.table-scroll-container table {
    width: 100% !important;
    table-layout: auto !important;
}

/* Автоматическое распределение для таблиц */
#counterpartiesTable,
#settlementTable,
#mailTable,
#proxyTable {
    table-layout: auto !important;
}

/* Для таблиц аналитики */
#weeklyDeliveriesTable table,
#weeklyPaymentsTable table,
#overdueTable table {
    width: 100%;
    border-collapse: collapse;
    font-size: 8.04px;
    table-layout: auto;
}

/* Для таблицы комментариев */
#commentsAnalyticsTable {
    table-layout: fixed !important;
    width: 100% !important;
}

/* Стили для поля с автодополнением в фильтре */
.department-filter {
    background: #2a475e url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2366c0f4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") no-repeat right 6.7px center;
    background-size: 10.72px;
    padding-right: 23.45px;
    cursor: pointer;
}

.department-filter:focus {
    border-color: #66c0f4;
    box-shadow: 0 0 0 1.34px rgba(102, 192, 244, 0.3);
    outline: none;
}
/* Стили для выпадающего списка подразделений */
#departmentsList {
    max-height: 134.0px;
    overflow-y: auto;
}
/* Улучшение внешнего вида datalist в модальном окне */
.modal-content input[list] {
    background: #2a475e url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2366c0f4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") no-repeat right 6.7px center;
    background-size: 10.72px;
    padding-right: 26.8px;
}

.modal-content input[list]:focus {
    border-color: #66c0f4;
    box-shadow: 0 0 0 1.34px rgba(102, 192, 244, 0.3);
}
/* Стиль для скрытия блока комментариев */
.comment-control.hidden {
    display: none !important;
}
/* Стили для поля фильтра по поставщикам */
.supplier-filter {
    background: #2a475e url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2366c0f4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") no-repeat right 6.7px center;
    background-size: 10.72px;
    padding-right: 23.45px;
    cursor: pointer;
}

.supplier-filter:focus {
    border-color: #66c0f4;
    box-shadow: 0 0 0 1.34px rgba(102, 192, 244, 0.3);
    outline: none;
}
/* Стили для выпадающего меню настроек */
#settingsMenu {
    transition: all 0.3s ease;
    max-height: 0;
    overflow: hidden;
}

#settingsMenu.show {
    display: flex !important;
    max-height: 201.0px;
    opacity: 1;
    flex-direction: column;
}

#settingsMenu .sidebar-cell {
    transform: translateX(-6.7px);
    opacity: 0;
    transition: all 0.3s ease;
}

#settingsMenu.show .sidebar-cell {
    transform: translateX(0);
    opacity: 1;
}

#settingsMenu.show .sidebar-cell:nth-child(1) {
    transition-delay: 0.1s;
}

#settingsMenu.show .sidebar-cell:nth-child(2) {
    transition-delay: 0.2s;
}

#settingsMenu.show .sidebar-cell:nth-child(3) {
    transition-delay: 0.3s;
}

        /* Стили для контрагентов в черном списке */
        .blacklisted-row {
            background-color: rgba(190, 70, 60, 0.2) !important;
            border-left: 2.01px solid #be463c;
        }

        .blacklisted-row:hover {
            background-color: rgba(190, 70, 60, 0.3) !important;
        }

        
        /* Стили для бейджа с количеством заявок */
        .menu-item {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .badge {
            position: absolute;
            top: 5.36px;
            right: 5.36px;
            background: linear-gradient(135deg, #be9e3c 0%, #8c2c24 100%);
            color: white;
            border-radius: 50%;
            width: 12.06px;
            height: 12.06px;
            font-size: 6.7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 1.34px 2.68px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }

        .badge.warning {
            background: linear-gradient(135deg, #ff6200 0%, #ffa500 100%);
            color: #1b2838;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
/* Стили для фильтра по годам */
.year-filter {
    background: #2a475e; /* Только цвет фона */
    padding-right: 8.04px; /* Стандартный отступ */
    cursor: pointer;
    color: #c7d5e0;
}
.year-filter:focus {
    border-color: #66c0f4;
    box-shadow: 0 0 0 1.34px rgba(102, 192, 244, 0.3);
    outline: none;
}   
/* ========== Стили СТРАНИЦА ВХОДА ========== */
#login-page {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #0c1b2d 0%, #1a2b3c 100%);
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2000;
    padding: 13.4px;
}

#login-page.active {
    display: flex;
}

#login-page:not(.active) {
    display: none;
}

.login-container {
    background: rgba(23, 30, 38, 0.95);
    border-radius: 13.4px;
    padding: 40.2px 26.8px;
    max-width: 402.0px;
    width: 100%;
    text-align: center;
    box-shadow: 0 10.05px 26.8px rgba(0, 0, 0, 0.5);
    border: 0.67px solid #3d4450;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-13.4px); }
    to { opacity: 1; transform: translateY(0); }
}

.login-title {
    color: #66c0f4;
    font-size: 24.12px;
    margin-bottom: 10.05px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1.34px;
}

.login-subtitle {
    color: #c7d5e0;
    font-size: 12.06px;
    margin-bottom: 33.5px;
    line-height: 1.5;
}

/* Большая кнопка START */
.start-button {
    width: 100%;
    height: 67.0px;
    background: linear-gradient(135deg, #1a3a5f 0%, #2a2a5f 100%);
    color: white;
    border: none;
    border-radius: 8.04px;
    font-size: 21.44px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 2.01px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 20.1px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 6.7px 20.1px rgba(26, 58, 95, 0.4);
}

.start-button:hover {
    background: linear-gradient(135deg, #2a4a7f 0%, #3a3a7f 100%);
    transform: translateY(-3.35px);
    box-shadow: 0 10.05px 26.8px rgba(26, 58, 95, 0.6);
}

.start-button:active {
    background: linear-gradient(135deg, #0c2a4f 0%, #1a1a4f 100%);
    transform: translateY(1.34px);
    box-shadow: 0 3.35px 13.4px rgba(26, 58, 95, 0.4);
}

.start-button::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.6s ease;
}

.start-button:hover::after {
    left: 100%;
}

.login-footer {
    color: #8f98a0;
    font-size: 9.38px;
    margin-top: 20.1px;
    border-top: 0.67px solid #3d4450;
    padding-top: 13.4px;
}

/* Анимация загрузки */
.login-loading {
    display: none;
    margin-top: 13.4px;
}

.login-loading.active {
    display: block;
}

.loading-spinner {
    width: 26.8px;
    height: 26.8px;
    border: 2.68px solid rgba(102, 192, 244, 0.3);
    border-radius: 50%;
    border-top-color: #66c0f4;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Адаптивность */
@media (max-width: 514.56px) {
    .login-container {
        padding: 26.8px 13.4px;
        margin: 0 10.05px;
    }
    
    .login-title {
        font-size: 18.76px;
    }
    
    .login-subtitle {
        font-size: 10.72px;
    }
    
    .start-button {
        height: 53.6px;
        font-size: 16.08px;
    }
}     
/* Стили для поля комментария */
        .comment-control {
            display: flex;
            gap: 3.35px;
            align-items: stretch;
            min-width: 201.0px;
        }

        #applicationComment {
            flex: 1;
            min-width: 134.0px;
            height: 24.12px;
            padding: 5.36px 8.04px;
            border: 0.67px solid #3d4450;
            border-radius: 2.68px;
            background: #2a475e;
            color: #ffd700 !important;
            font-weight: bold !important;
            font-size: 9.38px !important;
        }

        .comment-control button {
            min-width: 26.8px;
            height: 24.12px;
            padding: 5.36px;
            background: linear-gradient(135deg, #5c7e10 0%, #4c6b22 100%);
            border: none;
            border-radius: 2.68px;
            color: white;
            cursor: pointer;
        }

        .comment-control button:hover {
            background: linear-gradient(135deg, #6b8f12 0%, #5c7e10 100%);
        }
/* Стиль для поля комментария в режиме гостя */
#applicationComment:disabled {
    background: #2a475e !important; /* Тот же фон что и у обычного поля */
    color: #ffd700 !important; /* Жёлтый цвет */
    border-color: #3d4450 !important;
    cursor: not-allowed !important;
}

#applicationComment:read-only {
    background: #2a475e !important;
    color: #ffd700 !important; /* Жёлтый цвет */
    border-color: #3d4450 !important;
    font-weight: bold !important; /* Жирный шрифт */
}

#saveCommentBtn:disabled {
    background: #3d4450 !important;
    cursor: not-allowed !important;
    opacity: 0.5;
}
        

        #weeklyDeliveriesTable th:nth-child(1),
        #weeklyDeliveriesTable td:nth-child(1) { width: 15%; }
        #weeklyDeliveriesTable th:nth-child(2),
        #weeklyDeliveriesTable td:nth-child(2) { width: 12%; }
        #weeklyDeliveriesTable th:nth-child(3),
        #weeklyDeliveriesTable td:nth-child(3) { width: 20%; }
        #weeklyDeliveriesTable th:nth-child(4),
        #weeklyDeliveriesTable td:nth-child(4) { width: 25%; }
        #weeklyDeliveriesTable th:nth-child(5),
        #weeklyDeliveriesTable td:nth-child(5) { width: 15%; }
        #weeklyDeliveriesTable th:nth-child(6),
        #weeklyDeliveriesTable td:nth-child(6) { width: 13%; }

        #weeklyPaymentsTable table {
            width: 100%;
        }

        
        #overdueTable table {
            width: 100%;
        }

        #overdueTable th:nth-child(1),
        #overdueTable td:nth-child(1) { width: 12%; }
        #overdueTable th:nth-child(2),
        #overdueTable td:nth-child(2) { width: 20%; }
        #overdueTable th:nth-child(3),
        #overdueTable td:nth-child(3) { width: 30%; }
        #overdueTable th:nth-child(4),
        #overdueTable td:nth-child(4) { width: 15%; }
        #overdueTable th:nth-child(5),
        #overdueTable td:nth-child(5) { width: 13%; }
        #overdueTable th:nth-child(6),
        #overdueTable td:nth-child(6) { width: 10%; }

        /* Адаптивность для мобильных устройств */
        @media (max-width: 514.56px) {
            #weeklyDeliveriesTable table,
            #weeklyPaymentsTable table,
            #overdueTable table {
                font-size: 7.37px;
            }
            
            #weeklyDeliveriesTable th,
            #weeklyPaymentsTable th,
            #overdueTable th,
            #weeklyDeliveriesTable td,
            #weeklyPaymentsTable td,
            #overdueTable td {
                padding: 2.68px 4.02px;
            }
        }


        .stats-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .stats-table th {
            background: linear-gradient(135deg, #2a475e 0%, #1f3549 100%);
            color: #66c0f4;
            padding: 6.7px;
            text-align: left;
            border: 0.67px solid #3d4450;
        }

        .stats-table td {
            padding: 6.7px;
            border: 0.67px solid #3d4450;
            color: #c7d5e0;
        }

        .positive {
            color: #5c7e10;
        }

        .negative {
            color: #be463c;
        }

        .warning {
            color: #ffd700;
        }

/* ========== Стили ЗЕЛЕНЫЕ КНОПКИ ДОБАВЛЕНИЯ ========== */
#addRecordBtn,
#addCounterpartyBtn,
#addPaymentBtn,
#addSettlementBtn,
#addMailBtn,
#addProxyBtn {
    background: linear-gradient(135deg, #5c7e10 0%, #4c6b22 100%) !important;
    color: white !important;
    border: none !important;
}

#addRecordBtn:hover,
#addCounterpartyBtn:hover,
#addPaymentBtn:hover,
#addSettlementBtn:hover,
#addMailBtn:hover,
#addProxyBtn:hover {
    background: linear-gradient(135deg, #6b8f12 0%, #5c7e10 100%) !important;
    transform: translateY(-0.67px) !important;
    box-shadow: 0 2.68px 5.36px rgba(0,0,0,0.2) !important;
}
        /* Стили для модального окна информации о контрагенте */
#counterpartyInfoModal .modal-content {
    max-width: 335.0px;
    max-height: 80vh;
    overflow-y: auto;
}

#counterpartyInfoContent {
    background: rgba(42, 71, 94, 0.3);
    padding: 13.4px;
    border-radius: 5.36px;
    border: 0.67px solid #3d4450;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 5.36px 0;
    border-bottom: 0.67px solid rgba(61, 68, 80, 0.5);
    margin-bottom: 3.35px;
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    color: #8f98a0;
    font-weight: normal;
    min-width: 100.5px;
    flex-shrink: 0;
}

.info-value {
    color: #c7d5e0;
    font-weight: bold;
    text-align: right;
    flex: 1;
    word-break: break-word;
    padding-left: 6.7px;
}

.info-value.supplier-name {
    color: #66c0f4 !important;
    font-size: 10.72px;
    font-weight: bold;
}

.blacklist-warning {
    background: rgba(190, 70, 60, 0.2);
    border: 0.67px solid #be463c;
    border-radius: 4.02px;
    padding: 10.05px;
    margin-top: 13.4px;
}

.blacklist-title {
    color: #be463c;
    font-weight: bold;
    margin-bottom: 5.36px;
    display: flex;
    align-items: center;
    gap: 5.36px;
}

.blacklist-comment {
    color: #ffd700;
    font-size: 9.38px;
    line-height: 1.4;
}

        /* Стили для вертикального расположения кнопок */
        .controls-right.vertical-buttons {
            display: flex;
            flex-direction: column;
            gap: 6.7px;
            align-items: stretch;
            min-width: 134.0px;
            max-width: 134.0px;
        }

        .controls-right.vertical-buttons button {
            width: 100%;
            min-width: 120.6px;
            text-align: center;
            height: 24.12px;
            padding: 5.36px 8.04px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #7a9eb5 0%, #5a7a90 100%);
            border: none;
            border-radius: 2.68px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .controls-right.vertical-buttons button:hover {
            background: linear-gradient(135deg, #75c9ff 0%, #5a9bdb 100%);
            transform: translateY(-1.34px);
            box-shadow: 0 2.68px 5.36px rgba(0,0,0,0.2);
        }

        .controls input, 
        .controls select, 
        .controls button {
            height: 24.12px;
            box-sizing: border-box;
        }

        .controls-right.vertical-buttons .comment-control {
            display: flex;
            flex-direction: column;
            gap: 3.35px;
            width: 100%;
        }

        .comment-control input {
            flex: 1;
            min-width: 134.0px;
            height: 24.12px;
            padding: 5.36px 8.04px;
            background: #2a475e;
            border: 0.67px solid #3d4450;
            color: #c7d5e0;
            border-radius: 2.68px;
        }

        .controls-right.vertical-buttons .comment-control input {
            min-width: 100% !important;
        }

        .controls-right.vertical-buttons .comment-control button {
            min-width: 100% !important;
        }

        /* Адаптивность для мобильных */
        @media (max-width: 514.56px) {
            .comment-control {
                width: 100%;
                min-width: auto;
            }
            
            .controls-right {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Стили для выравнивания элементов управления */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 6.7px;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 13.4px;
            width: 100%;
        }

        .controls-left {
            display: flex;
            flex-direction: column;
            gap: 6.7px;
            flex: 1;
            min-width: 167.5px;
            max-width: 201.0px;
        }

        .controls-left input, 
        .controls-left select {
            width: 100% !important;
            min-width: 100% !important;
            max-width: 100% !important;
            background: #2a475e;
            border: 0.67px solid #3d4450;
            color: #c7d5e0;
            border-radius: 2.68px;
            padding: 5.36px 8.04px;
        }

        .controls-right {
            display: flex;
            gap: 6.7px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .quick-filters-container {
            flex: 2;
            min-width: 201.0px;
            max-width: calc(100% - 214.4px);
        }

        /* Адаптивность для мобильных */
        @media (max-width: 514.56px) {
            .controls {
                flex-direction: column;
            }
            
            .controls-left,
            .controls-right,
            .quick-filters-container {
                width: 100%;
                min-width: auto;
            }
            
            .controls-right {
                justify-content: center;
            }
        }

        /* Стили вторичного фильтра */
        .quick-filters-container {
            display: flex;
            align-items: center;
            gap: 6.7px;
            margin: 6.7px 0;
            padding: 8.04px;
            background: linear-gradient(135deg, rgba(42, 71, 94, 0.8) 0%, rgba(31, 53, 73, 0.8) 100%);
            border-radius: 5.36px;
            border: 0.67px solid #3d4450 !important;
            width: 100%;
            min-height: 33.5px;
        }

        .quick-filters-label {
            font-weight: bold;
            white-space: nowrap;
            color: #66c0f4;
            padding: 2.68px 0;
            min-width: 40.2px;
        }

        .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 5.36px;
            align-items: center;
            flex: 1;
            min-height: 20.1px;
            background: rgba(31, 53, 73, 0.5);
            border: 0.67px solid #3d4450;
            border-radius: 5.36px;
            padding: 8.04px;
            margin: 6.7px 0;
            width: 100%;
        }

        .quick-filters span {
            display: flex;
            align-items: center; 
            justify-content: flex-start; 
            width: 100%;
            height: 100%;
            color: #8f98a0;
            font-style: italic;
        }

        .quick-filter-btn {
            padding: 5.36px 10.72px;
            font-size: 8.71px;
            border: 1.34px solid;
            border-radius: 13.4px;
            cursor: pointer;
            background-color: rgba(27, 40, 56, 0.8);
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 24.12px;
            line-height: 1;
        }

        .quick-filter-btn:hover {
            transform: translateY(-1.34px);
            box-shadow: 0 2.68px 5.36px rgba(0,0,0,0.3);
        }

        .quick-filter-btn.active {
    background-color: rgba(102, 192, 244, 0.3) !important;
    border-color: #e0da22 !important;
    color: #e0da22 !important;
    font-weight: bold;
    border-width: 2.68px;
}

        /* Цвета для разных статусов */
        .quick-filter-btn.status-working { border-color: #ffffff; color: #ffffff; }
.quick-filter-btn.status-supply { border-color: #ffffff; color: #ffffff; }
.quick-filter-btn.status-receipt { border-color: #ffffff; color: #ffffff; }
.quick-filter-btn.status-completed { border-color: #ffffff; color: #ffffff; }
.quick-filter-btn.status-other { border-color: #ffffff; color: #ffffff; }

.quick-filter-btn:hover.status-working { background-color: #ffffff; color: #ffffff; }
.quick-filter-btn:hover.status-supply { background-color: #ffc107; color: #1b2838; }
.quick-filter-btn:hover.status-receipt { background-color: #ffffff; color: #1b2838; }
.quick-filter-btn:hover.status-completed { background-color: #40c057; color: #ffffff; }
.quick-filter-btn:hover.status-other { background-color: #868e96; color: #ffffff; }

        /* Адаптивность для мобильных */
        @media (max-width: 514.56px) {
            .quick-filters-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quick-filters-label {
                text-align: center;
                margin-bottom: 5.36px;
            }
            
            .quick-filters {
                justify-content: center;
            }
            
            .quick-filter-btn {
                padding: 4.02px 8.04px;
                font-size: 8.04px;
            }
        }

        /* Стили кнопок перемещения */
        .move-up-btn {
            background: linear-gradient(135deg, #7a9eb5 0%, #5a7a90 100%);
            margin: 0.67px;
        }

        .move-down-btn {
            background: linear-gradient(135deg, #7a9eb5 0%, #5a7a90 100%);
            margin: 0.67px;
        }

        .move-up-btn:hover {
            background: linear-gradient(135deg, #75c9ff 0%, #5a9bdb 100%);
        }

        .move-down-btn:hover {
            background: linear-gradient(135deg, #75c9ff 0%, #5a9bdb 100%);
        }
#paymentsTable a {
    color: #66c0f4;
    text-decoration: underline;
    cursor: pointer;
}
#paymentsTable a:hover {
    color: #75c9ff;
}
/* Фиксируем макет таблицы платежей */
#paymentsTable {
    table-layout: fixed !important;
    width: 100% !important;
}

/* Задаём ширину для каждого столбца (подберите значения под свои данные) */
#paymentsTable th:nth-child(1),
#paymentsTable td:nth-child(1) { width: 40px !important; } /* Дата платежа */
#paymentsTable th:nth-child(2),
#paymentsTable td:nth-child(2) { width: 100px !important; } /* Контрагент */
#paymentsTable th:nth-child(3),
#paymentsTable td:nth-child(3) { width: 60px !important; } /* Сумма */
#paymentsTable th:nth-child(4),
#paymentsTable td:nth-child(4) { width: 100px !important; } /* Договор */
#paymentsTable th:nth-child(5),
#paymentsTable td:nth-child(5) { width: 150px !important; } /* Ссылка */
#paymentsTable th:nth-child(6),
#paymentsTable td:nth-child(6) { width: 40px !important; } /* Статус */

/* Задаём фиксированную ширину для столбца "Ссылка" (5-й столбец) */
#paymentsTable th:nth-child(5),
#paymentsTable td:nth-child(5) {
    max-width: 150px !important;
    width: 150px !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
}

/* Саму ссылку внутри ячейки тоже обрезаем */
#paymentsTable td:nth-child(5) a {
    display: block !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
}
        /* Стили таблицы */
        table {
            width: 100%;
            border-collapse: collapse;
            background: #0f1c2e;
            border-radius: 5.36px;
            overflow: hidden;
            min-width: max-content;
        }

        th, td {
            border: 0.67px solid #3d4450;
            padding: 5.36px;
            text-align: left;
            font-size: 9.38px;
            max-width: 134.0px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            word-wrap: break-word;
            color: #c7d5e0;
        }

        th {
            background: linear-gradient(135deg, #2a475e 0%, #13202c 100%);
            color: #9dd7f8;
            position: sticky;
            top: 0;
            text-align: center;
            white-space: nowrap;
            position: relative;
            font-weight: bold;
            border-bottom: 1.34px solid #66c0f4;
        }

        tr:hover {
            background-color: rgba(102, 192, 244, 0.1);
        }

        /* Подсветка просроченных строк */
        tr.overdue-row {
            background-color: rgba(190, 70, 60, 0.3) !important;
        }

        /* Подсветка статусов */
        tr.status-completed {
            background-color: rgba(92, 126, 16, 0.3) !important;
        }

        tr.status-other {
            background-color: rgba(169, 169, 169, 0.3) !important;
        }

        tr.status-receipt {
            background-color: rgba(205, 92, 92, 0.3) !important;
        }

        tr.status-supply {
            background-color: rgba(255, 215, 0, 0.3) !important;
        }

        .controls {
            margin-bottom: 13.4px;
            display: flex;
            gap: 6.7px;
            flex-wrap: wrap;
            align-items: center;
        }

        input, button, select {
            padding: 5.36px 8.04px;
            border: 0.67px solid #3d4450;
            border-radius: 2.68px;
            height: 24.12px;
            background: #2a475e;
            color: #c7d5e0;
        }

        input {
            flex: 1;
            min-width: 134.0px;
        }

        button {
            background: linear-gradient(135deg, #7a9eb5 0%, #5a7a90 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 20.1px; 
            height: 20.1px;
            font-weight: bold;
        }

        button:hover {
            background: linear-gradient(135deg, #75c9ff 0%, #5a9bdb 100%);
            transform: translateY(-0.67px);
            box-shadow: 0 2.68px 5.36px rgba(0,0,0,0.2);
        }

        .action-btn {
            padding: 2.68px 4.02px;
            margin: 0.67px;
            font-size: 6.7px;
            min-width: 13.4px;
            height: 16.08px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn {
            background: linear-gradient(135deg, #5c7e10 0%, #4c6b22 100%);
        }

        .edit-btn:hover {
            background: linear-gradient(135deg, #6b8f12 0%, #5c7e10 100%);
        }

        .delete-btn {
            background: linear-gradient(135deg, #be463c 0%, #8c2c24 100%);
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #d1544a 0%, #9e342a 100%);
        }

        /* Подсветка просроченных дат */
        .overdue-date {
            color: #be463c;
            font-weight: bold;
        }

        /* Страницы */
        .page {
            display: none;
            height: 100%;
            flex: 1;
            overflow: hidden;
        }

        .page.active {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #1b2838 0%, #2a475e 100%);
            margin: 5% auto;
            padding: 13.4px;
            width: 90%;
            max-width: 536.0px;
            border-radius: 5.36px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
            border: 0.67px solid #3d4450;
            box-shadow: 0 6.7px 20.1px rgba(0,0,0,0.5);
            color: #c7d5e0;
        }

        .close {
            position: absolute;
            right: 13.4px;
            top: 10.05px;
            cursor: pointer;
            font-size: 13.4px;
            font-weight: bold;
            color: #8f98a0;
        }

        .close:hover {
            color: #66c0f4;
        }

        .datalist-input {
            width: 100%;
            padding: 5.36px 8.04px;
            border: 0.67px solid #3d4450;
            border-radius: 2.68px;
            background: #2a475e;
            color: #c7d5e0;
        }

        .status-filter {
            min-width: 100.5px;
        }

        .application-filter {
            min-width: 100.5px;
        }
/* Стили для жирных границ у столбца "План" */
#accountingTable th:nth-child(18),
#accountingTable td:nth-child(18) {
    border-left: 2px solid #8b8b8b !important;
    border-right: 2px solid #8b8b8b !important;
}
/* Жирные границы только для статусов "Поставка" и "Приход" */
#accountingTable tr.status-supply td:nth-child(18),
#accountingTable tr.status-receipt td:nth-child(18) {
    border-left: 2px solid #8b8b8b !important;
    border-right: 2px solid #8b8b8b !important;
}




        /* Стили для модального окна пароля администратора */
#adminPasswordModal .modal-content {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-13.4px); }
    to { opacity: 1; transform: translateY(0); }
}

#adminPasswordInput:focus {
    border-color: #66c0f4 !important;
    box-shadow: 0 0 0 1.34px rgba(102, 192, 244, 0.3) !important;
    outline: none !important;
}

        /* Стили для перетаскивания строк */
        .dragging {
            opacity: 0.7;
            background-color: rgba(102, 192, 244, 0.2) !important;
        }

        .drag-over {
            background-color: rgba(102, 192, 244, 0.2) !important;
        }
/* Стили для комментариев по заявкам в аналитике */

/* Дополнительные стили для лучшей читаемости */
#commentsAnalyticsTable {
    width: 100% !important;
    table-layout: fixed !important;
    border-collapse: collapse !important;
    margin-top: 6.7px !important;
}

#commentsAnalyticsTable tr:hover td {
    background-color: rgba(255, 215, 0, 0.1) !important; /* Легкая желтая подсветка при наведении */
}

/* Стиль для заголовка блока комментариев */
#applicationCommentsAnalytics h3 {
    color: #66c0f4;
    margin-bottom: 10.05px;
    font-size: 12.06px; /* Немного больше заголовок */
}
        /* Стили для изменения ширины столбцов */
        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 3.35px;
            height: 100%;
            background-color: #66c0f4;
            cursor: col-resize;
            opacity: 0.3;
            transition: opacity 0.2s;
            z-index: 10;
        }

        th:hover .resize-handle {
            opacity: 1;
        }

        .resizing {
            user-select: none;
        }

        .resizing * {
            user-select: none;
        }

        /* Стили для флажка в реестре доверенностей */
        .proxy-checkbox {
            width: 13.4px;
            height: 13.4px;
            cursor: pointer;
            accent-color: #66c0f4;
        }

        tr.proxy-completed {
            background-color: rgba(92, 126, 16, 0.3) !important;
        }

        /* Стили для печати */
        @media print {
            .controls, .sidebar, button {
                display: none !important;
            }
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            .container {
                background: rgba(27, 40, 56, 0.9);
                padding: 13.4px;
                border-radius: 5.36px;
                box-shadow: 0 2.68px 8.04px rgba(0,0,0,0.4);
                border: 0.67px solid #3d4450;
                height: 100%;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
        }

        /* Стиль для уведомления об автосохранении */
        .autosave-notification {
            position: fixed;
            bottom: 13.4px;
            right: 13.4px;
            background: linear-gradient(135deg, #5c7e10 0%, #4c6b22 100%);
            color: white;
            padding: 6.7px 10.05px;
            border-radius: 2.68px;
            font-size: 9.38px;
            z-index: 1002;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            box-shadow: 0 2.68px 5.36px rgba(0,0,0,0.3);
        }
        
        .autosave-notification.show {
            opacity: 1;
        }

        /* Стили для кнопок в сайдбаре */
        .sidebar-buttons {
            padding: 0 10.05px;
            display: flex;
            flex-direction: column;
            gap: 5.36px;
            margin-bottom: 8.04px;
            align-items: center;
        }

        /* Разделитель в сайдбаре */
        .sidebar-divider {
            height: 0.67px;
            background: linear-gradient(90deg, transparent 0%, #3d4450 50%, transparent 100%);
            margin: 5.36px 0;
            opacity: 0.5;
            width: 26.8px;
        }

        .user-buttons {
            margin-top: 13.4px; 
            margin-bottom: 13.4px;
        }

        .sidebar-btn {
            padding: 4.02px 5.36px;
            background: linear-gradient(135deg, #7a9eb5 0%, #5a7a90 100%);
            color: white;
            border: none;
            border-radius: 2.68px;
            cursor: pointer;
            text-align: center;
            font-size: 8.04px;
            transition: all 0.3s;
            width: 80%;
            min-height: 20.1px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            margin-bottom: 5.36px;
        }

        .sidebar-btn:hover {
            background: linear-gradient(135deg, #75c9ff 0%, #5a9bdb 100%);
            opacity: 1;
            transform: translateY(-0.67px);
        }

        /* Стиль кнопок сохранения */
        .refresh-btn {
            padding: 5.36px 8.04px;
            background: linear-gradient(135deg, #7a9eb5 0%, #5a7a90 100%);
            color: white;
            border: none;
            border-radius: 2.68px;
            cursor: pointer;
            font-size: 9.38px;
            height: 24.12px;
            min-width: 80.4px;
            display: none !important;
            align-items: center;
            justify-content: center;
            margin-left: 6.7px;
            opacity: 0.6;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #75c9ff 0%, #5a9bdb 100%);
            opacity: 1;
        }
/* Блюр экрана при загрузке */
.page-transition-blur {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(5.36px);
    background-color: rgba(23, 30, 38, 0.7);
    z-index: 9998;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease; /* Уменьшил с 0.3s до 0.2s */
}

.page-transition-blur.active {
    opacity: 1;
    visibility: visible;
}

/* Ускоренный спиннер */
.loading-spinner-blur {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40.2px;
    height: 40.2px;
    border: 3.35px solid rgba(102, 192, 244, 0.3);
    border-radius: 50%;
    border-top-color: #66c0f4;
    animation: spin 0.8s linear infinite; /* Уменьшил с 1s до 0.8s */
    z-index: 9999;
    display: none;
}

.loading-spinner-blur.active {
    display: block;
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}
/* Убираем подсветку строк и ячеек в модальном окне редактирования Учета */
#editAccountingModal table tr:hover {
    background-color: transparent !important;
    transform: none !important;
}

#editAccountingModal table tr:hover td {
    background-color: transparent !important;
    box-shadow: none !important;
}

#editAccountingModal table td:hover {
    background-color: transparent !important;
    box-shadow: none !important;
}

/* Убираем эффект наведения на ячейки таблицы внутри модального окна */
#editAccountingModal .modal-content table td {
    transition: none !important;
}

#editAccountingModal .modal-content table tr {
    transition: none !important;
}

/* Отключаем эффекты наведения для всех элементов таблицы в модальном окне */
#editAccountingModal table *:hover {
    background-color: transparent !important;
    transform: none !important;
    box-shadow: none !important;
}

/* Особый стиль для таблицы в модальном окне */
#editAccountingModal table {
    border-collapse: separate !important;
    border-spacing: 0 !important;
}

#editAccountingModal table td,
#editAccountingModal table th {
    background-color: transparent !important;
}
/* Тёмная тема для выпадающего списка Статус в модальном окне редактирования */
#editAccountingModal select option {
    background-color: #2a475e;  /* тёмно-синий, как у поля */
    color: #c7d5e0;
}

/* Подсветка при наведении (работает не во всех браузерах) */
#editAccountingModal select option:hover {
    background-color: #66c0f4 !important;
    color: #ffffff !important;
}

/* Выбранный пункт – тоже тёмный */
#editAccountingModal select option:checked {
    background-color: #3a6e8c !important;
    color: #ffffff;
}
        /* Стили для форм в модальных окнах */
        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 10.05px;
        }

        .modal-content form div {
            display: flex;
            flex-direction: column;
            gap: 3.35px;
        }

        .modal-content form label {
            color: #66c0f4;
            font-weight: bold;
        }

        .modal-content form input,
        .modal-content form select,
        .modal-content form textarea {
            background: #2a475e;
            border: 0.67px solid #3d4450;
            color: #c7d5e0;
            border-radius: 2.68px;
            padding: 6.7px;
        }

        .modal-content form button {
            margin-top: 6.7px;
        }
/* Отступ после таблицы статистики по статусам */
#statusStatsContent {
    margin-bottom: 16.75px !important;
}

/* Увеличенные шрифты и отступы для таблицы */
#statusStatsModal .stats-table table {
    font-size: 10.72px !important;
    margin-bottom: 16.75px !important;
}

#statusStatsModal .stats-table th {
    padding: 8.04px 6.7px !important;
    font-size: 11.39px !important;
    background: linear-gradient(135deg, #2a475e 0%, #1f3549 100%) !important;
}

#statusStatsModal .stats-table td {
    padding: 8.04px 6.7px !important;
    font-size: 10.72px !important;
    border-bottom: 0.67px solid #3d4450 !important;
}
        /* Стили для скроллбара */
        ::-webkit-scrollbar {
            width: 6.7px;
            height: 6.7px;
        }

        ::-webkit-scrollbar-track {
            background: #1b2838;
            border-radius: 3.35px;
        }

        ::-webkit-scrollbar-thumb {
            background: #3d4450;
            border-radius: 3.35px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #7a9eb5;
        }
/* ФИКСИРОВАННАЯ ШИРИНА ДЛЯ ТАБЛИЦЫ КОНТРАГЕНТОВ */
#counterpartiesTable {
    table-layout: fixed !important;
    width: 100% !important;
}

/* ФИКСИРОВАННЫЕ ШИРИНЫ СТОЛБЦОВ ДЛЯ ТАБЛИЦЫ КОНТРАГЕНТОВ */
#counterpartiesTable th:nth-child(1) { width: 100.5px !important; } /* Контрагент */
#counterpartiesTable th:nth-child(2) { width: 33.5px !important; } /* ИНН */
#counterpartiesTable th:nth-child(3) { width: 80.4px !important; } /* Телефон */
#counterpartiesTable th:nth-child(4) { width: 87.1px !important; } /* Контактное лицо */
#counterpartiesTable th:nth-child(5) { width: 73.7px !important; } /* Email */
#counterpartiesTable th:nth-child(6) { width: 67.0px !important; } /* Материал */
#counterpartiesTable th:nth-child(7) { width: 134.0px !important; } /* Адрес */

/* Применить те же ширины к ячейкам */
#counterpartiesTable td:nth-child(1) { width: 100.5px !important; }
#counterpartiesTable td:nth-child(2) { width: 33.5px !important; }
#counterpartiesTable td:nth-child(3) { width: 80.4px !important; }
#counterpartiesTable td:nth-child(4) { width: 87.1px !important; }
#counterpartiesTable td:nth-child(5) { width: 73.7px !important; }
#counterpartiesTable td:nth-child(6) { width: 67.0px !important; }
#counterpartiesTable td:nth-child(7) { width: 134.0px !important; }

/* ПЕРЕНАС СОДЕРЖИМОГО ДЛЯ ТАБЛИЦЫ КОНТРАГЕНТОВ */
#counterpartiesTable td {
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    white-space: normal !important;
    text-overflow: ellipsis !important;
    overflow: hidden !important;
    padding: 5.36px !important;
    vertical-align: top !important;
    line-height: 1.3 !important;
    min-height: 26.8px !important;
}

/* УБЕДИТЕСЬ, ЧТО ЗАГОЛОВКИ ТАКЖЕ ИМЕЮТ ПЕРЕНАС */
#counterpartiesTable th {
    white-space: normal !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    vertical-align: top !important;
    padding: 5.36px !important;
    line-height: 1.2 !important;
}
.hidden-column {
    display: none !important;
}
    
/* === SIDEBAR SIZE INCREASE (+10%) ONLY === */
.sidebar {
    width: 110%;
    font-size: 110%;
}


.comment-control {
    display: flex;
    gap: 3.35px;
    align-items: stretch;
    margin-top: 5px;
}


/* === MODERN SIDEBAR REDESIGN === */
.sidebar {
    background: linear-gradient(180deg, #0f172a 0%, #020617 100%);
    border-right: 1px solid rgba(148,163,184,0.15);
    box-shadow: 4px 0 24px rgba(0,0,0,0.4);
    font-size: 110%;
}

.sidebar button {
    background: transparent;
    border-radius: 10px;
    padding: 10px 12px;
    color: #e5e7eb;
    transition: all 0.25s ease;
}

.sidebar button:hover {
    background: rgba(99,102,241,0.15);
    color: #ffffff;
}

.sidebar button.active {
    background: linear-gradient(135deg, #6366f1, #3b82f6);
    color: #ffffff;
    box-shadow: 0 6px 18px rgba(59,130,246,0.35);
}

.sidebar-icon {
    filter: drop-shadow(0 0 4px rgba(99,102,241,0.6));
}

.sidebar-tooltip {
    background: #020617;
    color: #e5e7eb;
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 12px;
}

</style>


<!-- ================= ULTRA COMPACT ERP / SAP MODE ================= -->
<style>
html { font-size: 11px !important; }
body { zoom: 0.9; }

* { letter-spacing: 0 !important; }

.sidebar {
  width: 10px !important;
  padding: 4px 0 !important;
}
.sidebar-cell,
.sidebar-cell.menu-item {
  width: 26px !important;
  height: 26px !important;
  margin: 2px 0 !important;
}
.sidebar-icon { font-size: 11px !important; }
.sidebar-tooltip {
  font-size: 9px !important;
  padding: 3px 6px !important;
}

.main-content {
  margin-left: 50px !important;
  padding: 6px !important;
}
.container { padding: 6px !important; }

.controls,
.controls-left,
.controls-right,
.quick-filters-container {
  gap: 4px !important;
}

input, select, button {
  height: 20px !important;
  padding: 2px 6px !important;
  font-size: 10px !important;
}

table { font-size: 9px !important; }
th, td { padding: 3px 4px !important; }
th { font-size: 9px !important; }

button { min-height: 18px !important; }
.action-btn {
  font-size: 7px !important;
  height: 14px !important;
}

.modal-content { padding: 8px !important; }
.modal-content input,
.modal-content select,
.modal-content button {
  height: 20px !important;
  font-size: 10px !important;
}

.login-container {
  padding: 20px 16px !important;
}
.start-button {
  height: 44px !important;
  font-size: 14px !important;
}

.stats-table th,
.stats-table td {
  padding: 3px !important;
  font-size: 9px !important;
}

button:hover,
.sidebar-cell:hover {
  transform: none !important;
  box-shadow: none !important;
}

/* === SIDEBAR SIZE INCREASE (+10%) ONLY === */
.sidebar {
    width: 110%;
    font-size: 110%;
}



/* === MODERN SIDEBAR REDESIGN === */
.sidebar {
    background: linear-gradient(180deg, #0f172a 0%, #020617 100%);
    border-right: 1px solid rgba(148,163,184,0.15);
    box-shadow: 4px 0 24px rgba(0,0,0,0.4);
    font-size: 110%;
}

.sidebar button {
    background: transparent;
    border-radius: 10px;
    padding: 10px 12px;
    color: #e5e7eb;
    transition: all 0.25s ease;
}

.sidebar button:hover {
    background: rgba(99,102,241,0.15);
    color: #ffffff;
}

.sidebar button.active {
    background: linear-gradient(135deg, #6366f1, #3b82f6);
    color: #ffffff;
    box-shadow: 0 6px 18px rgba(59,130,246,0.35);
}

.sidebar-icon {
    filter: drop-shadow(0 0 4px rgba(99,102,241,0.6));
}

.sidebar-tooltip {
    background: #020617;
    color: #e5e7eb;
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 12px;
}

</style>


<style>
/* ===== SIDEBAR REDESIGN (VISUAL ONLY) ===== */
.sidebar {
    width: 40px;
    background: linear-gradient(180deg, #1b1d29 0%, #141621 100%);
    border-right: 1px solid #2a2d3e;
    padding-top: 20px;
    display: flex;
    flex-direction: column;
}

.sidebar .menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 18px;
    margin: 4px 12px;
    color: #aeb3d6;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.sidebar .menu-item:hover {
    background: rgba(108,92,231,0.15);
    color: #ffffff;
}

.sidebar .menu-item.active {
    background: linear-gradient(90deg, rgba(108,92,231,0.35), transparent);
    color: #ffffff;
}

.sidebar .menu-item i {
    font-size: 16px;
    opacity: 0.9;
}

/* keep cursor same as guest */
.clickable-row {
    cursor: default !important;
}
</style>


<style>
:root{
  --p-bg:#0f1115;
  --p-panel:#15181e;
  --p-panel-2:#1b1f27;
  --p-border:#2a2f3a;
  --p-text:#e5e7eb;
  --p-muted:#9ca3af;
  --p-accent:#3b82f6;
}

/* GLOBAL */
body{background:var(--p-bg)!important;color:var(--p-text)!important}
.container,.modal-content,.controls-container{background:var(--p-panel)!important;border-color:var(--p-border)!important}

/* SIDEBAR */
.sidebar{
  width:40px!important;
  background:var(--p-panel)!important;
  border-right:1px solid var(--p-border)!important;
  box-shadow:none!important;
}
.main-content{margin-left:40px!important}

.sidebar-cell.menu-item{
  width:100%!important;
  height:36px!important;
  margin:2px 0!important;
  padding:0 12px!important;
  justify-content:flex-start!important;
  gap:10px;
  border:none!important;
  border-radius:8px!important;
  color:var(--p-muted)!important;
}
.sidebar-cell.menu-item:hover{
  background:var(--p-panel-2)!important;
  color:var(--p-text)!important;
  box-shadow:none!important;
}
.sidebar-cell.menu-item.active{
  background:rgba(59,130,246,.15)!important;
  color:#fff!important;
}

/* ICONS */
.sidebar-icon{font-size:14px!important;color:inherit!important}

/* TABLES */
table{background:var(--p-panel-2)!important}
th{background:var(--p-panel)!important;color:#fff!important;border-color:var(--p-border)!important}
td{border-color:var(--p-border)!important}

/* INPUTS & BUTTONS */
input,select,button{
  background:#2a3a5e !important;
  color:var(--p-text)!important;
  border-color:var(--p-border)!important;
}
button:hover{background:#222733!important}
</style>

</head>
<body style="zoom: 100%; transform: scale(1); transform-origin: left top; width: 100%; height: 100%;">
    
    <!-- Сайдбар меню -->
<div class="sidebar" style="display: block;">
    


    <!-- Секция навигации по страницам -->
<div class="sidebar-section" style="margin-bottom: 0.0px;">
    
    <div class="sidebar-cell menu-item active" data-page="accounting" onclick="showPage('accounting')" title="Учет закупок">
        <span class="sidebar-icon">📋</span>
        <div class="sidebar-tooltip">Учет закупок</div>
        <div class="sidebar-badge" id="accountingBadge" style="display: none;">0</div>
    </div>
    <div class="sidebar-cell menu-item" data-page="counterparties" onclick="showPage('counterparties')" title="Контрагенты">
        <span class="sidebar-icon">👥</span>
        <div class="sidebar-tooltip">Контрагенты</div>
    </div>
    <div class="sidebar-cell menu-item" data-page="payments" onclick="showPage('payments')" title="Платежи">
        <span class="sidebar-icon">💰</span>
        <div class="sidebar-tooltip">Платежи</div>
    </div>
    <!-- Перемещенный элемент - теперь после Платежей -->
    <div class="sidebar-cell menu-item" data-page="proxy-registry" onclick="showPage('proxy-registry')" title="Реестр доверенностей">
        <span class="sidebar-icon">🚙</span>
        <div class="sidebar-tooltip">Реестр доверенностей</div>
    </div>
    <div class="sidebar-cell menu-item" data-page="settlement" onclick="showPage('settlement')" title="Урегулирование">
        <span class="sidebar-icon">⚖️</span>
        <div class="sidebar-tooltip">Урегулирование</div>
    </div>
    <div class="sidebar-cell menu-item" data-page="mail-registry" onclick="showPage('mail-registry')" title="Почтовый реестр">
        <span class="sidebar-icon">📦</span>
        <div class="sidebar-tooltip">Почтовый реестр</div>
    </div>
    
    <div class="sidebar-divider"></div>
</div>

    <!-- Секция управления данными -->
    <div class="sidebar-section" style="margin-bottom: 0.0px;">
     <div class="sidebar-cell menu-item" onclick="showStatusStatsModal()" title="Аналитика">
    <span class="sidebar-icon">📊</span>
    <div class="sidebar-tooltip">Аналитика</div>
</div>
    <div class="sidebar-cell menu-item" id="userBadge" onclick="toggleUserMode()" title="Нажмите для переключения в режим администратора" style="border-color: rgba(143, 152, 160, 0.3);">
        <span class="sidebar-icon">👁️</span>
        <div class="sidebar-tooltip">Гостевой режим</div>
    </div>
</div><div class="sidebar-section">
        <!-- Кнопка настроек -->
        <div class="sidebar-cell menu-item" id="settingsButton" title="Настройки" onclick="toggleSettingsMenu()">
            <span class="sidebar-icon">⚙️</span>
            <div class="sidebar-tooltip">Настройки</div>
        </div>
    </div>

    <!-- Скрытое меню настроек -->
<div id="settingsMenu" class="sidebar-section" style="display: none;">
    <div class="sidebar-cell menu-item import-btn" onclick="importJSON()" title="Импорт данных" style="display: flex;">
        <span class="sidebar-icon">📥</span>
        <div class="sidebar-tooltip">Импорт данных</div>
    </div>
    <div class="sidebar-cell menu-item admin-only export-btn" onclick="exportJSON()" title="Экспорт данных" style="display: none;">
        <span class="sidebar-icon">📤</span>
        <div class="sidebar-tooltip">Экспорт данных</div>
    </div>
    <div class="sidebar-cell menu-item admin-only" onclick="showDepartmentsModal()" title="Управление подразделениями" style="display: none;">
    <span class="sidebar-icon">📁</span>
    <div class="sidebar-tooltip">Подразделения</div>
</div>
    <!-- Кнопка удаления с классом danger -->
    <div class="sidebar-cell menu-item danger admin-only clear-btn" onclick="confirmClearAllData()" title="Очистить все данные" style="display: none;">
        <span class="sidebar-icon">✘</span>
        <div class="sidebar-tooltip">Очистить все данные</div>
    </div>
</div>
</div>

    <!-- Основной контент -->
    <div class="main-content" style="display: block; margin-left: 50px; padding: 0px; height: 100vh;">
        <!-- Страница Учет -->
<div id="accounting" class="page active">
    <div class="container" style="padding-top: 2.01px;padding-left: 3.35px;padding-right: 3.35px;border-left-width: 0.0px;border-right-width: 0.0px;border-top-width: 0.0px;border-bottom-width: 0.0px;padding-bottom: 3.35px; display: flex; flex-direction: column; height: 100%;">
        <div class="controls-container" style="padding-top: 0.0px;margin-top: 0px;margin-bottom: 6.7px;padding-bottom: 0.0px;border-bottom-width: 1px;">
            <div class="controls" style="margin-bottom: 3.35px; display: flex; flex-wrap: wrap; align-items: center; gap: 6.7px;">
                <input type="text" id="searchAccountingInput" placeholder="Поиск по всем столбцам..." oninput="filterAccountingTable()" style="min-width: 93.8px; flex: 1;">
                <select id="yearFilter" class="year-filter" onchange="filterAccountingTable()" style="min-width: 67.0px; flex: 1;" autocomplete="off">
                    <option value="">Все года</option>
                </select>
                <select id="statusFilter" class="status-filter" onchange="handleStatusChange()" style="min-width: 67.0px; flex: 1;">
                    <option value="">Все статусы</option>
                    <option value="В работе">В работе</option>
                    <option value="Поставка">Поставка</option>
                    <option value="Приход">Приход</option>
                    <option value="Выполнено">Выполнено</option>
                    <option value="Иное">Иное</option>
                </select>
                <input list="suppliersListFilter" id="supplierFilter" class="supplier-filter" placeholder="Фильтр по поставщикам..." oninput="filterAccountingTable()" style="min-width: 93.8px; flex: 1;">
                <datalist id="suppliersListFilter"></datalist>
                <input list="departmentsListFilter" id="departmentFilter" class="department-filter" placeholder="Все подразделения" oninput="filterAccountingTable()" style="min-width: 93.8px; flex: 1;">
                <datalist id="departmentsListFilter"><option value="">Все подразделения</option></datalist>
                <input list="applicationsListFilter" id="applicationFilter" class="application-filter" placeholder="Фильтр по заявкам..." oninput="filterAccountingTable()" style="min-width: 93.8px; flex: 1;">
                
                <div style="display: flex; gap: 6.7px;">
                    <button onclick="clearAccountingFilters()">Сбросить фильтры</button>
                    <button onclick="showAddAccountingForm()" id="addRecordBtn">Добавить запись</button>
                    <button onclick="exportToExcel('main')">Экспорт в Excel</button>
                    <button onclick="toggleWeeklyDeliveriesMode()" id="weeklyDeliveriesBtn" style="background: linear-gradient(135deg, rgb(255, 215, 0) 0%, rgb(255, 165, 0) 100%); color: rgb(27, 40, 56); border: 0.67px solid rgb(255, 215, 0); box-shadow: none;">Поставки на неделю (0)</button>
                    <button onclick="toggleOverdueMode()" id="overdueBtn" style="background: linear-gradient(135deg, rgba(190, 70, 60, 0.6) 0%, rgba(140, 44, 36, 0.6) 100%); color: white; border: 0.67px solid rgb(190, 70, 60); box-shadow: none;">Просроченные (0)</button>
                </div>
            </div>
            
            <!-- ДОБАВЛЕНО: Контейнер для заголовков таблицы -->
            <div class="table-headers-container" id="accountingHeaders" style="width: 100%; overflow-x: hidden; margin-top: 6.7px; display: none;">
                <!-- Заголовки таблицы будут вставлены сюда через JavaScript -->
            </div>
            
            <div id="quickApplicationFilters" class="quick-filters-container" style="display: none; flex: 3 1 0%; max-width: none; width: 100%; min-height: 46.9px;"></div>
            
            <div class="comment-control hidden" style="margin-bottom: 6.7px; margin-top: 5.36px; display: none;">
                <input type="text" id="applicationComment" placeholder="Комментарии (только просмотр)" onchange="saveApplicationComment()" style="background-color: rgb(42, 71, 94); color: rgb(255, 215, 0); font-weight: bold;" readonly="true" disabled="true">
                <button onclick="saveApplicationComment()" id="saveCommentBtn" disabled="true">💾</button>
            </div>
        </div>

        <div class="table-scroll-container" style="border-top-width: 6.7px; margin-top: 0.0px; height: auto;">
            <table id="accountingTable" style="table-layout: fixed;">
                <thead>
        <tr>
            <th style="width: 53.6px;">Подразделение</th>
            <th style="width: 40.2px;">Заявка</th>
            <th style="width: 33.5px;">Статус</th>
            <th style="width: 40.2px;">ID</th>
            <th style="width: 120.6px;">Наименование позиции</th>
            <th style="width: 26.8px;">Кол-во</th>
            <th style="width: 26.8px;">Ед. изм.</th>
            <th style="width: 120.6px;">Наименование закупки</th>
            <th style="width: 26.8px;">Кол-во (закуп)</th>
            <th style="width: 26.8px;">Ед.изм. (закуп)</th>
            <th style="width: 46.9px;">Сумма, НДС</th>
            <th style="width: 80.4px;">Контрагент</th>
            <th style="width: 67.0px;">Договор</th>
            <th style="width: 67.0px;">Оплата</th>
            <th style="width: 26.8px;">Срок</th>
            <th style="width: 33.5px;">Поставка</th>
            <th style="width: 33.5px;">Утверждено (Дата)</th>
            <th style="width: 33.5px;">План</th>
            <th style="width: 33.5px;">Факт</th>
            <th style="width: 60.3px;">Документ</th>
        </tr>
    </thead>
                <tbody id="accountingTableBody"><tr>
            <td colspan="20" style="text-align: center; color: #8f98a0; padding: 20px;">
                Нет данных о закупках. Добавьте первую запись.
            </td>
        </tr></tbody>
            </table>
        </div>
    </div>
</div>

        <!-- Страница Контрагенты -->
<div id="counterparties" class="page">
    <div class="container" style="padding-top: 3.35px;border-top-width: 0.0px;border-left-width: 0.0px;border-bottom-width: 0.0px;border-right-width: 0.0px;padding-left: 3.35px;padding-right: 3.35px;padding-bottom: 3.35px;">
        <div class="controls-container" style="margin-top: -13.4px;padding-bottom: 0px;padding-top: 0px;margin-bottom: 6.7px;">
            <div class="controls" style="margin-bottom: 0.0px;">
                <input type="text" id="searchCounterpartiesInput" placeholder="Поиск по всем столбцам..." oninput="filterCounterpartiesTable()">
                <!-- ИЗМЕНЕН ПОРЯДОК КНОПОК -->
                <button onclick="clearCounterpartiesFilters()">Сбросить фильтры</button>
                <button onclick="showAddCounterpartyForm()" id="addCounterpartyBtn">Добавить контрагента</button>
                <button onclick="toggleBlacklistFilter()" id="blacklistFilterBtn">Показать черный список</button>
                <button onclick="exportToExcel('counterparties')">Экспорт в Excel</button>
            </div>
            
            <!-- ДОБАВЛЕНО: Контейнер для заголовков таблицы контрагентов -->
            <div class="table-headers-container" id="counterpartiesHeaders" style="width: 100%; overflow-x: hidden; margin-top: 6.7px; display: none;">
                <!-- Заголовки таблицы будут вставлены сюда через JavaScript -->
            </div>
        </div>
        
        <div class="table-scroll-container" style="height: auto; margin-top: 13.4px;">
            <table id="counterpartiesTable" style="table-layout: fixed;">
                <thead>
        <tr>
            <th style="width: 100.5px;">Контрагент</th>
            <th style="width: 33.5px;">ИНН</th>
            <th style="width: 80.4px;">Телефон</th>
            <th style="width: 87.1px;">Контактное лицо</th>
            <th style="width: 73.7px;">Email</th>
            <th style="width: 67px;">Материал</th>
            <th style="width: 134px;">Адрес</th>
        </tr>
    </thead>
                <tbody id="counterpartiesTableBody"><tr>
            <td colspan="7" style="text-align: center; color: rgb(143, 152, 160); padding: 20px; width: 100.5px;">
                Нет данных о контрагентах. Добавьте первого контрагента.
            </td>
        </tr></tbody>
            </table>
        </div>
    </div>
</div>

        <!-- Страница Платежи -->
<div id="payments" class="page">
    <div class="container" style="padding-top: 3.35px;border-top-width: 0.0px;border-bottom-width: 0.0px;border-right-width: 0.0px;border-left-width: 0.0px;padding-left: 3.35px;padding-right: 3.35px;padding-bottom: 3.35px;">
        <div class="controls-container" style="margin-top: -13.4px;padding-bottom: 0px;padding-top: 0px;">
            <div class="controls" style="margin-bottom: 0.0px;">
                <input type="text" id="searchPaymentsInput" placeholder="Поиск по всем столбцам..." oninput="filterPaymentsTable()">
                <select id="paymentsStatusFilter" class="status-filter" onchange="filterPaymentsTable()">
                    <option value="">Все статусы</option>
                    <option value="План">План</option>
                    <option value="Оплачено">Оплачено</option>
                </select>
                <button onclick="showAddPaymentForm()" id="addPaymentBtn">Добавить платеж</button>
                <button onclick="clearPaymentsFilters()">Сбросить фильтры</button>
                <button onclick="exportToExcel('payments')">Экспорт в Excel</button>
            </div>
            
            <!-- ДОБАВЛЕНО: Контейнер для заголовков таблицы платежей -->
            <div class="table-headers-container" id="paymentsHeaders" style="width: 100%; overflow-x: hidden; margin-top: 6.7px; display: none;">
                <!-- Заголовки таблицы будут вставлены сюда через JavaScript -->
            </div>
        </div>
        
        <div class="table-scroll-container" style="height: auto; margin-top: 10.05px;">
            <table id="paymentsTable" style="table-layout: fixed;">
                <thead>
        <tr>
            <th style="width: 174px;">Дата платежа</th>
            <th style="width: 174px;">Контрагент</th>
            <th style="width: 174px;">Сумма</th>
            <th style="width: 174px;">Договор</th>
            <th style="width: 174px;">Ссылка</th>
            <th style="width: 174px;">Статус</th>
        </tr>
    </thead>
                <tbody id="paymentsTableBody"><tr>
            <td colspan="5" style="text-align: center; color: rgb(143, 152, 160); padding: 20px; width: 174px;">
                Нет данных о платежах. Добавьте первую запись.
            </td>
        </tr></tbody>
            </table>
        </div>
    </div>
</div>

        <!-- Страница Урегулирование -->
<div id="settlement" class="page">
    <div class="container" style="padding-top: 3.35px;border-top-width: 0.0px;border-right-width: 0.0px;border-bottom-width: 0.0px;border-left-width: 0.0px;padding-left: 3.35px;padding-right: 3.35px;padding-bottom: 3.35px;">
        <div class="controls-container" style="margin-bottom: 13.4px;padding-bottom: 0.0px;padding-top: 0px;height: 21px;">
            <div class="controls">
                <input type="text" id="searchSettlementInput" placeholder="Поиск по всем столбцам..." oninput="filterSettlementTable()">
                <select id="settlementStatusFilter" class="status-filter" onchange="filterSettlementTable()">
                    <option value="">Все статусы</option>
                    <option value="В работе">В работе</option>
                    <option value="Выполнено">Выполнено</option>
                </select>
                <button onclick="showAddSettlementForm()" id="addSettlementBtn">Добавить запись</button>
                <button onclick="clearSettlementFilters()">Сбросить фильтры</button>
                <button onclick="exportToExcel('settlement')">Экспорт в Excel</button>
            </div>
            
            <!-- ДОБАВЛЕНО: Контейнер для заголовков таблицы урегулирования -->
            <div class="table-headers-container" id="settlementHeaders" style="width: 100%; overflow-x: hidden; margin-top: 6.7px; display: none;">
                <!-- Заголовки таблицы будут вставлены сюда через JavaScript -->
            </div>
        </div>
        
        <div class="table-scroll-container" style="height: auto; margin-top: 6.7px;">
            <table id="settlementTable" style="table-layout: fixed;">
                <thead>
        <tr>
            <th style="width: 134px;">Примечание</th>
            <th style="width: 67px;">Статус</th>
            <th style="width: 120.6px;">Контрагент</th>
            <th style="width: 167.5px;">Замечание</th>
            <th style="width: 80.4px;">№ Исходящее</th>
            <th style="width: 80.4px;">№ Входящее</th>
        </tr>
    </thead>
                <tbody id="settlementTableBody"><tr>
                    <td colspan="6" style="text-align: center; color: rgb(143, 152, 160); padding: 20px; width: 134px;">
                        Нет данных об урегулировании. Добавьте первую запись.
                    </td>
                </tr></tbody>
            </table>
        </div>
    </div>
</div>

        <!-- Страница Почтовый реестр -->
<div id="mail-registry" class="page">
    <div class="container" style="padding-top: 3.35px;border-top-width: 0.0px;border-bottom-width: 0.0px;border-right-width: 0.0px;border-left-width: 0.0px;padding-left: 3.35px;padding-right: 3.35px;padding-bottom: 3.35px;">
        <div class="controls-container" style="padding-top: 0px;padding-bottom: 0.0px;margin-bottom: 20.1px;height: 21px;">
            <div class="controls">
                <input type="text" id="searchMailInput" placeholder="Поиск по всем столбцам..." oninput="filterMailTable()">
                <input type="date" id="mailDateFilter" onchange="filterMailTable()">
                <button onclick="printMailTable()">Печать</button>
                <button onclick="showAddMailForm()" id="addMailBtn">Добавить запись</button>
                <button onclick="clearMailFilters()">Сбросить фильтры</button>
                <button onclick="exportToExcel('mail')">Экспорт в Excel</button>
            </div>
            
            <!-- ДОБАВЛЕНО: Контейнер для заголовков таблицы почтового реестра -->
            <div class="table-headers-container" id="mailHeaders" style="width: 100%; overflow-x: hidden; margin-top: 6.7px; display: none;">
                <!-- Заголовки таблицы будут вставлены сюда через JavaScript -->
            </div>
        </div>
        
        <div class="table-scroll-container" style="height: auto; margin-top: 0.0px;">
            <table id="mailTable" style="table-layout: fixed;">
                <thead>
        <tr>
            <th style="width: 80.4px;">Дата</th>
            <th style="width: 120.6px;">Контрагент</th>
            <th style="width: 134px;">Документ</th>
            <th style="width: 67px;">Кол-во листов</th>
            <th style="width: 167.5px;">Адрес организации</th>
            <th style="width: 100.5px;">Отправитель</th>
        </tr>
    </thead>
                <tbody id="mailTableBody"><tr>
            <td colspan="7" style="text-align: center; color: rgb(143, 152, 160); padding: 20px; width: 80.4px;">
                Нет данных в почтовом реестре. Добавьте первую запись.
            </td>
        </tr></tbody>
            </table>
        </div>
    </div>
</div>

        <!-- Страница Реестр доверенностей -->
<div id="proxy-registry" class="page">
    <div class="container" style="padding-top: 3.35px;border-top-width: 0.0px;border-right-width: 0.0px;border-bottom-width: 0.0px;border-left-width: 0.0px;padding-left: 3.35px;padding-right: 3.35px;padding-bottom: 3.35px;">
        <div class="controls-container" style="padding-bottom: 0.0px;padding-top: 0px;height: 21px;">
            <div class="controls">
                <input type="text" id="searchProxyInput" placeholder="Поиск по всем столбцам..." oninput="filterProxyTable()">
                <!-- ДОБАВИТЬ ЭТОТ SELECT -->
                <select id="proxyStatusFilter" class="status-filter" onchange="filterProxyTable()">
                    <option value="">Все статусы</option>
                    <option value="В работе">В работе</option>
                    <option value="Выполнено">Выполнено</option>
                </select>
                <button onclick="showAddProxyForm()" id="addProxyBtn">Добавить доверенность</button>
                <button onclick="clearProxyFilters()">Сбросить фильтры</button>
                <button onclick="exportToExcel('proxy')">Экспорт в Excel</button>
            </div>
            
            <!-- ДОБАВЛЕНО: Контейнер для заголовков таблицы доверенностей -->
            <div class="table-headers-container" id="proxyHeaders" style="width: 100%; overflow-x: hidden; margin-top: 6.7px; display: none;">
                <!-- Заголовки таблицы будут вставлены сюда через JavaScript -->
            </div>
        </div>
        
        <div class="table-scroll-container" style="height: auto; margin-top: 10.05px;">
            <table id="proxyTable" style="table-layout: fixed;">
                <thead>
        <tr>
            <th style="width: 80.4px;">Дата</th>
            <th style="width: 120.6px;">Контрагент</th>
            <th style="width: 80.4px;">Телефон</th>
            <th style="width: 100px;">Документ</th>
            <th style="width: 134px;">Товар</th>
            <th style="width: 167.5px;">Адрес</th>
            <th style="width: 100.5px;">Водитель</th>
            <th style="width: 67px;">Статус</th>
        </tr>
    </thead>
                <tbody id="proxyTableBody"><tr>
            <td colspan="8" style="text-align: center; color: rgb(143, 152, 160); padding: 20px; width: 80.4px;">
                Нет данных о доверенностях. Добавьте первую доверенность.
            </td>
        </tr></tbody>
            </table>
        </div>
    </div>
</div>

    <!-- Уведомление об автосохранении -->
    <div class="autosave-notification" id="autosaveNotification">Фильтры сброшены</div>

    <!-- Модальные окна -->
    <!-- Модальное окно для добавления/редактирования контрагентов -->
    <div id="editCounterpartyModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeCounterpartyModal()">×</span>
            <h2 id="modalCounterpartyTitle" style="margin-left: 147.4px;">Редактировать контрагента</h2>
            <form id="editCounterpartyForm" onsubmit="saveCounterpartyChanges(event)">
                <input type="hidden" id="editCounterpartyIndex" value="0">
                <div style="margin-bottom: 10.05px;">
                    <label>Контрагент:</label>
                    <input type="text" id="editSupplier" required="" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>ИНН:</label>
                    <input type="text" id="editInn" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Телефон:</label>
                    <input type="text" id="editPhone" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Контактное лицо:</label>
                    <input type="text" id="editContact" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Email:</label>
                    <input type="email" id="editEmail" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Почтовый адрес:</label>
                    <input type="text" id="editAddress" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Материал:</label>
                    <input type="text" id="editMaterial" required="" style="width: 100%;">
                </div>

                <div style="margin-bottom: 10.05px; display: flex; align-items: center; gap: 6.7px;">
                    <input type="checkbox" id="editBlacklisted" style="width: 13.4px; height: 13.4px; display: block;">
                    <label for="editBlacklisted" style="color: rgb(190, 70, 60); font-weight: bold; display: block;">
                        В черном списке
                    </label>
                </div>
                <div id="blacklistCommentContainer" style="margin-bottom: 10.05px; display: none;">
                    <label for="editBlacklistComment" style="color: #be463c; font-weight: bold;">
                        Причина внесения в черный список:
                    </label>
                    <textarea id="editBlacklistComment" style="width: 100%; height: 53.6px; padding: 5.36px; margin-top: 3.35px;" placeholder="Укажите причину внесения в черный список..."></textarea>
                </div>

                <button type="submit">Сохранить</button>
                <button type="button" onclick="deleteCounterpartyRecord()" class="delete-btn" style="background: linear-gradient(135deg, rgb(190, 70, 60) 0%, rgb(140, 44, 36) 100%); display: inline-block; margin-left: 0.0px;">Удалить запись</button>
                <button type="button" onclick="closeCounterpartyModal()">Отмена</button>
            </form>
        </div>
    </div>
    <!-- Модальное окно для управления подразделениями -->
<div id="departmentsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 335.0px;">
        <span class="close" onclick="closeDepartmentsModal()">×</span>
        <h2 style="text-align: center; margin-bottom: 13.4px; color: #66c0f4;">
            Управление подразделениями
        </h2>
        
        <div style="margin-bottom: 13.4px;">
            <div style="display: flex; gap: 6.7px; margin-bottom: 10.05px;">
                <input type="text" id="newDepartmentInput" placeholder="Введите новое подразделение" style="flex: 1; padding: 5.36px; background: #2a475e; border: 0.67px solid #3d4450; color: #c7d5e0; border-radius: 2.68px;">
                <button onclick="addNewDepartment()" style="padding: 5.36px 10.05px; background: linear-gradient(135deg, #5c7e10 0%, #4c6b22 100%); color: white; border: none; border-radius: 2.68px; cursor: pointer;">
                    Добавить
                </button>
            </div>
            <div style="font-size: 8.04px; color: #8f98a0; margin-bottom: 6.7px;">
                💡 Подразделения используются для фильтрации и в форме добавления записей
            </div>
        </div>
        
        <div id="departmentsListContainer" style="max-height: 201.0px; overflow-y: auto; margin-bottom: 13.4px;">
            <!-- Список подразделений будет здесь -->
        </div>
    </div>
</div>
<!-- Модальное окно для информации о контрагенте -->
<div id="counterpartyInfoModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 335.0px;">
        <span class="close" onclick="closeCounterpartyInfoModal()">×</span>
        <h2 style="text-align: center; margin-bottom: 13.4px; color: #66c0f4;">
            Информация о контрагенте
        </h2>
        <div id="counterpartyInfoContent" style="margin-bottom: 13.4px;">
            <!-- Содержимое будет заполнено через JavaScript -->
        </div>
    </div>
</div>
    <!-- Модальное окно для добавления/редактирования платежей -->
<div id="editPaymentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closePaymentModal()">×</span>
        <h2 id="modalPaymentTitle" style="margin-left: 167.5px;">Добавить платеж</h2>
        <form id="editPaymentForm" onsubmit="savePaymentChanges(event)">
            <input type="hidden" id="editPaymentIndex" value="">
            
            <!-- ИЗМЕНЕН ПОРЯДОК: Дата, Контрагент, Сумма, Договор, Статус -->
            
            <div style="margin-bottom: 10.05px;">
                <label>Дата платежа:</label>
                <input type="date" id="editPaymentDate" required="" style="width: 100%;">
            </div>
            
            <div style="margin-bottom: 10.05px;">
                <label>Контрагент:</label>
                <input list="suppliersList" id="editPaymentSupplier" class="datalist-input" style="width: 100%;">
            </div>
            
            <div style="margin-bottom: 10.05px;">
                <label>Сумма:</label>
                <input type="number" id="editPaymentAmount" required="" step="0.01" style="width: 100%;">
            </div>
            
            <div style="margin-bottom: 10.05px;">
    <label>Договор:</label>
    <input type="text" id="editPaymentContract" style="width: 100%;" list="contractsList">
</div>
            <div style="margin-bottom: 10.05px;">
    <label>Ссылка:</label>
    <input type="url" id="editPaymentLink" style="width: 100%;" placeholder="https://...">
</div>
            <div style="margin-bottom: 10.05px;">
                <label>Статус:</label>
                <select id="editPaymentStatus" required="" style="width: 100%; padding: 5.36px;">
                    <option value="План">План</option>
                    <option value="Оплачено">Оплачено</option>
                </select>
            </div>
            
            <button type="submit">Сохранить</button>
            <button type="button" onclick="deletePaymentRecord()" class="delete-btn" style="background: linear-gradient(135deg, rgb(190, 70, 60) 0%, rgb(140, 44, 36) 100%); display: none; margin-left: 0.0px;">Удалить запись</button>
            <button type="button" onclick="closePaymentModal()">Отмена</button>
        </form>
    </div>
</div>

<!-- Модальное окно для добавления/редактирования учета -->
<div id="editAccountingModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 804.0px;">
        <span class="close" onclick="closeAccountingModal()">×</span>
        <h2 id="modalAccountingTitle" style="text-align: center; margin-bottom: 13.4px;">Добавить запись</h2>
        
        <input type="hidden" id="editAccountingRecordId" value="">
        <form id="editAccountingForm" onsubmit="saveAccountingChanges(event)">
            <input type="hidden" id="editAccountingIndex" value="">
            
            <!-- ДАТАЛИСТЫ ДЛЯ АВТОДОПОЛНЕНИЯ -->
            <datalist id="departmentsList"></datalist>
            <datalist id="suppliersList"></datalist>
            <datalist id="contractsList"></datalist>
            <datalist id="applicationsList"></datalist>
            
            <!-- Таблица 4x5 для полей ввода с НОВЫМ ПОРЯДКОМ -->
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 13.4px;">
                <!-- Строка 1: Подразделение, Заявка, Статус, ID, Документ отгрузочный -->
                <tbody><tr style="height: 46.9px;">
                    <td style="padding: 8.04px 5.36px; width: 20%; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Подразделение:</label>
                        <input list="departmentsList" id="editDepartment" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="Начните вводить..." class="datalist-input">
                    </td>
                    <td style="padding: 8.04px 5.36px; width: 20%; vertical-align: top;">
    <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Заявка:</label>
    <input list="applicationsList" id="editDocNumber" required="" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="123 (от 31.12.2024)" title="Формат: номер (от ДД.ММ.ГГГГ)" pattern=".*\s\(от\s\d{2}\.\d{2}\.\d{4}\)" class="datalist-input">
</td>
                    <td style="padding: 8.04px 5.36px; width: 20%; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Статус:</label>
                        <select id="editStatus" required="" style="width: 100%; padding: 6.7px; height: 26.8px;">
                            <option value="В работе">В работе</option>
                            <option value="Поставка">Поставка</option>
                            <option value="Приход">Приход</option>
                            <option value="Выполнено">Выполнено</option>
                            <option value="Иное">Иное</option>
                        </select>
                    </td>
                    <td style="padding: 8.04px 5.36px; width: 20%; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">ID:</label>
                        <input type="text" id="editId" required="" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="ID позиции">
                    </td>
                    <td style="padding: 8.04px 5.36px; width: 20%; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Документ отгрузочный:</label>
                        <input type="text" id="editShipmentDoc" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="Документ">
                    </td>
                </tr>
                
                <!-- Строка 2: Наименование позиции, Наименование закупки, Сумма, Контрагент, Договор -->
<tr style="height: 80.4px;">
    <td style="padding: 8.04px 5.36px; vertical-align: top;">
        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Наименование позиции:</label>
        <!-- ЗАМЕНА: input на textarea -->
        <textarea id="editName" required="" style="width: 100%; padding: 6.7px; height: 67.0px; resize: vertical; 
                   background: #2a475e; border: 0.67px solid #3d4450; 
                   color: #c7d5e0; border-radius: 2.68px; font-family: inherit; 
                   font-size: 9.38px; line-height: 1.4; white-space: pre-wrap; 
                   word-wrap: break-word; overflow-wrap: break-word;" placeholder="Наименование"></textarea>
    </td>
    <td style="padding: 8.04px 5.36px; vertical-align: top;">
        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Наименование закупки:</label>
        <!-- ЗАМЕНА: input на textarea -->
        <textarea id="editPurchaseName" style="width: 100%; padding: 6.7px; height: 67.0px; resize: vertical; 
                   background: #2a475e; border: 0.67px solid #3d4450; 
                   color: #c7d5e0; border-radius: 2.68px; font-family: inherit; 
                   font-size: 9.38px; line-height: 1.4; white-space: pre-wrap; 
                   word-wrap: break-word; overflow-wrap: break-word;" placeholder="Название закупки"></textarea>
    </td>
    <td style="padding: 8.04px 5.36px; vertical-align: top;">
        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Сумма, НДС:</label>
        <input type="number" id="editAmount" step="0.01" min="0" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="Сумма с НДС">
    </td>
    <td style="padding: 8.04px 5.36px; vertical-align: top;">
        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Контрагент:</label>
        <input list="suppliersList" id="editAccountingSupplier" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="Поставщик" class="datalist-input">
    </td>
    <td style="padding: 8.04px 5.36px; vertical-align: top;">
        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Договор:</label>
        <input type="text" id="editContract" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="Номер договора" list="contractsList" class="datalist-input">
    </td>
</tr>
                
                <!-- Строка 3: Кол-во, Кол-во (закуп), Условие поставки, Срок поставки, Условие оплаты -->
                <tr style="height: 46.9px;">
                    <td style="padding: 8.04px 5.36px; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Кол-во:</label>
                        <input type="text" id="editQuantity" required pattern="[0-9]+([,\.][0-9]*)?" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="Количество">
                    </td>
                    <td style="padding: 8.04px 5.36px; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Кол-во (закуп):</label>
                        <input type="text" id="editPurchaseQuantity" pattern="[0-9]+([,\.][0-9]*)?" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="Количество закупки">
                    </td>
                    <td style="padding: 8.04px 5.36px; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Условие поставки:</label>
                        <select id="editDeliveryTerms" style="width: 100%; padding: 6.7px; height: 26.8px;">
                            <option value="">-- Не указано --</option>
                            <option value="Включена">Включена</option>
                            <option value="Самовывоз">Самовывоз</option>
                            <option value="Терминал">Терминал</option>
                        </select>
                    </td>
                    <td style="padding: 8.04px 5.36px; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Срок поставки (дней):</label>
                        <input type="number" id="editDeliveryDays" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="Кол-во дней">
                    </td>
                    <td style="padding: 8.04px 5.36px; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Условие оплаты:</label>
                        <input type="text" id="editPaymentTerms" list="paymentTermsList" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="Условия оплаты">
                    </td>
                </tr>
                
                <!-- Строка 4: Ед.изм., Ед.изм. (закуп), Дата утверждения, План, Факт -->
                <tr style="height: 46.9px;">
                    <td style="padding: 8.04px 5.36px; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Ед. изм.:</label>
                        <input type="text" id="editUnit" required="" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="Единица измерения">
                    </td>
                    <td style="padding: 8.04px 5.36px; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Ед.изм. (закуп):</label>
                        <input type="text" id="editPurchaseUnit" style="width: 100%; padding: 6.7px; height: 26.8px;" placeholder="Ед.изм. закупки">
                    </td>
                    <td style="padding: 8.04px 5.36px; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Дата утверждения:</label>
                        <input type="date" id="editDate" style="width: 100%; padding: 6.03px; height: 26.8px;">
                    </td>
                    <td style="padding: 8.04px 5.36px; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">План:</label>
                        <input type="date" id="editPlanFact" style="width: 100%; padding: 6.03px; height: 26.8px;">
                    </td>
                    <td style="padding: 8.04px 5.36px; vertical-align: top;">
                        <label style="display: block; margin-bottom: 5.36px; color: #66c0f4; font-size: 8.71px; font-weight: bold;">Факт:</label>
                        <input type="date" id="editFact" style="width: 100%; padding: 6.03px; height: 26.8px;">
                    </td>
                </tr>
            </tbody></table>
            
            <!-- Кнопки в одну строку -->
            <div style="display: flex; gap: 6.7px; justify-content: center; margin-top: 13.4px;">
                <button type="submit" style="padding: 6.7px 13.4px; background: linear-gradient(135deg, #5c7e10 0%, #4c6b22 100%); 
                        color: white; border: none; border-radius: 2.68px; cursor: pointer;">
                    Сохранить
                </button>
                <button type="button" onclick="deleteAccountingRecord()" class="delete-btn" style="
                        padding: 6.7px 13.4px;
                        background: linear-gradient(135deg, #be463c 0%, #8c2c24 100%);
                        color: white;
                        border: none;
                        border-radius: 2.68px;
                        cursor: pointer;
                        display: none;
                        margin-left: 0.0px;
                        ">
                    Удалить запись
                </button>
                <button type="button" onclick="closeAccountingModal()" style="padding: 6.7px 13.4px; background: linear-gradient(135deg, #8f98a0 0%, #6d7882 100%); 
                        color: white; border: none; border-radius: 2.68px; cursor: pointer;">
                    Отмена
                </button>
            </div>
        </form>
    </div>
</div>

    <!-- Модальное окно для добавления/редактирования урегулирования -->
    <div id="editSettlementModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeSettlementModal()">×</span>
            <h2 id="modalSettlementTitle" style="margin-left: 120.6px;">Редактировать запись урегулирования</h2>
            <form id="editSettlementForm" onsubmit="saveSettlementChanges(event)">
                <input type="hidden" id="editSettlementIndex" value="0">
                
                <div style="margin-bottom: 10.05px;">
                    <label>Примечание:</label>
                    <input type="text" id="editSettlementNote" required="" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Статус:</label>
                    <select id="editSettlementStatus" required="" style="width: 100%; padding: 5.36px;">
                        <option value="В работе">В работе</option>
                        <option value="Выполнено">Выполнено</option>
                    </select>
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Контрагент:</label>
                    <input list="suppliersList" id="editSettlementSupplier" class="datalist-input" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Замечание:</label>
                    <textarea id="editSettlementRemark" style="width: 100%; height: 40.2px; padding: 5.36px;"></textarea>
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>№ Исходящее:</label>
                    <input type="text" id="editSettlementOutgoing" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>№ Входящее:</label>
                    <input type="text" id="editSettlementIncoming" style="width: 100%;">
                </div>
                <button type="submit">Сохранить</button>
                <button type="button" onclick="deleteSettlementRecord()" class="delete-btn" style="background: linear-gradient(135deg, rgb(190, 70, 60) 0%, rgb(140, 44, 36) 100%);display: inline-block;margin-left: 0.0px;">Удалить запись</button>
                <button type="button" onclick="closeSettlementModal()">Отмена</button>
            </form>
        </div>
    </div>

    <!-- Модальное окно для добавления/редактирования почтового реестра -->
    <div id="editMailModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeMailModal()">×</span>
            <h2 id="modalMailTitle" style="margin-left: 120.6px;">Редактировать запись в почтовый реестр</h2>
            <form id="editMailForm" onsubmit="saveMailChanges(event)">
                <input type="hidden" id="editMailIndex" value="0">
                <div style="margin-bottom: 10.05px;">
                    <label>Дата:</label>
                    <input type="date" id="editMailDate" required="" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Контрагент:</label>
                    <input list="suppliersList" id="editMailSupplier" class="datalist-input" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Документ:</label>
                    <input type="text" id="editMailDocument" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Кол-во листов:</label>
                    <input type="number" id="editMailSheets" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Адрес организации:</label>
                    <input type="text" id="editMailAddress" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Отправитель:</label>
                    <input type="text" id="editMailSender" value="Сидорченко А.А." style="width: 100%;">
                </div>
                <button type="submit">Сохранить</button>
                <button type="button" onclick="deleteMailRecord()" class="delete-btn" style="background: linear-gradient(135deg, rgb(190, 70, 60) 0%, rgb(140, 44, 36) 100%);display: inline-block;margin-left: 0.0px;">Удалить запись</button>
                <button type="button" onclick="closeMailModal()">Отмена</button>
            </form>
        </div>
    </div>

    <!-- Модальное окно для добавления/редактирования доверенностей -->
    <div id="editProxyModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeProxyModal()">×</span>
            <h2 id="modalProxyTitle" style="margin-left: 154.1px;">Редактировать доверенность</h2>
            <form id="editProxyForm" onsubmit="saveProxyChanges(event)">
                <input type="hidden" id="editProxyIndex" value="0">
                <div style="margin-bottom: 10.05px;">
                    <label>Дата:</label>
                    <input type="date" id="editProxyDate" required="" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Контрагент:</label>
                    <input list="suppliersList" id="editProxySupplier" class="datalist-input" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Телефон:</label>
                    <input type="text" id="editProxyPhone" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
    <label>Документ:</label>
    <input type="text" id="editProxyDocument" list="contractsList" style="width: 100%;">
</div>
                <div style="margin-bottom: 10.05px;">
                    <label>Товар:</label>
                    <input type="text" id="editProxyProduct" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Адрес:</label>
                    <input type="text" id="editProxyAddress" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
                    <label>Водитель:</label>
                    <input type="text" id="editProxyDriver" style="width: 100%;">
                </div>
                <div style="margin-bottom: 10.05px;">
    <label>Статус:</label>
    <select id="editProxyStatus" required="" style="width: 100%; padding: 5.36px;">
        <option value="В работе">В работе</option>
        <option value="Выполнено">Выполнено</option>
    </select>
</div>
                <button type="submit">Сохранить</button>
                <button type="button" onclick="deleteProxyRecord()" class="delete-btn" style="background: linear-gradient(135deg, rgb(190, 70, 60) 0%, rgb(140, 44, 36) 100%);display: inline-block;margin-left: 0.0px;">Удалить запись</button>
                <button type="button" onclick="closeProxyModal()">Отмена</button>
            </form>
        </div>
    </div>
    <!-- Модальное окно для ввода пароля администратора -->
<div id="adminPasswordModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 268.0px;">
        <span class="close" onclick="closeAdminPasswordModal()">×</span>
        <h2 style="text-align: center; margin-bottom: 13.4px; color: #66c0f4;">
            Вход в режим администратора
        </h2>
        <div style="margin-bottom: 13.4px; text-align: center; color: #c7d5e0;">
            Введите пароль для доступа к функциям администратора
        </div>
        <div style="margin-bottom: 13.4px;">
            <input type="password" id="adminPasswordInput" placeholder="Введите пароль" style="width: 100%; padding: 8.04px; background: #2a475e; border: 0.67px solid #3d4450; color: #c7d5e0; border-radius: 2.68px;" onkeypress="handleAdminPasswordKeyPress(event)">
        </div>
        <div id="adminPasswordError" style="color: #be463c; text-align: center; margin-bottom: 10.05px; display: none;">
            Неверный пароль. Попробуйте снова.
        </div>
        <div style="display: flex; gap: 6.7px;">
            <button onclick="checkAdminPassword()" style="flex: 1; background: linear-gradient(135deg, #5c7e10 0%, #4c6b22 100%);">
                Войти
            </button>
            <button onclick="closeAdminPasswordModal()" style="flex: 1; background: linear-gradient(135deg, #8f98a0 0%, #6d7882 100%);">
                Отмена
            </button>
        </div>
    </div>
</div>
<!-- Модальное окно статистики по статусам -->
<div id="statusStatsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 402.0px;">
        <span class="close" onclick="closeStatusStatsModal()">×</span>
        <h2 style="text-align: center; margin-bottom: 13.4px; color: #66c0f4;">Общая статистика</h2>
        
        <!-- Фильтр по годам -->
        <div style="margin-bottom: 13.4px;">
            <label style="color: #66c0f4; display: block; margin-bottom: 3.35px;">Фильтр по году:</label>
            <select id="statsYearFilter" class="year-filter" onchange="calculateStatusStats()" style="width: 100%; padding: 5.36px; background: #2a475e; color: #c7d5e0; border: 0.67px solid #3d4450; border-radius: 2.68px;">
                <option value="">Все года</option>
            </select>
        </div>
        
        <!-- Блок с общей информацией -->
        <div style="margin-bottom: 13.4px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10.05px;">
            <div style="flex: 1; min-width: 134.0px;">
                <div style="background: rgba(42, 71, 94, 0.3); padding: 10.05px; border-radius: 5.36px; text-align: center;">
                    <div style="font-size: 10.72px; color: #c7d5e0; margin-bottom: 3.35px;">
                        Всего позиций
                    </div>
                    <div id="totalRecordsCount" style="font-size: 16.08px; font-weight: bold; color: #66c0f4;">0</div>
                </div>
            </div>
            
            <div style="flex: 1; min-width: 134.0px;">
                <div style="background: rgba(42, 71, 94, 0.3); padding: 10.05px; border-radius: 5.36px; text-align: center;">
                    <div style="font-size: 10.72px; color: #c7d5e0; margin-bottom: 3.35px;">
                        Уникальных заявок
                    </div>
                    <div id="uniqueApplicationsCount" style="font-size: 16.08px; font-weight: bold; color: #5c7e10;">0</div>
                </div>
            </div>
        </div>
        
        <div style="font-size: 9.38px; color: #8f98a0; text-align: center; margin-bottom: 13.4px;">
            Актуально на: <span id="statsDate"></span>
        </div>
        
        <!-- Таблица со статистикой по статусам закупок -->
        <div id="statusStatsContent" style="margin-top: 6.7px;"></div>
        
        <!-- Статистика по доверенностям (упрощенная) -->
        <div style="margin-bottom: 16.75px;">
            <h3 style="color: #66c0f4; margin-bottom: 10.05px; font-size: 12.06px;">
                📄 Статистика по доверенностям
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(134.0px, 1fr)); gap: 6.7px; margin-bottom: 10.05px;">
                <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.1) 100%); border: 0.67px solid #ffd700; border-radius: 5.36px; padding: 8.04px; text-align: center;">
                    <div style="font-size: 12.06px; font-weight: bold; color: #ffd700;" id="proxyInWorkCount">0</div>
                    <div style="font-size: 8.04px; color: #8f98a0;">В работе</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(92, 126, 16, 0.1) 0%, rgba(76, 107, 34, 0.1) 100%); border: 0.67px solid #5c7e10; border-radius: 5.36px; padding: 8.04px; text-align: center;">
                    <div style="font-size: 12.06px; font-weight: bold; color: #5c7e10;" id="proxyCompletedCount">0</div>
                    <div style="font-size: 8.04px; color: #8f98a0;">Выполнено</div>
                </div>
            </div>
        </div>
        
        <!-- Статистика по урегулированию (упрощенная) -->
        <div style="margin-bottom: 16.75px;">
            <h3 style="color: #66c0f4; margin-bottom: 10.05px; font-size: 12.06px;">
                ⚖️ Статистика по урегулированию
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(134.0px, 1fr)); gap: 6.7px; margin-bottom: 10.05px;">
                <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.1) 100%); border: 0.67px solid #ffd700; border-radius: 5.36px; padding: 8.04px; text-align: center;">
                    <div style="font-size: 12.06px; font-weight: bold; color: #ffd700;" id="settlementInWorkCount">0</div>
                    <div style="font-size: 8.04px; color: #8f98a0;">В работе</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(92, 126, 16, 0.1) 0%, rgba(76, 107, 34, 0.1) 100%); border: 0.67px solid #5c7e10; border-radius: 5.36px; padding: 8.04px; text-align: center;">
                    <div style="font-size: 12.06px; font-weight: bold; color: #5c7e10;" id="settlementCompletedCount">0</div>
                    <div style="font-size: 8.04px; color: #8f98a0;">Выполнено</div>
                </div>
            </div>
        </div>
        
        <!-- Статистика по почтовому реестру -->
        <div style="margin-bottom: 16.75px;">
            <h3 style="color: #66c0f4; margin-bottom: 10.05px; font-size: 12.06px;">
                📦 Статистика по почтовому реестру
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(134.0px, 1fr)); gap: 6.7px; margin-bottom: 10.05px;">
                <div style="background: linear-gradient(135deg, rgba(102, 192, 244, 0.1) 0%, rgba(58, 139, 200, 0.1) 100%); border: 0.67px solid #66c0f4; border-radius: 5.36px; padding: 8.04px; text-align: center;">
                    <div style="font-size: 12.06px; font-weight: bold; color: #66c0f4;" id="totalMailCount">0</div>
                    <div style="font-size: 8.04px; color: #8f98a0;">Всего отправок</div>
                </div>
            </div>
        </div>
        
        <!-- Статистика по платежам -->
        <div style="margin-bottom: 16.75px;">
            <h3 style="color: #66c0f4; margin-bottom: 10.05px; font-size: 12.06px;">
                📊 Статистика по платежам
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(134.0px, 1fr)); gap: 6.7px; margin-bottom: 10.05px;">
                <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.1) 100%); border: 0.67px solid #ffd700; border-radius: 5.36px; padding: 8.04px; text-align: center;">
                    <div style="font-size: 12.06px; font-weight: bold; color: #ffd700;" id="plannedPaymentsCount">0</div>
                    <div style="font-size: 8.04px; color: #8f98a0;">План</div>
                    <div style="font-size: 9.38px; font-weight: bold; color: #ffd700; margin-top: 3.35px;" id="plannedPaymentsAmount">0 руб.</div>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(92, 126, 16, 0.1) 0%, rgba(76, 107, 34, 0.1) 100%); border: 0.67px solid #5c7e10; border-radius: 5.36px; padding: 8.04px; text-align: center;">
                    <div style="font-size: 12.06px; font-weight: bold; color: #5c7e10;" id="paidPaymentsCount">0</div>
                    <div style="font-size: 8.04px; color: #8f98a0;">Оплачено</div>
                    <div style="font-size: 9.38px; font-weight: bold; color: #5c7e10; margin-top: 3.35px;" id="paidPaymentsAmount">0 руб.</div>
                </div>
            </div>
        </div>
    </div>
</div>        
        <!-- Таблица со статистикой по статусам закупок -->
        <div id="statusStatsContent" style="margin-top: 6.7px;"></div>
    </div>

    <script>
        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        let isAdmin = false;
        let currentUser = null;
        let accountingData = [];
        let counterpartiesData = [];
        let paymentsData = [];
        let settlementData = [];
        let mailData = [];
        let proxyData = [];
        let applicationComments = {};
        let showOverdueMode = false;
        let showWeeklyDeliveriesMode = false;
        
        // Переменные для изменения ширины столбцов
        let resizingColumn = null;
        let startX = 0;
        let startWidth = 0;
        let currentTable = null;

        // Переменные для автосохранения
        let autosaveTimer = null;
        let autosaveInterval = 5000; // 5 секунд
        let changesMade = false;

        // Переменные для фильтрации
        let showOnlyBlacklisted = false;


        // ========== ФУНКЦИИ АВТОРИЗАЦИИ ==========
        function checkAuthOnLoad() {
    const savedAuth = localStorage.getItem('userAuth');
    
    if (savedAuth) {
        try {
            const auth = JSON.parse(savedAuth);
            
            if (auth && typeof auth.isAdmin !== 'undefined' && auth.currentUser) {
                isAdmin = auth.isAdmin;
                currentUser = auth.currentUser;
                
                if (currentUser) {
                    showMainInterface();
                    loadAllData();
                    return true;
                }
            }
        } catch (e) {
            console.error('Ошибка при загрузке данных авторизации:', e);
            localStorage.removeItem('userAuth');
        }
    }
    
    // Если нет сохраненных данных или произошла ошибка, 
    // вернуть false для использования гостевого режима по умолчанию
    return false;
}

        

        function showMainInterface() {
    // Показываем сайдбар и контент (если они скрыты)
    document.querySelector('.sidebar').style.display = 'block';
    document.querySelector('.main-content').style.display = 'block';
    
    // Обновляем интерфейс
    updateUserButton();
    updateCommentFieldPermissions();
    
    // Показываем или скрываем элементы для администратора
    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = isAdmin ? 'flex' : 'none';
    });
}

        

        function updateUserButton() {
    const userButton = document.getElementById('userBadge');
    
    if (userButton) {
        if (isAdmin) {
            userButton.textContent = '🔑';
            userButton.title = 'Режим администратора (нажмите для переключения в гостевой режим)';
            userButton.style.backgroundColor = 'rgba(92, 126, 16, 0.3)';
        } else {
            userButton.textContent = '👁️';
            userButton.title = 'Гостевой режим (нажмите для переключения в режим администратора)';
            userButton.style.backgroundColor = 'rgba(143, 152, 160, 0.3)';
        }
    }
}
function toggleUserMode() {
    // Если уже в режиме администратора, переключаем в гостевой без пароля
    if (isAdmin) {
        isAdmin = false;
        currentUser = 'guest';
        updateUserInterface();
        resetAllFilters(); 
        showAutosaveNotification('Включен гостевой режим');
        return;
    }
    
    // Если в гостевом режиме, запрашиваем пароль для перехода в административный
    showAdminPasswordModal();
}
function showAdminPasswordModal() {
    document.getElementById('adminPasswordModal').style.display = 'block';
    document.getElementById('adminPasswordInput').value = '';
    document.getElementById('adminPasswordError').style.display = 'none';
    document.getElementById('adminPasswordInput').focus();
}

function closeAdminPasswordModal() {
    document.getElementById('adminPasswordModal').style.display = 'none';
}

function checkAdminPassword() {
    const passwordInput = document.getElementById('adminPasswordInput');
    const passwordError = document.getElementById('adminPasswordError');
    
    if (passwordInput.value === '555666') {
        isAdmin = true;
        currentUser = 'admin';
        closeAdminPasswordModal();
        updateUserInterface();
        resetAllFilters();
        showAutosaveNotification('Включен режим администратора');
    } else {
        // ... ошибка
    }
}

function handleAdminPasswordKeyPress(event) {
    if (event.key === 'Enter') {
        checkAdminPassword();
    }
}

function updateUserInterface() {
    updateUserButton();
    updateCommentFieldPermissions();
    
    // Показываем или скрываем элементы для администратора
    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = isAdmin ? 'flex' : 'none';
    });
    
    // Обновляем меню настроек
    updateSettingsMenu();
    
    // Обновляем все таблицы
    updateAllTables();
    
    // СОХРАНИТЬ ТЕКУЩЕЕ СОСТОЯНИЕ В LOCALSTORAGE
    localStorage.setItem('userAuth', JSON.stringify({ 
        isAdmin, 
        currentUser 
    }));
}

// Новая функция для обновления меню настроек
function updateSettingsMenu() {
    const importBtn = document.querySelector('.import-btn');
    const adminButtons = document.querySelectorAll('.admin-only');
    
    if (isAdmin) {
        // Администратор: показываем все кнопки
        adminButtons.forEach(btn => {
            btn.style.display = 'flex';
        });
        if (importBtn) importBtn.style.display = 'flex';
    } else {
        // Гость: показываем только импорт
        adminButtons.forEach(btn => {
            btn.style.display = 'none';
        });
        if (importBtn) importBtn.style.display = 'flex';
    }
}
// Функция для обновления интерфейса после смены режима
function updateUserInterface() {
    updateUserButton();
    updateCommentFieldPermissions();
    
    // Показываем или скрываем элементы для администратора
    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = isAdmin ? 'flex' : 'none';
    });
    
    // Обновляем все таблицы
    updateAllTables();
    
    // СОХРАНИТЬ ТЕКУЩЕЕ СОСТОЯНИЕ В LOCALSTORAGE
    localStorage.setItem('userAuth', JSON.stringify({ 
        isAdmin, 
        currentUser 
    }));
}
// ========== ОБНОВЛЕНИЕ КНОПКИ ПОЛЬЗОВАТЕЛЯ ==========
function updateUserButton() {
    const userButton = document.getElementById('userBadge');
    const tooltip = userButton.querySelector('.sidebar-tooltip');
    const icon = userButton.querySelector('.sidebar-icon');
    
    if (userButton) {
        if (isAdmin) {
            icon.textContent = '🔑';
            tooltip.textContent = 'Режим администратора';
            userButton.title = 'Нажмите для переключения в гостевой режим';
            userButton.style.borderColor = 'rgba(92, 126, 16, 0.5)';
        } else {
            icon.textContent = '👁️';
            tooltip.textContent = 'Гостевой режим';
            userButton.title = 'Нажмите для переключения в режим администратора';
            userButton.style.borderColor = 'rgba(143, 152, 160, 0.3)';
        }
    }
}
// ========== ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ ==========
function initializeApp() {
    // Загружаем все данные
    loadAllData();
    
    // Показываем основной интерфейс
    document.querySelector('.sidebar').style.display = 'block';
    document.querySelector('.main-content').style.display = 'block';
    
    if (!currentUser) {
        isAdmin = false;
        currentUser = 'guest';
    }
    
    // Обновляем интерфейс
    updateUserInterface();
    resetAllFilters();
    
    // Уведомление о текущем режиме
    setTimeout(() => {
        if (isAdmin) {
            showAutosaveNotification('Режим администратора активен');
        } else {
            showAutosaveNotification('Гостевой режим активен');
        }
    }, 1000);
}

// Запускаем приложение при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Сначала проверяем сохраненную авторизацию
    const hasSavedAuth = checkAuthOnLoad();
    
    // Если нет сохраненной авторизации или она невалидна, 
    // инициализируем с гостевого режима
    if (!hasSavedAuth) {
        // Сбрасываем возможные старые данные
        isAdmin = false;
        currentUser = 'guest';
        localStorage.removeItem('userAuth');
        
        // Показываем уведомление
        setTimeout(() => {
            showAutosaveNotification('Гостевой режим активен');
        }, 500);
    }
    
    // Инициализируем приложение
    initializeApp();
    // Инициализируем ID для существующих записей
    initializeRecordIds();
    saveAllData(); // Сохраняем записи с ID
});
// ========== ФУНКЦИИ ДЛЯ УНИКАЛЬНЫХ ID ==========
function generateUniqueId() {
    // Формат: YYYYMMDDHHMMSSmmm (год, месяц, день, часы, минуты, секунды, миллисекунды)
    const now = new Date();
    
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const milliseconds = String(now.getMilliseconds()).padStart(3, '0');
    
    // Формат: YYYYMMDDHHMMSSmmm_randomStr
    const timestamp = `${year}${month}${day}${hours}${minutes}${seconds}${milliseconds}`;
    const randomStr = Math.random().toString(36).substr(2, 9);
    
    return `${timestamp}_${randomStr}`;
}

function getTimeFromRecordId(recordId) {
    if (!recordId) return 0;
    try {
        // Формат: YYYYMMDDHHMMSSmmm_randomStr
        const parts = recordId.split('_');
        if (parts.length >= 1) {
            const timeStr = parts[0];
            
            // Извлекаем компоненты даты и времени из строки
            if (timeStr.length >= 17) {
                const year = parseInt(timeStr.substring(0, 4), 10);
                const month = parseInt(timeStr.substring(4, 6), 10) - 1; // Месяцы в JS: 0-11
                const day = parseInt(timeStr.substring(6, 8), 10);
                const hours = parseInt(timeStr.substring(8, 10), 10);
                const minutes = parseInt(timeStr.substring(10, 12), 10);
                const seconds = parseInt(timeStr.substring(12, 14), 10);
                const milliseconds = parseInt(timeStr.substring(14, 17), 10);
                
                const date = new Date(year, month, day, hours, minutes, seconds, milliseconds);
                return date.getTime(); // Возвращаем timestamp в миллисекундах
            }
        }
    } catch (e) {
        console.error('Ошибка извлечения времени из recordId:', e);
    }
    return 0;
}

function initializeRecordIds() {
    // Добавляем уникальные ID ко всем существующим записям, если их нет
    const addIdsToArray = (array) => {
        array.forEach(item => {
            if (!item.recordId) {
                // Генерируем новый ID с timestamp для старых записей
                item.recordId = generateUniqueId();
            } else {
                // Проверяем формат старого recordId и конвертируем если нужно
                if (!item.recordId.includes('_') || isNaN(parseInt(item.recordId.split('_')[0]))) {
                    // Старый формат - заменяем на новый с timestamp
                    item.recordId = generateUniqueId();
                }
            }
        });
    };
    
    addIdsToArray(accountingData);
    addIdsToArray(counterpartiesData);
    addIdsToArray(paymentsData);
    addIdsToArray(settlementData);
    addIdsToArray(mailData);
    addIdsToArray(proxyData);
}
function getTimeFromRecordId(recordId) {
    if (!recordId) return 0;
    try {
        // Формат: timestamp_randomStr
        const parts = recordId.split('_');
        if (parts.length >= 1) {
            const timestamp = parseInt(parts[0], 10);
            return isNaN(timestamp) ? 0 : timestamp;
        }
    } catch (e) {
        console.error('Ошибка извлечения времени из recordId:', e);
    }
    return 0;
}
// ========== ОБНОВЛЕНИЕ ДОСТУПА К КОММЕНТАРИЯМ ==========
function updateCommentFieldPermissions() {
    const commentInput = document.getElementById('applicationComment');
    const commentButton = document.getElementById('saveCommentBtn');
    
    if (!commentInput || !commentButton) return;
    
    if (isAdmin) {
        commentInput.removeAttribute('readonly');
        commentInput.removeAttribute('disabled');
        commentButton.removeAttribute('disabled');
        commentInput.style.backgroundColor = '#2a475e';
        commentInput.style.color = '#ffd700';
        commentInput.style.fontWeight = 'bold';
        commentInput.placeholder = 'Комментарий к заявке...';
    } else {
        // Для гостя: те же цвета, но недоступно для редактирования
        commentInput.setAttribute('readonly', 'true');
        commentInput.setAttribute('disabled', 'true');
        commentButton.setAttribute('disabled', 'true');
        commentInput.style.backgroundColor = '#2a475e';
        commentInput.style.color = '#ffd700';
        commentInput.style.fontWeight = 'bold';
        commentInput.placeholder = 'Комментарии (только просмотр)';
    }
}
       

        // ========== ФУНКЦИИ ДАННЫХ ==========
        function loadAllData() {
    console.log('Начинаем загрузку данных из LocalStorage...');
    
    try {
        // Загружаем данные с проверкой
        accountingData = safeParseJSON(localStorage.getItem('accountingData')) || [];
        counterpartiesData = safeParseJSON(localStorage.getItem('counterpartiesData')) || [];
        paymentsData = safeParseJSON(localStorage.getItem('paymentsData')) || [];
        settlementData = safeParseJSON(localStorage.getItem('settlementData')) || [];
        mailData = safeParseJSON(localStorage.getItem('mailData')) || [];
        proxyData = safeParseJSON(localStorage.getItem('proxyData')) || [];
        applicationComments = safeParseJSON(localStorage.getItem('applicationComments')) || {};
        loadDepartmentsList();

        // Инициализируем уникальные ID для всех записей
        initializeRecordIds();
        
        // После загрузки данных сортируем их
        
        // Учет закупок
        if (accountingData.length > 0) {
            accountingData.sort((a, b) => {
                const timeA = a.createdAt || getTimeFromRecordId(a.recordId) || 0;
                const timeB = b.createdAt || getTimeFromRecordId(b.recordId) || 0;
                return timeB - timeA;
            });
        }
        
        // Платежи
        if (paymentsData.length > 0) {
            paymentsData.sort((a, b) => {
                const timeA = getTimeFromRecordId(a.recordId) || 0;
                const timeB = getTimeFromRecordId(b.recordId) || 0;
                return timeB - timeA;
            });
        }
        
        // Контрагенты
        if (counterpartiesData.length > 0) {
            counterpartiesData.sort((a, b) => {
                const timeA = getTimeFromRecordId(a.recordId) || 0;
                const timeB = getTimeFromRecordId(b.recordId) || 0;
                return timeB - timeA;
            });
        }
        
        // Доверенности
        if (proxyData.length > 0) {
            proxyData.sort((a, b) => {
                const timeA = getTimeFromRecordId(a.recordId) || 0;
                const timeB = getTimeFromRecordId(b.recordId) || 0;
                return timeB - timeA;
            });
        }
        
        console.log('Данные успешно загружены:', {
            accounting: accountingData.length,
            counterparties: counterpartiesData.length,
            payments: paymentsData.length,
            settlement: settlementData.length,
            mail: mailData.length,
            proxy: proxyData.length
        });

        updateAllTables();
        updateSuppliersList();
        updateApplicationsList();
        updateContractsList();
        updateQuickFilters();
        updateAccountingBadge();
        updateDepartmentsFilter();
        updateOverdueButton();
        updateWeeklyDeliveriesButton();
        updateSuppliersFilterList();
        updateYearsFilter();
        
        // Принудительно применяем фиксированные ширины после обновления таблиц
        setTimeout(() => {
            applyFixedTableLayouts();
        }, 100);
        
    } catch (error) {
        console.error('Критическая ошибка загрузки данных:', error);
        showAutosaveNotification('Ошибка загрузки данных. Проверьте консоль.');
    }
}
function safeParseJSON(jsonString) {
    if (!jsonString || jsonString === 'null' || jsonString === 'undefined') {
        return null;
    }
    
    try {
        return JSON.parse(jsonString);
    } catch (e) {
        console.error('Ошибка парсинга JSON:', e, 'Строка:', jsonString);
        return null;
    }
}
        function saveAllData() {
    console.log('Сохранение данных в LocalStorage...');
    
    try {
        localStorage.setItem('accountingData', JSON.stringify(accountingData));
        localStorage.setItem('counterpartiesData', JSON.stringify(counterpartiesData));
        localStorage.setItem('paymentsData', JSON.stringify(paymentsData));
        localStorage.setItem('settlementData', JSON.stringify(settlementData));
        localStorage.setItem('mailData', JSON.stringify(mailData));
        localStorage.setItem('proxyData', JSON.stringify(proxyData));
        localStorage.setItem('applicationComments', JSON.stringify(applicationComments));
        
        console.log('Данные успешно сохранены');
    } catch (error) {
        console.error('Ошибка сохранения данных:', error);
        showAutosaveNotification('Ошибка сохранения данных!');
    }
}
        function updateAllTables() {
    updateAccountingTable();
    updateCounterpartiesTable();
    updatePaymentsTable();
    updateSettlementTable();
    updateMailTable();
    updateProxyTable();
    updateDepartmentsFilter();
    updateOverdueButton();
    updateWeeklyDeliveriesButton();
    updateSuppliersFilterList();
    updateYearsFilter();
    
    // Принудительно применяем фиксированные ширины после обновления таблиц
    setTimeout(() => {
        applyFixedTableLayouts();
    }, 100);
}

function applyFixedTableLayouts() {
    const tables = [
        {id: 'counterpartiesTable', cols: 7},
        {id: 'settlementTable', cols: 6},
        {id: 'mailTable', cols: 7},
        {id: 'proxyTable', cols: 8}   // исправлено с 7 на 8
    ];
    
    tables.forEach(tableConfig => {
        const table = document.getElementById(tableConfig.id);
        if (table) {
            table.style.tableLayout = 'fixed';
            // Равномерно распределяем ширину
            const containerWidth = table.parentElement.offsetWidth;
            const colWidth = Math.floor(containerWidth / tableConfig.cols) - 10;
            
            const headers = table.querySelectorAll('th');
            const rows = table.querySelectorAll('tbody tr');
            
            headers.forEach((header, index) => {
                header.style.width = `${colWidth}px`;
                
                // Применяем ко всем ячейкам в столбце
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells[index]) {
                        cells[index].style.width = `${colWidth}px`;
                    }
                });
            });
        }
    });
}

        // ========== ФУНКЦИИ АВТОСОХРАНЕНИЯ ==========
        function initAutosave() {
            autosaveTimer = setInterval(() => {
                if (changesMade) {
                    saveAllData();
                    showAutosaveNotification();
                    changesMade = false;
                }
            }, autosaveInterval);
        }

        function showAutosaveNotification(message = 'Данные сохранены') {
            const notification = document.getElementById('autosaveNotification');
            if (notification) {
                notification.textContent = message;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2000);
            }
        }

        function markChangesMade() {
            changesMade = true;
        }
// Копирование текста в буфер обмена
function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            showAutosaveNotification('Ссылка скопирована в буфер обмена');
        }).catch(err => {
            console.error('Ошибка копирования: ', err);
            fallbackCopy(text);
        });
    } else {
        fallbackCopy(text);
    }
}

// Запасной метод для старых браузеров
function fallbackCopy(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    try {
        document.execCommand('copy');
        showAutosaveNotification('Ссылка скопирована в буфер обмена');
    } catch (err) {
        console.error('Ошибка копирования (fallback): ', err);
        alert('Не удалось скопировать ссылку. Скопируйте вручную.');
    }
    document.body.removeChild(textarea);
}
        // ========== ФУНКЦИИ ДЛЯ СТРАНИЦЫ УЧЕТА ==========
function updateAccountingTable() {
    const tableBody = document.querySelector('#accountingTable tbody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    if (accountingData.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
            <td colspan="20" style="text-align: center; color: #8f98a0; padding: 20px;">
                Нет данных о закупках. Добавьте первую запись.
            </td>
        `;
        tableBody.appendChild(emptyRow);
        return;
    }
    
    // СОРТИРОВКА ПО УБЫВАНИЮ: извлекаем timestamp из recordId и сортируем
    const sortedData = [...accountingData].sort((a, b) => {
        // Извлекаем timestamp из recordId
        const getTimeFromRecordId = (recordId) => {
            if (!recordId) return 0;
            try {
                // Формат: timestamp_randomStr
                const parts = recordId.split('_');
                if (parts.length >= 1) {
                    const timestamp = parseInt(parts[0], 10);
                    return isNaN(timestamp) ? 0 : timestamp;
                }
            } catch (e) {
                console.error('Ошибка извлечения времени из recordId:', e);
            }
            return 0;
        };
        
        const timeA = getTimeFromRecordId(a.recordId);
        const timeB = getTimeFromRecordId(b.recordId);
        
        // Сортировка по убыванию (новые сначала)
        return timeB - timeA;
    });
    
    sortedData.forEach((item) => {
        const row = document.createElement('tr');
        
        // Добавляем уникальный ID записи в data-атрибут
        row.dataset.recordId = item.recordId || '';
        
        const today = new Date();
        const planFactDate = parseDate(item.planFact);
        const isOverdue = planFactDate && planFactDate < today;
        
        if (isOverdue && item.status !== 'Выполнено' && item.status !== 'Приход') {
            row.classList.add('overdue-row');
        }
        
        if (item.status === 'Выполнено') row.classList.add('status-completed');
        if (item.status === 'Иное') row.classList.add('status-other');
        if (item.status === 'Приход') row.classList.add('status-receipt');
        if (item.status === 'Поставка') row.classList.add('status-supply');
        
        // Создаем ячейку для контрагента с обработчиком клика
        const supplierCell = document.createElement('td');
        supplierCell.style.width = '135px';
        supplierCell.style.cursor = 'pointer';
        supplierCell.style.color = '#66c0f4';
        supplierCell.style.textDecoration = 'underline';
        supplierCell.title = 'Кликните для просмотра информации о контрагенте';
        supplierCell.textContent = item.supplier || '';
        
        // Добавляем обработчик клика для ячейки контрагента
        supplierCell.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            showCounterpartyInfo(item.supplier || '');
        });
        
        // Создаем все ячейки строки
        const departmentCell = createCell(item.department || '', '150px');
        const docNumberCell = document.createElement('td');
docNumberCell.style.width = '109px'; // можно оставить или удалить – ширина управляется CSS

const docText = item.docNumber || '';
const openParenIndex = docText.indexOf('(');

if (openParenIndex !== -1) {
    // Часть до '(' (включая возможный пробел)
    const before = docText.substring(0, openParenIndex);
    // Часть от '(' и до конца
    const after = docText.substring(openParenIndex);
    // Экранируем спецсимволы для безопасной вставки через innerHTML
    const escape = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    docNumberCell.innerHTML = `<span style="font-weight: bold; color: #66c0f4;">${escape(before)}</span>${escape(after)}`;
} else {
    // Если скобки нет – просто текст
    docNumberCell.textContent = docText;
}
        const statusCell = createCell(item.status || '', '90px');
        
        const planFactCell = createCell(item.planFact || '', '128px');
        if (isOverdue && item.status !== 'Выполнено' && item.status !== 'Приход') {
            planFactCell.classList.add('overdue-date');
        }
        
        const idCell = createCell(item.id || '', '52px');
        const nameCell = createCell(item.name || '', '200px', 'multiline-cell');
        const quantityCell = createCell(item.quantity || '', '97px');
        const unitCell = createCell(item.unit || '', '106px');
        const purchaseNameCell = createCell(item.purchaseName || '', '200px');
        const purchaseQuantityCell = createCell(item.purchaseQuantity || '', '97px');
        const purchaseUnitCell = createCell(item.purchaseUnit || '', '100px');
        const amountCell = createCell(item.amount ? formatCurrency(item.amount) : '', '148px');
        const contractCell = createCell(item.contract || '', '114px');
        const paymentTermsCell = createCell(item.paymentTerms || '', '96px');
        const deliveryDaysCell = createCell(item.deliveryDays || '', '148px');
        const deliveryTermsCell = createCell(item.deliveryTerms || '', '81px');
        const dateCell = createCell(item.date || '', '50px');
        const planCell = createCell(item.plan || '', '50px');
        const factCell = createCell(item.fact || '', '50px');
        const shipmentDocCell = createCell(item.shipmentDoc || '', '90px');
        
        // Добавляем все ячейки в строку
        row.appendChild(departmentCell);
        row.appendChild(docNumberCell);
        row.appendChild(statusCell);
        row.appendChild(idCell); 
        row.appendChild(nameCell);
        row.appendChild(quantityCell);
        row.appendChild(unitCell);
        row.appendChild(purchaseNameCell);
        row.appendChild(purchaseQuantityCell);
        row.appendChild(purchaseUnitCell);
        row.appendChild(amountCell);
        row.appendChild(supplierCell);
        row.appendChild(contractCell);
        row.appendChild(paymentTermsCell);
        row.appendChild(deliveryDaysCell);
        row.appendChild(deliveryTermsCell);
        row.appendChild(dateCell); 
        row.appendChild(planFactCell); 
        row.appendChild(factCell); 
        row.appendChild(shipmentDocCell); 
        
        // ВСЕГДА добавляем класс для подсветки (и для гостя, и для админа)
row.classList.add('clickable-row');
if (!isAdmin) {
    row.classList.add('guest-mode');
}

// Только для администратора добавляем обработчик редактирования
if (isAdmin) {
    row.addEventListener('dblclick', function(e) {
        // Проверяем, что клик не по ячейке контрагента и не по другим интерактивным элементам
        if (e.target !== supplierCell && e.target.tagName === 'TD' && !e.target.hasAttribute('onclick')) {
            const recordId = e.currentTarget.dataset.recordId;
            
            // Ищем запись по recordId
            const recordIndex = accountingData.findIndex(record => record.recordId === recordId);
            if (recordIndex !== -1) {
                editAccountingRow(recordIndex);
            } else {
                // Если не нашли по recordId, пробуем найти по другим параметрам
                const docNumber = e.currentTarget.querySelector('td:nth-child(2)').textContent;
                const fallbackIndex = accountingData.findIndex(record => record.docNumber === docNumber);
                if (fallbackIndex !== -1) {
                    editAccountingRow(fallbackIndex);
                }
            }
        }
    });
}
        
        tableBody.appendChild(row);
    });
    
    updateApplicationsList();
    updateAccountingBadge();
    updateWeeklyDeliveriesButton();
    updateOverdueButton();
    setTimeout(forceTableUpdate, 100);
    
}
function editAccountingRowByRecordId(recordId) {
    if (!isAdmin) {
        console.log('Не администратор - редактирование запрещено');
        return;
    }
    
    console.log('Редактирование записи с recordId:', recordId);
    
    // Ищем запись по уникальному recordId
    const index = accountingData.findIndex(item => item.recordId === recordId);
    
    if (index === -1) {
        console.error('Запись не найдена с recordId:', recordId);
        return;
    }
    
    editAccountingRow(index);
}
        // Вспомогательная функция для создания ячеек
        function createCell(content, width, className = '') {
    const cell = document.createElement('td');
    cell.style.width = width;
    if (className) {
        cell.className = className;
    }
    cell.textContent = content;
    return cell;
}

    function filterAccountingTable() {
    const searchText = document.getElementById('searchAccountingInput').value.toLowerCase().trim();
    const statusFilter = document.getElementById('statusFilter').value;
    const departmentFilter = document.getElementById('departmentFilter').value;
    const applicationFilter = document.getElementById('applicationFilter').value.toLowerCase().trim();
    const supplierFilter = document.getElementById('supplierFilter').value.toLowerCase().trim();
    const yearFilter = document.getElementById('yearFilter').value;
    
    const rows = document.querySelectorAll('#accountingTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        // Проверяем, является ли строка сообщением "нет данных"
        if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
            row.style.display = 'none';
            return;
        }
        
        const cells = row.querySelectorAll('td');
        if (cells.length < 4) {
            row.style.display = 'none';
            return;
        }
        
        // Получаем значения из ячеек с нормализацией
        const statusCell = cells[2] ? cells[2].textContent.trim() : '';
        const departmentCell = cells[0] ? cells[0].textContent.trim() : '';
        const applicationCell = cells[1] ? cells[1].textContent.toLowerCase().trim() : '';
        const supplierCell = cells[11] ? 
            cells[11].textContent.toLowerCase()
                .replace(/\s+/g, ' ') // Заменяем множественные пробелы на один
                .trim() : '';
        
        const yearFromApplication = extractYearFromDocNumber(applicationCell);
        
        // Собираем весь текст строки для общего поиска
        let rowText = '';
        cells.forEach(cell => {
            rowText += cell.textContent.toLowerCase() + ' ';
        });
        rowText = rowText.replace(/\s+/g, ' ').trim();
        
        // Применяем все фильтры
        const searchMatch = !searchText || rowText.includes(searchText);
        const statusMatch = !statusFilter || statusCell === statusFilter;
        const departmentMatch = !departmentFilter || 
            departmentCell.toLowerCase().includes(departmentFilter.toLowerCase());
        const applicationMatch = !applicationFilter || applicationCell.includes(applicationFilter);
        const supplierMatch = !supplierFilter || supplierCell.includes(supplierFilter);
        const yearMatch = !yearFilter || yearFromApplication === yearFilter;
        
        // Показываем строку только если все фильтры совпадают
        if (searchMatch && statusMatch && departmentMatch && 
            applicationMatch && supplierMatch && yearMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Показываем сообщение если ничего не найдено
    const tableBody = document.querySelector('#accountingTable tbody');
    if (tableBody) {
        let noDataRow = tableBody.querySelector('tr[data-no-results]');
        
        if (visibleCount === 0 && (searchText || statusFilter || departmentFilter || 
            applicationFilter || supplierFilter || yearFilter)) {
            if (!noDataRow) {
                noDataRow = document.createElement('tr');
                noDataRow.setAttribute('data-no-results', 'true');
                noDataRow.innerHTML = `
                    <td colspan="20" style="text-align: center; color: #8f98a0; padding: 20px;">
                        По вашему запросу ничего не найдено. Проверьте фильтры.
                    </td>
                `;
                tableBody.appendChild(noDataRow);
            }
        } else {
            if (noDataRow) {
                noDataRow.remove();
            }
        }
    }
    
    updateCommentField();
    saveColumnWidths();

    // Обновляем быстрые фильтры
    updateQuickFilters();
    // Обновляем видимость блока комментариев
    updateCommentBlockVisibility();
    
    setTimeout(loadColumnWidths, 100);
}

        function clearAccountingFilters() {
    // Сбрасываем режим просроченных
    showOverdueMode = false;
    const overdueBtn = document.getElementById('overdueBtn');
    if (overdueBtn) {
        const count = countOverdueRecords();
        overdueBtn.textContent = `Просроченные (${count})`;
        overdueBtn.style.background = 'linear-gradient(135deg, rgba(190, 70, 60, 0.6) 0%, rgba(140, 44, 36, 0.6) 100%)';
        overdueBtn.style.boxShadow = 'none';
    }
    
    // Сбрасываем режим поставок на неделю
    showWeeklyDeliveriesMode = false;
    const weeklyDeliveriesBtn = document.getElementById('weeklyDeliveriesBtn');
    if (weeklyDeliveriesBtn) {
        const count = countWeeklyDeliveries();
        weeklyDeliveriesBtn.textContent = `Поставки на неделю (${count})`;
        weeklyDeliveriesBtn.style.background = 'linear-gradient(135deg, #ffd700 0%, #ffa500 100%)';
        weeklyDeliveriesBtn.style.boxShadow = 'none';
    }
    
    // Восстанавливаем видимость заголовка таблицы
    const thead = document.querySelector('#accountingTable thead');
    if (thead) {
        thead.style.display = '';
    }
    
    // Удаляем сообщение "нет данных"
    const tableBody = document.querySelector('#accountingTable tbody');
    if (tableBody) {
        const noDataRow = tableBody.querySelector('tr[data-no-results]');
        if (noDataRow) {
            noDataRow.remove();
        }
    }
    
    // Сбрасываем все фильтры
    document.getElementById('searchAccountingInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('departmentFilter').value = '';
    document.getElementById('applicationFilter').value = '';
    document.getElementById('supplierFilter').value = '';
    document.getElementById('yearFilter').value = '';
    document.getElementById('applicationComment').value = '';
    
    // Скрываем блок комментариев
    const commentBlock = document.querySelector('.comment-control');
    if (commentBlock) {
        commentBlock.classList.add('hidden');
    }
    
    // Обновляем быстрые фильтры
    updateQuickFilters();
    updateWeeklyDeliveriesButton();
    updateOverdueButton();
    
    // Очищаем активные кнопки быстрых фильтров
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Показываем все строки
    const rows = document.querySelectorAll('#accountingTable tbody tr');
    rows.forEach(row => {
        // Пропускаем строку с сообщением "нет данных"
        if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
            row.style.display = '';
            return;
        }
        row.style.display = '';
    });
    
    // Обновляем таблицу
    updateAccountingTable();
    
    // Показываем уведомление
    showAutosaveNotification('Фильтры сброшены');
}

        function showAddAccountingForm() {
    if (!isAdmin) {
        alert('Только администратор может добавлять записи');
        return;
    }
    updateApplicationsList();

    document.getElementById('modalAccountingTitle').textContent = 'Добавить запись';
    document.getElementById('editAccountingIndex').value = '';
    document.getElementById('editAccountingRecordId').value = '';
    document.getElementById('editAccountingForm').reset();
    const deleteBtn = document.querySelector('#editAccountingModal .delete-btn');
    if (deleteBtn) deleteBtn.style.display = 'none';
    document.getElementById('editAccountingModal').style.display = 'block';
    
    // Инициализируем автозаполнение для договора
    setTimeout(autoFillContract, 100);
}

function editAccountingRow(index) {
    if (!isAdmin) {
        console.log('Не администратор - редактирование запрещено');
        return;
    }
    
    console.log('Редактирование строки с индексом:', index);
    
    if (index < 0 || index >= accountingData.length) {
        console.error('Неверный индекс:', index);
        return;
    }
    
    const item = accountingData[index];
    console.log('Данные для редактирования:', item);
    
    document.getElementById('modalAccountingTitle').textContent = 'Редактировать запись';
    document.getElementById('editAccountingIndex').value = index;
    document.getElementById('editAccountingRecordId').value = item.recordId || '';
    
    // Заполняем форму данными
    document.getElementById('editDepartment').value = item.department || '';
    document.getElementById('editDocNumber').value = item.docNumber || '';
    document.getElementById('editStatus').value = item.status || 'В работе';
    document.getElementById('editPlanFact').value = formatDateForInput(item.planFact);
    document.getElementById('editId').value = item.id || '';
    document.getElementById('editQuantity').value = item.quantity || '';
    document.getElementById('editUnit').value = item.unit || '';
    document.getElementById('editPurchaseQuantity').value = item.purchaseQuantity || '';
    document.getElementById('editPurchaseUnit').value = item.purchaseUnit || '';
    document.getElementById('editAmount').value = item.amount || '';
    document.getElementById('editAccountingSupplier').value = item.supplier || '';
    document.getElementById('editContract').value = item.contract || ''; // <-- заполняем договор
    document.getElementById('editPaymentTerms').value = item.paymentTerms || '';
    document.getElementById('editDeliveryDays').value = item.deliveryDays || '';
    document.getElementById('editDeliveryTerms').value = item.deliveryTerms || '';
    document.getElementById('editDate').value = formatDateForInput(item.date);
    document.getElementById('editFact').value = formatDateForInput(item.fact);
    document.getElementById('editShipmentDoc').value = item.shipmentDoc || '';
    
    const editName = document.getElementById('editName');
const editPurchaseName = document.getElementById('editPurchaseName');

if (editName && editName.tagName === 'TEXTAREA') {
    editName.value = item.name || '';
} else {
    editName.value = item.name || '';
}

if (editPurchaseName && editPurchaseName.tagName === 'TEXTAREA') {
    editPurchaseName.value = item.purchaseName || '';
} else {
    editPurchaseName.value = item.purchaseName || '';
}
    // Показываем кнопку удаления
    const deleteBtn = document.querySelector('#editAccountingModal .delete-btn');
    if (deleteBtn) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.onclick = function() { deleteAccountingRecord(); }
    }
    
    // Показываем модальное окно
    document.getElementById('editAccountingModal').style.display = 'block';
    
    // Инициализируем автозаполнение для договора
    setTimeout(autoFillContract, 100);
    
    console.log('Модальное окно открыто');
}

        function saveAccountingChanges(event) {
    event.preventDefault();
    // Функция для преобразования запятой в точку
    const normalizeNumber = (value) => {
        if (!value) return '';
        // Заменяем запятую на точку и убираем пробелы
        return value.toString().replace(/\s/g, '').replace(',', '.');
    };

    
    const recordId = document.getElementById('editAccountingRecordId').value;
    const department = document.getElementById('editDepartment').value.trim();
    
    // Если указано новое подразделение, добавляем его в список
    if (department && !departmentsList.includes(department)) {
        departmentsList.push(department);
        departmentsList.sort();
        saveDepartmentsList();
        updateDepartmentsFilter();
        showAutosaveNotification(`Добавлено новое подразделение: ${department}`);
    }
     const docNumber = document.getElementById('editDocNumber').value.trim();
    if (!validateApplicationFormat(docNumber)) {
        alert('Неверный формат заявки!\nПравильный формат: "номер (от ДД.ММ.ГГГГ)"\nПример: "123 (от 31.12.2024)"');
        document.getElementById('editDocNumber').focus();
        return;
    }
    const quantity = normalizeNumber(document.getElementById('editQuantity').value);
    const purchaseQuantity = normalizeNumber(document.getElementById('editPurchaseQuantity').value);
    
    const item = {
        recordId: recordId || generateUniqueId(),
        docNumber: document.getElementById('editDocNumber').value,
        status: document.getElementById('editStatus').value,
        id: document.getElementById('editId').value,
        name: document.getElementById('editName').value,
        quantity: document.getElementById('editQuantity').value,
        unit: document.getElementById('editUnit').value,
        purchaseName: document.getElementById('editPurchaseName').value,
        purchaseQuantity: document.getElementById('editPurchaseQuantity').value,
        purchaseUnit: document.getElementById('editPurchaseUnit').value,
        amount: document.getElementById('editAmount').value,
        supplier: document.getElementById('editAccountingSupplier').value,
        department: department || '',
        contract: document.getElementById('editContract').value, // <-- сохраняем договор
        paymentTerms: document.getElementById('editPaymentTerms').value,
        deliveryDays: document.getElementById('editDeliveryDays').value,
        deliveryTerms: document.getElementById('editDeliveryTerms').value,
        date: formatDateForDisplay(document.getElementById('editDate').value),
        planFact: formatDateForDisplay(document.getElementById('editPlanFact').value),
        fact: formatDateForDisplay(document.getElementById('editFact').value),
        shipmentDoc: document.getElementById('editShipmentDoc').value
    };
    
    if (recordId) {
        // Ищем существующую запись
        const index = accountingData.findIndex(existingItem => existingItem.recordId === recordId);
        if (index !== -1) {
            accountingData[index] = item;
        } else {
            accountingData.push(item);
        }
    } else {
        accountingData.push(item);
    }
    
    saveAllData();
    updateAccountingTable();
    updateDepartmentsFilter();
    updateContractsList(); 
    updateQuickFilters();
    updateYearsFilter();
    filterAccountingTable();
    closeAccountingModal();
    markChangesMade();
    updateAccountingBadge();
    updateOverdueButton();
    updateSuppliersFilterList();
    refreshStatusStatsIfOpen();
}
function validateApplicationFormat(appNumber) {
    if (!appNumber) return false;
    
    // Формат: "123 (от 31.12.2024)"
    const pattern = /^.+?\s\(от\s\d{2}\.\d{2}\.\d{4}\)$/;
    return pattern.test(appNumber.trim());
}

function formatApplicationNumber(input) {
    // Автоматическое форматирование при вводе
    let value = input.value;
    
    // Удаляем все лишние пробелы
    value = value.replace(/\s+/g, ' ').trim();
    
    // Проверяем, есть ли уже "от" и дата
    if (value.includes('(от')) {
        // Уже есть формат - проверяем его корректность
        if (!validateApplicationFormat(value)) {
            input.setCustomValidity('Формат: номер (от ДД.ММ.ГГГГ)');
            return;
        }
    }
    
    input.setCustomValidity(''); // Сбрасываем сообщение об ошибке
}

function autoCompleteApplicationDate() {
    // Автодополнение даты при вводе номера
    const input = document.getElementById('editDocNumber');
    if (!input) return;
    
    input.addEventListener('blur', function() {
        let value = this.value.trim();
        
        // Если уже есть правильный формат, ничего не делаем
        if (validateApplicationFormat(value)) {
            return;
        }
        
        // Если введен только номер, добавляем текущую дату
        if (value && !value.includes('(от')) {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            
            this.value = `${value} (от ${day}.${month}.${year})`;
        }
    });
}
        function closeAccountingModal() {
    document.getElementById('editAccountingModal').style.display = 'none';
    document.getElementById('editAccountingRecordId').value = ''; // Очищаем при закрытии
}
// ========== ФУНКЦИЯ ДЛЯ ПОКАЗА ТОЛЬКО ПРОСРОЧЕННЫХ ПОСТАВОК ==========
function showOverdueOnly() {
    // Сбрасываем другие фильтры
    document.getElementById('searchAccountingInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('departmentFilter').value = '';
    document.getElementById('applicationFilter').value = '';
    
    // Очищаем быстрые фильтры
    clearQuickFilters();
    
    const rows = document.querySelectorAll('#accountingTable tbody tr');
    const thead = document.querySelector('#accountingTable thead');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    let visibleCount = 0;
    
    // Сначала скрываем все строки
    rows.forEach(row => {
        row.style.display = 'none';
    });
    
    // Скрываем заголовок по умолчанию
    if (thead) {
        thead.style.display = 'none';
    }
    
    rows.forEach(row => {
        // Пропускаем строку с сообщением "нет данных"
        if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
            row.style.display = 'none';
            return;
        }
        
        const cells = row.querySelectorAll('td');
        if (cells.length < 4) {
            row.style.display = 'none';
            return;
        }
        
        const statusCell = cells[2] ? cells[2].textContent.trim() : '';
        const planFactCell = cells[17] ? cells[17].textContent.trim() : '';
        
        // Проверяем, является ли запись просроченной
        const planFactDate = parseDate(planFactCell);
        let isOverdue = false;
        
        if (planFactDate) {
            const planFactDateOnly = new Date(planFactDate);
            planFactDateOnly.setHours(0, 0, 0, 0);
            isOverdue = planFactDateOnly < today && statusCell !== 'Выполнено' && statusCell !== 'Приход';
        }
        
        if (isOverdue) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Управляем видимостью заголовка
    if (visibleCount > 0) {
        // Если есть данные - показываем заголовок
        if (thead) {
            thead.style.display = '';
        }
    } else {
        // Если данных нет - скрываем заголовок и показываем сообщение
        if (thead) {
            thead.style.display = 'none';
        }
        
        const tableBody = document.querySelector('#accountingTable tbody');
        if (tableBody) {
            // Удаляем старое сообщение, если есть
            const oldMessage = tableBody.querySelector('tr[data-no-results]');
            if (oldMessage) {
                oldMessage.remove();
            }
            
            // Добавляем новое сообщение
            const noDataRow = document.createElement('tr');
            noDataRow.setAttribute('data-no-results', 'true');
            noDataRow.innerHTML = `
                <td colspan="20" style="text-align: center; color: #8f98a0; padding: 20px;">
                    Нет просроченных поставок
                </td>
            `;
            tableBody.appendChild(noDataRow);
        }
    }
    
    // Обновляем поле комментария
    updateCommentField();
    
    // Показываем уведомление
    showAutosaveNotification(`Показано ${visibleCount} просроченных поставок`);
}
// ========== ФУНКЦИЯ ДЛЯ ПЕРЕКЛЮЧЕНИЯ РЕЖИМА ПРОСРОЧЕННЫХ ==========
function toggleOverdueMode() {
    // Если уже активен режим "Поставки на неделю" - отключаем его
    if (showWeeklyDeliveriesMode) {
        showWeeklyDeliveriesMode = false;
        const weeklyDeliveriesBtn = document.getElementById('weeklyDeliveriesBtn');
        if (weeklyDeliveriesBtn) {
            const count = countWeeklyDeliveries();
            weeklyDeliveriesBtn.style.background = 'linear-gradient(135deg, #ffd700 0%, #ffa500 100%)';
            weeklyDeliveriesBtn.style.boxShadow = 'none';
            weeklyDeliveriesBtn.textContent = `Поставки на неделю (${count})`;
        }
    }
    
    // Переключаем режим просроченных
    showOverdueMode = !showOverdueMode;
    const overdueBtn = document.getElementById('overdueBtn');
    
    if (overdueBtn) {
        const count = countOverdueRecords();
        
        if (showOverdueMode) {
            // Включаем режим просроченных
            overdueBtn.style.background = 'linear-gradient(135deg, rgba(190, 70, 60, 0.9) 0%, rgba(140, 44, 36, 0.9) 100%)';
            overdueBtn.style.boxShadow = '0 0 10px rgba(190, 70, 60, 0.5)';
            overdueBtn.textContent = `Скрыть просроченные (${count})`;
            showOverdueOnly();
        } else {
            // Выключаем режим просроченных
            overdueBtn.style.background = 'linear-gradient(135deg, rgba(190, 70, 60, 0.6) 0%, rgba(140, 44, 36, 0.6) 100%)';
            overdueBtn.style.boxShadow = 'none';
            overdueBtn.textContent = `Просроченные (${count})`;
            clearAccountingFilters();
        }
    }
}
function restoreAccountingTable() {
    // Восстанавливаем заголовок
    const thead = document.querySelector('#accountingTable thead');
    if (thead) {
        thead.style.display = '';
    }
    
    // Удаляем сообщение "нет данных"
    const tableBody = document.querySelector('#accountingTable tbody');
    if (tableBody) {
        const noDataRow = tableBody.querySelector('tr[data-no-results]');
        if (noDataRow) {
            noDataRow.remove();
        }
    }
    
    // Показываем все строки
    const rows = document.querySelectorAll('#accountingTable tbody tr');
    rows.forEach(row => {
        // Пропускаем строку с сообщением "нет данных"
        if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
            row.style.display = '';
            return;
        }
        row.style.display = '';
    });
}
// ========== ФУНКЦИИ ДЛЯ БЕЙДЖА ПРОСРОЧЕННЫХ ==========
function countOverdueRecords() {
    if (!accountingData || accountingData.length === 0) return 0;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    let count = 0;
    
    accountingData.forEach(item => {
        const planFactDate = parseDate(item.planFact);
        if (planFactDate) {
            const planFactDateOnly = new Date(planFactDate);
            planFactDateOnly.setHours(0, 0, 0, 0);
            
            const isOverdue = planFactDateOnly < today && item.status !== 'Выполнено' && item.status !== 'Приход';
            
            if (isOverdue) {
                count++;
            }
        }
    });
    
    return count;
}

function updateOverdueButton() {
    const overdueBtn = document.getElementById('overdueBtn');
    if (!overdueBtn) return;
    
    const count = countOverdueRecords();
    
    // Обновляем текст кнопки с количеством
    if (showOverdueMode) {
        overdueBtn.textContent = `Скрыть просроченные (${count})`;
    } else {
        overdueBtn.textContent = `Просроченные (${count})`;
    }
}
function countWeeklyDeliveries() {
    if (!accountingData || accountingData.length === 0) return 0;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const nextWeek = new Date();
    nextWeek.setDate(today.getDate() + 7);
    nextWeek.setHours(23, 59, 59, 999);
    
    let count = 0;
    
    accountingData.forEach(item => {
        // Проверяем статус - только "Поставка"
        if (item.status !== 'Поставка') return;
        
        if (!item.planFact) return;
        
        const deliveryDate = parseDate(item.planFact);
        if (!deliveryDate) return;
        
        const deliveryDateOnly = new Date(deliveryDate);
        deliveryDateOnly.setHours(0, 0, 0, 0);
        
        // Проверяем, находится ли дата в пределах недели (включая сегодня)
        const isWithinWeek = deliveryDateOnly >= today && deliveryDateOnly <= nextWeek;
        
        if (isWithinWeek) {
            count++;
        }
    });
    
    return count;
}
// ========== ФУНКЦИЯ ДЛЯ ПОКАЗА ТОЛЬКО ПОСТАВОК НА НЕДЕЛЮ ==========
function showWeeklyDeliveriesOnly() {
    // Сбрасываем другие фильтры
    document.getElementById('searchAccountingInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('departmentFilter').value = '';
    document.getElementById('applicationFilter').value = '';
    
    // Очищаем быстрые фильтры
    clearQuickFilters();
    
    const rows = document.querySelectorAll('#accountingTable tbody tr');
    const thead = document.querySelector('#accountingTable thead');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const nextWeek = new Date();
    nextWeek.setDate(today.getDate() + 7);
    nextWeek.setHours(23, 59, 59, 999);
    
    let visibleCount = 0;
    
    // Сначала скрываем все строки
    rows.forEach(row => {
        row.style.display = 'none';
    });
    
    // Скрываем заголовок по умолчанию
    if (thead) {
        thead.style.display = 'none';
    }
    
    // Ищем строки поставок на неделю
    rows.forEach(row => {
        // Пропускаем строку с сообщением "нет данных"
        if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
            row.style.display = 'none';
            return;
        }
        
        const cells = row.querySelectorAll('td');
        if (cells.length < 4) {
            row.style.display = 'none';
            return;
        }
        
        const statusCell = cells[2] ? cells[2].textContent.trim() : '';
        const planFactCell = cells[17] ? cells[17].textContent.trim() : '';
        
        // Проверяем, является ли запись поставкой на неделю
        const planFactDate = parseDate(planFactCell);
        let isWeeklyDelivery = false;
        
        if (planFactDate) {
            const planFactDateOnly = new Date(planFactDate);
            planFactDateOnly.setHours(0, 0, 0, 0);
            isWeeklyDelivery = (planFactDateOnly >= today && planFactDateOnly <= nextWeek) && statusCell === 'Поставка';
        }
        
        if (isWeeklyDelivery) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Управляем видимостью заголовка
    if (visibleCount > 0) {
        // Если есть данные - показываем заголовок
        if (thead) {
            thead.style.display = '';
        }
    } else {
        // Если данных нет - скрываем заголовок и показываем сообщение
        if (thead) {
            thead.style.display = 'none';
        }
        
        const tableBody = document.querySelector('#accountingTable tbody');
        if (tableBody) {
            // Удаляем старое сообщение, если есть
            const oldMessage = tableBody.querySelector('tr[data-no-results]');
            if (oldMessage) {
                oldMessage.remove();
            }
            
            // Добавляем новое сообщение
            const noDataRow = document.createElement('tr');
            noDataRow.setAttribute('data-no-results', 'true');
            noDataRow.innerHTML = `
                <td colspan="20" style="text-align: center; color: #8f98a0; padding: 20px;">
                    Нет поставок на ближайшую неделю
                </td>
            `;
            tableBody.appendChild(noDataRow);
        }
    }
    
    // Обновляем поле комментария
    updateCommentField();
    
    // Показываем уведомление
    showAutosaveNotification(`Показано ${visibleCount} поставок на неделю`);
}
// ========== ФУНКЦИЯ ДЛЯ ПЕРЕКЛЮЧЕНИЯ РЕЖИМА ПОСТАВОК НА НЕДЕЛЮ ==========
function toggleWeeklyDeliveriesMode() {
    // Если уже активен режим "Просроченные" - отключаем его
    if (showOverdueMode) {
        showOverdueMode = false;
        const overdueBtn = document.getElementById('overdueBtn');
        if (overdueBtn) {
            const count = countOverdueRecords();
            overdueBtn.style.background = 'linear-gradient(135deg, rgba(190, 70, 60, 0.6) 0%, rgba(140, 44, 36, 0.6) 100%)';
            overdueBtn.style.boxShadow = 'none';
            overdueBtn.textContent = `Просроченные (${count})`;
        }
    }
    
    // Переключаем режим поставок на неделю
    showWeeklyDeliveriesMode = !showWeeklyDeliveriesMode;
    const weeklyDeliveriesBtn = document.getElementById('weeklyDeliveriesBtn');
    
    if (weeklyDeliveriesBtn) {
        const count = countWeeklyDeliveries();
        
        if (showWeeklyDeliveriesMode) {
            // Включаем режим поставок на неделю
            weeklyDeliveriesBtn.style.background = 'linear-gradient(135deg, #ffd700 0%, #ffa500 100%)';
            weeklyDeliveriesBtn.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.5)';
            weeklyDeliveriesBtn.textContent = `Скрыть поставки на неделю (${count})`;
            showWeeklyDeliveriesOnly();
        } else {
            // Выключаем режим поставок на неделю
            weeklyDeliveriesBtn.style.background = 'linear-gradient(135deg, #ffd700 0%, #ffa500 100%)';
            weeklyDeliveriesBtn.style.boxShadow = 'none';
            weeklyDeliveriesBtn.textContent = `Поставки на неделю (${count})`;
            // Восстанавливаем заголовок таблицы при отключении режима
            const thead = document.querySelector('#accountingTable thead');
            if (thead) {
                thead.style.display = '';
            }
            clearAccountingFilters();
        }
    }
}
function updateWeeklyDeliveriesButton() {
    const weeklyDeliveriesBtn = document.getElementById('weeklyDeliveriesBtn');
    if (!weeklyDeliveriesBtn) return;
    
    const count = countWeeklyDeliveries();
    
    // Обновляем текст кнопки с количеством
    if (showWeeklyDeliveriesMode) {
        weeklyDeliveriesBtn.textContent = `Скрыть поставки на неделю (${count})`;
    } else {
        weeklyDeliveriesBtn.textContent = `Поставки на неделю (${count})`;
    }
}
// ========== ФУНКЦИИ СТАТИСТИКИ ПО СТАТУСАМ ==========
function showStatusStatsModal() {
    // Инициализируем фильтр по годам
    initializeStatsYearFilter();
    
    // Рассчитываем статистику
    calculateStatusStats();
    
    // Показываем модальное окно
    document.getElementById('statusStatsModal').style.display = 'block';
    
    // Обновляем дату
    const now = new Date();
    const formattedDate = now.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    document.getElementById('statsDate').textContent = formattedDate;
}
function closeStatusStatsModal() {
    document.getElementById('statusStatsModal').style.display = 'none';
}

function calculateStatusStats() {
    const yearFilter = document.getElementById('statsYearFilter').value;
    
    // Фильтруем данные по году для закупок
    let filteredAccountingData = accountingData;
    if (yearFilter) {
        filteredAccountingData = accountingData.filter(item => {
            const yearFromDoc = extractYearFromDocNumber(item.docNumber);
            return yearFromDoc === yearFilter;
        });
    }
    
    const totalRecords = filteredAccountingData.length;
    document.getElementById('totalRecordsCount').textContent = totalRecords;
    
    // Считаем уникальные заявки
    const uniqueApplications = new Set();
    filteredAccountingData.forEach(item => {
        if (item.docNumber) {
            uniqueApplications.add(item.docNumber);
        }
    });
    const uniqueAppsCount = uniqueApplications.size;
    document.getElementById('uniqueApplicationsCount').textContent = uniqueAppsCount;
    
    // Группируем по статусам закупок
    const statusStats = {};
    
    filteredAccountingData.forEach(item => {
        const status = item.status || 'Не указан';
        statusStats[status] = (statusStats[status] || 0) + 1;
    });
    
    // Сортируем по количеству (по убыванию)
    const sortedStats = Object.entries(statusStats)
        .sort((a, b) => b[1] - a[1]);
    
    // Рассчитываем статистику по платежам
    let filteredPaymentsData = paymentsData;
    if (yearFilter) {
        filteredPaymentsData = paymentsData.filter(payment => {
            const paymentYear = extractYearFromPaymentDate(payment.date);
            return paymentYear === yearFilter;
        });
    }
    
    // Считаем количество и сумму по статусам платежей (только "План" и "Оплачено")
    let plannedPaymentsCount = 0;
    let plannedPaymentsAmount = 0;
    let paidPaymentsCount = 0;
    let paidPaymentsAmount = 0;
    
    filteredPaymentsData.forEach(payment => {
        const amount = parseFloat(payment.amount) || 0;
        
        if (payment.status === 'План') {
            plannedPaymentsCount++;
            plannedPaymentsAmount += amount;
        } else if (payment.status === 'Оплачено') {
            paidPaymentsCount++;
            paidPaymentsAmount += amount;
        }
    });
    // Статистика по доверенностям
let filteredProxyData = proxyData;
if (yearFilter) {
    filteredProxyData = proxyData.filter(proxy => {
        const proxyYear = extractYearFromDateString(proxy.date);
        return proxyYear === yearFilter;
    });
}

const totalProxyCount = filteredProxyData.length;
const proxyInWorkCount = filteredProxyData.filter(proxy => proxy.status === 'В работе').length;
const proxyCompletedCount = filteredProxyData.filter(proxy => proxy.status === 'Выполнено').length;

document.getElementById('proxyInWorkCount').textContent = proxyInWorkCount;
document.getElementById('proxyCompletedCount').textContent = proxyCompletedCount;

// Статистика по урегулированию (без фильтра по году, так как нет явной даты)
const totalSettlementCount = settlementData.length;
const settlementInWorkCount = settlementData.filter(item => item.status === 'В работе').length;
const settlementCompletedCount = settlementData.filter(item => item.status === 'Выполнено').length;
const settlementOtherCount = settlementData.filter(item => item.status === 'Иное').length;

document.getElementById('settlementInWorkCount').textContent = settlementInWorkCount;
document.getElementById('settlementCompletedCount').textContent = settlementCompletedCount;

// Статистика по почтовому реестру
let filteredMailData = mailData;
if (yearFilter) {
    filteredMailData = mailData.filter(mail => {
        const mailYear = extractYearFromDateString(mail.date);
        return mailYear === yearFilter;
    });
}

const totalMailCount = filteredMailData.length;
document.getElementById('totalMailCount').textContent = totalMailCount;

    // Обновляем статистику платежей (только "План" и "Оплачено")
    document.getElementById('plannedPaymentsCount').textContent = plannedPaymentsCount;
    document.getElementById('plannedPaymentsAmount').textContent = formatCurrency(plannedPaymentsAmount);
    
    document.getElementById('paidPaymentsCount').textContent = paidPaymentsCount;
    document.getElementById('paidPaymentsAmount').textContent = formatCurrency(paidPaymentsAmount);
    
    // Формируем HTML таблицы для закупок (без процентов и без бейджа в заголовке)
    let html = `
    
    <div class="stats-table" style="max-height: 400px; overflow-y: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="width: 70%; padding: 10px; border-bottom: 2px solid #3d4450; text-align: left; font-size: 16px;">Статус</th>
                    <th style="width: 30%; padding: 10px; border-bottom: 2px solid #3d4450; text-align: center; font-size: 16px;">Количество</th>
                </tr>
            </thead>
            <tbody>
`;

sortedStats.forEach(([status, count]) => {
    // Определяем цвет в зависимости от статуса
    let statusColor = '#c7d5e0';
    if (status === 'В работе') statusColor = '#ffffff';
    if (status === 'Поставка') statusColor = '#ffd700';
    if (status === 'Приход') statusColor = '#ffa500';
    if (status === 'Выполнено') statusColor = '#5c7e10';
    if (status === 'Иное') statusColor = '#8f98a0';
    
    html += `
        <tr>
            <td style="color: ${statusColor}; font-weight: bold; padding: 12px; border-bottom: 1px solid #3d4450; font-size: 16px;">
                ${status}
            </td>
            <td style="text-align: center; font-weight: bold; color: #66c0f4; padding: 12px; border-bottom: 1px solid #3d4450; font-size: 16px;">
                ${count}
            </td>
        </tr>
    `;
});
    
    // Если данных нет
    if (sortedStats.length === 0) {
        html += `
            <tr>
                <td colspan="2" style="text-align: center; color: #8f98a0; padding: 20px;">
                    ${yearFilter ? `Нет данных за ${yearFilter} год` : 'Нет данных'}
                </td>
            </tr>
        `;
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('statusStatsContent').innerHTML = html;
}function exportStatusStatsToExcel() {
    try {
        const statusStats = {};
        const totalRecords = accountingData.length;
        
        accountingData.forEach(item => {
            const status = item.status || 'Не указан';
            statusStats[status] = (statusStats[status] || 0) + 1;
        });
        
        const sortedStats = Object.entries(statusStats)
            .sort((a, b) => b[1] - a[1]);
        
        let csvContent = 'Статус;Количество;Процент\n';
        
        sortedStats.forEach(([status, count]) => {
            const percentage = totalRecords > 0 ? ((count / totalRecords) * 100).toFixed(1) : 0;
            csvContent += `"${status}";${count};${percentage}%\n`;
        });
        
        csvContent += `\nВсего записей;${totalRecords};\n`;
        csvContent += `Дата экспорта;${new Date().toLocaleDateString('ru-RU')};\n`;
        
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `статистика_по_статусам_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAutosaveNotification('Статистика экспортирована в CSV');
        
    } catch (error) {
        console.error('Ошибка при экспорте статистики:', error);
        alert('Ошибка при экспорте статистики');
    }
}

// Закрытие модального окна при клике вне его
window.addEventListener('click', function(event) {
    const modal = document.getElementById('statusStatsModal');
    if (event.target === modal) {
        closeStatusStatsModal();
    }
});
function initializeStatsYearFilter() {
    const yearFilter = document.getElementById('statsYearFilter');
    if (!yearFilter) return;
    
    // Очищаем опции, кроме первой
    while (yearFilter.options.length > 1) {
        yearFilter.remove(1);
    }
    
    // Собираем уникальные года из всех заявок
    const yearsFromAccounting = new Set();
    const yearsFromPayments = new Set();
    const yearsFromProxy = new Set(); // Добавлено
    const yearsFromMail = new Set(); // Добавлено
    
    accountingData.forEach(item => {
        const year = extractYearFromDocNumber(item.docNumber);
        if (year) {
            yearsFromAccounting.add(year);
        }
    });
    
    // Собираем года из платежей
    paymentsData.forEach(payment => {
        const year = extractYearFromPaymentDate(payment.date);
        if (year) {
            yearsFromPayments.add(year);
        }
    });
    
    // Собираем года из доверенностей (ДОБАВЛЕНО)
    proxyData.forEach(proxy => {
        const year = extractYearFromDateString(proxy.date);
        if (year) {
            yearsFromProxy.add(year);
        }
    });
    
    // Собираем года из почтового реестра (ДОБАВЛЕНО)
    mailData.forEach(mail => {
        const year = extractYearFromDateString(mail.date);
        if (year) {
            yearsFromMail.add(year);
        }
    });
    
    // Объединяем все года
    const allYears = new Set([
        ...yearsFromAccounting, 
        ...yearsFromPayments, 
        ...yearsFromProxy, // Добавлено
        ...yearsFromMail   // Добавлено
    ]);
    
    // Преобразуем Set в массив и сортируем по убыванию
    const sortedYears = Array.from(allYears).sort((a, b) => b - a);
    
    // Добавляем опции
    sortedYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
    });
}// Функция для извлечения года из строки даты в формате DD.MM.YYYY
function extractYearFromDateString(dateString) {
    if (!dateString) return null;
    
    // Проверяем формат DD.MM.YYYY
    if (dateString.includes('.')) {
        const parts = dateString.split('.');
        if (parts.length === 3) {
            return parts[2]; // Год
        }
    }
    
    return null;
}
// ========== ФУНКЦИИ ДЛЯ ФИЛЬТРА ПО ГОДАМ ==========

// Функция для извлечения года из номера заявки
function extractYearFromDocNumber(docNumber) {
    if (!docNumber) return null;
    
    const str = String(docNumber);
    
    // Ищем дату после "от" в разных форматах
    const patterns = [
        // Формат: "от DD.MM.YYYY" (кириллица)
        /от\s+(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{4})/i,
        /от\s+(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{2})/i,
        // Формат: "от YYYY-MM-DD"
        /от\s+(\d{4})[\.\/\-](\d{1,2})[\.\/\-](\d{1,2})/i,
        // Формат с русской датой (например: от 15 января 2024)
        /от\s+(\d{1,2})\s+(января|февраля|марта|апреля|мая|июня|июля|августа|сентября|октября|ноября|декабря)\s+(\d{4})/i
    ];
    
    for (const pattern of patterns) {
        const match = str.match(pattern);
        if (match) {
            let year = null;
            
            if (pattern.toString().includes('января|февраля')) {
                // Для русского формата: от 15 января 2024
                year = match[3];
            } else if (match[3] && match[3].length === 4) {
                // DD.MM.YYYY или YYYY-MM-DD (4-значный год)
                year = match[3];
            } else if (match[3] && match[3].length === 2) {
                // DD.MM.YY (2-значный год)
                year = '20' + match[3];
            } else if (match[1] && match[1].length === 4) {
                // YYYY-MM-DD (год в первой группе)
                year = match[1];
            }
            
            if (year) {
                const yearNum = parseInt(year, 10);
                if (yearNum >= 2000 && yearNum <= 2100) {
                    return year;
                }
            }
        }
    }
    
    // Если не нашли дату после "от", ищем просто год в строке
    const yearPatterns = [
        /\b(20\d{2})\b/,           // 2023, 2024 и т.д.
        /[-_\/](\d{4})[-_\/]/,      // -2023-, /2023/
        /[-_\/](\d{2})(?!\d)/,      // -23, /23 (две последние цифры года)
        /(\d{4})[-_\/]/,            // 2023-, 2023/
        /[-_\/](\d{4})$/,           // -2023 (в конце)
    ];
    
    for (const pattern of yearPatterns) {
        const match = str.match(pattern);
        if (match) {
            let year = match[1];
            
            if (year.length === 2) {
                year = '20' + year;
            }
            
            const yearNum = parseInt(year, 10);
            if (yearNum >= 2000 && yearNum <= 2100) {
                return year;
            }
        }
    }
    
    return null;
}
// Функция для извлечения года из даты платежа
function extractYearFromPaymentDate(dateString) {
    if (!dateString) return null;
    
    // Пытаемся распарсить дату
    const date = parseDate(dateString);
    if (date && !isNaN(date.getTime())) {
        return date.getFullYear().toString();
    }
    
    // Если дата в формате DD.MM.YYYY
    if (dateString.includes('.')) {
        const parts = dateString.split('.');
        if (parts.length === 3) {
            return parts[2];
        }
    }
    
    // Если дата в формате YYYY-MM-DD
    if (dateString.includes('-')) {
        const parts = dateString.split('-');
        if (parts.length === 3) {
            return parts[0];
        }
    }
    
    return null;
}
// Функция для обновления списка годов
function updateYearsFilter() {
    const yearFilter = document.getElementById('yearFilter');
    if (!yearFilter) return;
    
    // Собираем уникальные года из всех заявок (столбец "Заявка")
    const years = new Set();
    
    accountingData.forEach(item => {
        const year = extractYearFromDocNumber(item.docNumber);
        if (year) {
            years.add(year);
        }
    });
    
    // Сохраняем текущее выбранное значение
    const currentValue = yearFilter.value;
    
    // Очищаем опции, кроме первой ("Все года")
    while (yearFilter.options.length > 1) {
        yearFilter.remove(1);
    }
    
    // Преобразуем Set в массив и сортируем по убыванию
    const sortedYears = Array.from(years).sort((a, b) => b - a);
    
    // Добавляем новые опции
    sortedYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
    });
    
    // Восстанавливаем выбранное значение
    if (currentValue && sortedYears.includes(currentValue)) {
        yearFilter.value = currentValue;
    }
}
function applyFixedAccountingTableLayout() {
    const table = document.getElementById('accountingTable');
    if (!table) return;
    
    table.style.tableLayout = 'fixed';
    
    // Убедитесь, что все ячейки имеют фиксированную ширину
    const headers = table.querySelectorAll('th');
    const rows = table.querySelectorAll('tbody tr');
    
    headers.forEach((header, index) => {
        const width = header.style.width || '100px';
        header.style.width = width;
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells[index]) {
                cells[index].style.width = width;
                cells[index].style.minWidth = width;
                cells[index].style.maxWidth = width;
            }
        });
    });
}

// Вызывайте эту функцию после каждой фильтрации
setTimeout(applyFixedAccountingTableLayout, 100);

        // ========== ФУНКЦИИ ДЛЯ СТРАНИЦЫ КОНТРАГЕНТОВ ==========
        function updateCounterpartiesTable() {
    const tableBody = document.querySelector('#counterpartiesTable tbody');
    if (!tableBody) {
        console.error('Не найден tbody для таблицы контрагентов');
        return;
    }
    
    tableBody.innerHTML = '';
    
    if (counterpartiesData.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
            <td colspan="7" style="text-align: center; color: #8f98a0; padding: 20px;">
                Нет данных о контрагентах. Добавьте первого контрагента.
            </td>
        `;
        tableBody.appendChild(emptyRow);
        return;
    }
    
    // СОРТИРОВКА ПО ДАТЕ (УБЫВАНИЕ - СНАЧАЛА НОВЫЕ)
    const sortedCounterparties = [...counterpartiesData].sort((a, b) => {
        // Извлекаем timestamp из recordId
        const timeA = getTimeFromRecordId(a.recordId) || 0;
        const timeB = getTimeFromRecordId(b.recordId) || 0;
        
        // Сортировка по убыванию (новые сначала)
        return timeB - timeA;
    });
    
    sortedCounterparties.forEach((item) => {
        const row = document.createElement('tr');
        
        // Добавляем уникальный ID записи в data-атрибут
        row.dataset.recordId = item.recordId || '';
        
        // Добавляем класс для контрагентов в черном списке
        if (item.blacklisted) {
            row.classList.add('blacklisted-row');
        }
        
        row.innerHTML = `
            <td>${escapeString(item.supplier) || ''}</td>
            <td>${escapeString(item.inn) || ''}</td>
            <td>${escapeString(item.phone) || ''}</td>
            <td>${escapeString(item.contact) || ''}</td>
            <td>${escapeString(item.email) || ''}</td>
            <td>${escapeString(item.material) || ''}</td>
            <td>${escapeString(item.address) || ''}</td>
        `;
        
        // ВСЕГДА добавляем класс для подсветки
row.classList.add('clickable-row');
if (!isAdmin) {
    row.classList.add('guest-mode');
}

// Только для администратора добавляем обработчик редактирования
if (isAdmin) {
    row.addEventListener('dblclick', function(e) {
        if (!e.target.closest('button') && !e.target.closest('input')) {
            const recordId = e.currentTarget.dataset.recordId;
            
            // Ищем запись по recordId
            const recordIndex = counterpartiesData.findIndex(record => record.recordId === recordId);
            if (recordIndex !== -1) {
                editCounterpartyRow(recordIndex);
            } else {
                // Если не нашли по recordId, пробуем найти по другим параметрам
                const supplier = e.currentTarget.querySelector('td:nth-child(1)').textContent;
                const fallbackIndex = counterpartiesData.findIndex(record => 
                    record.supplier === supplier
                );
                if (fallbackIndex !== -1) {
                    editCounterpartyRow(fallbackIndex);
                }
            }
        }
    });
}
        
        tableBody.appendChild(row);
    });
}

        function filterCounterpartiesTable() {
    const searchText = document.getElementById('searchCounterpartiesInput').value.toLowerCase();
    const rows = document.querySelectorAll('#counterpartiesTable tbody tr');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        // Пропускаем строку с сообщением "нет данных"
        if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
            row.style.display = (searchText || showOnlyBlacklisted) ? 'none' : '';
            return;
        }
        
        let rowText = '';
        row.querySelectorAll('td').forEach(cell => {
            rowText += cell.textContent.toLowerCase() + ' ';
        });
        
        const isBlacklisted = row.classList.contains('blacklisted-row');
        const blacklistMatch = !showOnlyBlacklisted || isBlacklisted;
        const searchMatch = !searchText || rowText.includes(searchText);
        
        if (blacklistMatch && searchMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Показываем сообщение, если нет видимых строк
    if (visibleCount === 0 && (searchText || showOnlyBlacklisted)) {
        const tableBody = document.querySelector('#counterpartiesTable tbody');
        if (tableBody.querySelector('tr[data-no-results]')) return;
        
        const noResultsRow = document.createElement('tr');
        noResultsRow.setAttribute('data-no-results', 'true');
        noResultsRow.innerHTML = `
            <td colspan="7" style="text-align: center; color: #8f98a0; padding: 20px;">
                ${showOnlyBlacklisted ? 'В черном списке нет контрагентов' : `По запросу "${searchText}" ничего не найдено`}
            </td>
        `;
        tableBody.appendChild(noResultsRow);
    } else {
        const noResultsRow = document.querySelector('tr[data-no-results]');
        if (noResultsRow) {
            noResultsRow.remove();
        }
    }
}

        function clearCounterpartiesFilters() {
            document.getElementById('searchCounterpartiesInput').value = '';
            showOnlyBlacklisted = false;
            const button = document.getElementById('blacklistFilterBtn');
            if (button) {
                button.textContent = 'Показать черный список';
                button.style.background = '';
            }
            filterCounterpartiesTable();
        }

        function toggleBlacklistFilter() {
    showOnlyBlacklisted = !showOnlyBlacklisted;
    const button = document.getElementById('blacklistFilterBtn');
    
    if (showOnlyBlacklisted) {
        button.textContent = 'Показать всех';
        button.style.background = 'linear-gradient(135deg, #be463c 0%, #8c2c24 100%)';
    } else {
        button.textContent = 'Показать черный список';
        button.style.background = '';
    }
    
    filterCounterpartiesTable();
}

        function showAddCounterpartyForm() {
    if (!isAdmin) {
        alert('Только администратор может добавлять контрагентов');
        return;
    }
    
    document.getElementById('modalCounterpartyTitle').textContent = 'Добавить контрагента';
    document.getElementById('editCounterpartyIndex').value = '';
    document.getElementById('editCounterpartyForm').reset();
    const deleteBtn = document.querySelector('#editCounterpartyModal .delete-btn');
    if (deleteBtn) deleteBtn.style.display = 'none';
    
    // Скрываем поле комментария при добавлении нового контрагента
    document.getElementById('blacklistCommentContainer').style.display = 'none';
    
    // СКРЫВАЕМ флажок "В черном списке" при добавлении
    const blacklistCheckbox = document.getElementById('editBlacklisted');
    const blacklistLabel = document.querySelector('label[for="editBlacklisted"]');
    if (blacklistCheckbox) blacklistCheckbox.style.display = 'none';
    if (blacklistLabel) blacklistLabel.style.display = 'none';
    
    document.getElementById('editCounterpartyModal').style.display = 'block';
}

        function editCounterpartyRow(index) {
    if (!isAdmin) return;
    
    const item = counterpartiesData[index];
    document.getElementById('modalCounterpartyTitle').textContent = 'Редактировать контрагента';
    document.getElementById('editCounterpartyIndex').value = index;
    document.getElementById('editSupplier').value = item.supplier || '';
    document.getElementById('editInn').value = item.inn || '';
    document.getElementById('editPhone').value = item.phone || '';
    document.getElementById('editContact').value = item.contact || '';
    document.getElementById('editEmail').value = item.email || '';
    document.getElementById('editAddress').value = item.address || '';
    document.getElementById('editMaterial').value = item.material || '';
    document.getElementById('editBlacklisted').checked = item.blacklisted || false;
    document.getElementById('editBlacklistComment').value = item.blacklistComment || '';
    
    // Показываем/скрываем поле комментария
    toggleBlacklistComment();
    
    // ПОКАЗЫВАЕМ флажок "В черном списке" при редактировании
    const blacklistCheckbox = document.getElementById('editBlacklisted');
    const blacklistLabel = document.querySelector('label[for="editBlacklisted"]');
    if (blacklistCheckbox) blacklistCheckbox.style.display = 'block';
    if (blacklistLabel) blacklistLabel.style.display = 'block';
    
    const deleteBtn = document.querySelector('#editCounterpartyModal .delete-btn');
    if (deleteBtn) deleteBtn.style.display = 'inline-block';
    document.getElementById('editCounterpartyModal').style.display = 'block';
}

        function saveCounterpartyChanges(event) {
    event.preventDefault();
    
    const index = document.getElementById('editCounterpartyIndex').value;
    const recordId = document.getElementById('editCounterpartyIndex').value ? 
        counterpartiesData[index]?.recordId || generateUniqueId() : 
        generateUniqueId();
    
    const item = {
        recordId: recordId,
        supplier: document.getElementById('editSupplier').value,
        inn: document.getElementById('editInn').value,
        phone: document.getElementById('editPhone').value,
        contact: document.getElementById('editContact').value,
        email: document.getElementById('editEmail').value,
        address: document.getElementById('editAddress').value,
        material: document.getElementById('editMaterial').value,
        blacklisted: document.getElementById('editBlacklisted').checked,
        blacklistComment: document.getElementById('editBlacklistComment').value || ''
    };
    
    if (index === '') {
        counterpartiesData.push(item);
    } else {
        counterpartiesData[index] = item;
    }
    
    // Сортируем контрагентов по убыванию даты после сохранения
    counterpartiesData.sort((a, b) => {
        const timeA = getTimeFromRecordId(a.recordId) || 0;
        const timeB = getTimeFromRecordId(b.recordId) || 0;
        return timeB - timeA;
    });
    
    saveAllData();
    updateCounterpartiesTable();
    updateSuppliersList();
    closeCounterpartyModal();
    markChangesMade();
}

        function closeCounterpartyModal() {
            // Восстанавливаем видимость элементов при закрытии модального окна
            const blacklistCheckbox = document.getElementById('editBlacklisted');
            const blacklistLabel = document.querySelector('label[for="editBlacklisted"]');
            if (blacklistCheckbox) blacklistCheckbox.style.display = 'block';
            if (blacklistLabel) blacklistLabel.style.display = 'block';
            
            document.getElementById('editCounterpartyModal').style.display = 'none';
        }
// Функция для гостя
function loginAsGuest() {
    isAdmin = false;
    currentUser = 'guest';
    localStorage.setItem('userAuth', JSON.stringify({ isAdmin, currentUser }));
    
    // Обновляем интерфейс
    updateUserButton();
    updateCommentFieldPermissions();
    
    // Скрываем элементы только для администратора
    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = 'none';
    });
    
    // Обновляем все таблицы
    updateAllTables();
    
    showAutosaveNotification('Гостевой режим активирован');
}
// ========== ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ ФОРМОЙ ВХОДА ==========
function setupLoginPage() {
    const showAdminFormLink = document.getElementById('show-admin-form');
    const adminForm = document.getElementById('admin-form');
    
    if (showAdminFormLink && adminForm) {
        showAdminFormLink.addEventListener('click', function(e) {
            e.preventDefault();
            adminForm.style.display = 'block';
            showAdminFormLink.style.display = 'none';
            document.getElementById('admin-password').focus();
        });
    }
    
    // Убедимся, что все элементы формы имеют правильную ширину
    setTimeout(() => {
        const inputs = document.querySelectorAll('#login-page input');
        const buttons = document.querySelectorAll('#login-page button');
        
        inputs.forEach(input => {
            input.style.width = '100%';
            input.style.boxSizing = 'border-box';
        });
        
        buttons.forEach(button => {
            button.style.width = '100%';
            button.style.boxSizing = 'border-box';
        });
    }, 100);
}
// ========== ФУНКЦИЯ ДЛЯ ОБНОВЛЕНИЯ СПИСКА ДОГОВОРОВ ==========
function updateContractsList() {
    const contractsList = document.getElementById('contractsList');
    if (!contractsList) return;
    
    // Очищаем список
    contractsList.innerHTML = '';
    
    // Собираем уникальные договоры из всех данных
    const allContracts = new Set();
    
    // Договоры из Учета
    accountingData.forEach(item => {
        if (item.contract && item.contract.trim() !== '') {
            allContracts.add(item.contract.trim());
        }
    });
    
    // Договоры из Платежей
    paymentsData.forEach(item => {
        if (item.contract && item.contract.trim() !== '') {
            allContracts.add(item.contract.trim());
        }
    });
    
    // Преобразуем в массив и сортируем
    const sortedContracts = Array.from(allContracts).sort();
    
    // Добавляем опции в datalist
    sortedContracts.forEach(contract => {
        const option = document.createElement('option');
        option.value = contract;
        contractsList.appendChild(option);
    });
}

// ========== ФУНКЦИЯ ДЛЯ АВТОЗАПОЛНЕНИЯ ДОГОВОРА ==========
function autoFillContract() {
    const contractInput = document.getElementById('editContract');
    if (!contractInput) return;
    
    contractInput.addEventListener('input', function() {
        const inputValue = this.value.toLowerCase();
        const contracts = Array.from(
            document.querySelectorAll('#contractsList option')
        ).map(opt => opt.value);
        
        // Находим подходящие договоры
        const matchingContracts = contracts.filter(contract => 
            contract.toLowerCase().includes(inputValue)
        );
        
        // Если есть подходящие договоры, можно показать их в каком-то списке
        // Но datalist уже сам покажет подсказки
    });
}

// Аналогично для платежей
function autoFillPaymentContract() {
    const contractInput = document.getElementById('editPaymentContract');
    if (!contractInput) return;
    
    contractInput.addEventListener('input', function() {
        const inputValue = this.value.toLowerCase();
        const contracts = Array.from(
            document.querySelectorAll('#contractsList option')
        ).map(opt => opt.value);
        
        // Находим подходящие договоры
        const matchingContracts = contracts.filter(contract => 
            contract.toLowerCase().includes(inputValue)
        );
    });
}
        // Функция для показа/скрытия поля комментария при изменении чекбокса
        function toggleBlacklistComment() {
            const blacklistedCheckbox = document.getElementById('editBlacklisted');
            const commentContainer = document.getElementById('blacklistCommentContainer');
            
            if (blacklistedCheckbox && commentContainer) {
                commentContainer.style.display = blacklistedCheckbox.checked ? 'block' : 'none';
                
                // Если снимаем галочку, очищаем комментарий
                if (!blacklistedCheckbox.checked) {
                    document.getElementById('editBlacklistComment').value = '';
                }
            }
        }
function updateSuppliersFilterList() {
    const filterDatalist = document.getElementById('suppliersListFilter');
    if (!filterDatalist) return;
    
    filterDatalist.innerHTML = '';
    
    // Собираем уникальных поставщиков из accountingData
    const suppliers = [...new Set(accountingData.map(item => item.supplier).filter(Boolean))];
    
    suppliers.forEach(supplier => {
        const option = document.createElement('option');
        option.value = supplier;
        filterDatalist.appendChild(option);
    });
}
        // ========== ФУНКЦИИ ДЛЯ СТРАНИЦЫ ПЛАТЕЖЕЙ ==========
        function updatePaymentsTable() {
    const tableBody = document.querySelector('#paymentsTable tbody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    if (paymentsData.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
            <td colspan="6" style="text-align: center; color: #8f98a0; padding: 20px;">
                Нет данных о платежах. Добавьте первую запись.
            </td>
        `;
        tableBody.appendChild(emptyRow);
        return;
    }
    
    const sortedPayments = [...paymentsData].sort((a, b) => {
        const timeA = getTimeFromRecordId(a.recordId) || 0;
        const timeB = getTimeFromRecordId(b.recordId) || 0;
        return timeB - timeA;
    });
    
    sortedPayments.forEach((item) => {
        const row = document.createElement('tr');
        row.dataset.recordId = item.recordId || '';
        
        if (item.status === 'Оплачено') {
            row.classList.add('status-completed');
        }
        row.classList.add('clickable-row');
        if (!isAdmin) {
            row.classList.add('guest-mode');
        }
        
        // Дата
        const dateCell = createCell(item.date || '', '174px');
        row.appendChild(dateCell);
        
        // Контрагент
        const supplierCell = createCell(item.supplier || '', '174px');
        row.appendChild(supplierCell);
        
        // Сумма
        const amountCell = createCell(item.amount ? formatCurrency(item.amount) : '', '174px');
        row.appendChild(amountCell);
        
        // Договор
        const contractCell = createCell(item.contract || '', '174px');
        row.appendChild(contractCell);
        
        // Ссылка
        const linkCell = document.createElement('td');
linkCell.style.width = '174px';
const link = item.link || '';
if (link) {
    const linkSpan = document.createElement('span');
    linkSpan.textContent = link;
    linkSpan.style.color = '#66c0f4';
    linkSpan.style.textDecoration = 'underline';
    linkSpan.style.cursor = 'pointer';
    linkSpan.addEventListener('click', function(e) {
        e.preventDefault(); // на случай, если вдруг это ссылка
        copyToClipboard(link);
    });
    linkCell.appendChild(linkSpan);
} else {
    linkCell.textContent = '';
}
row.appendChild(linkCell);
        
        // Статус
        const statusCell = createCell(item.status || '', '174px');
        row.appendChild(statusCell);
        
        if (isAdmin) {
            row.addEventListener('dblclick', function(e) {
                if (!e.target.closest('button') && !e.target.closest('input')) {
                    const recordId = e.currentTarget.dataset.recordId;
                    const recordIndex = paymentsData.findIndex(record => record.recordId === recordId);
                    if (recordIndex !== -1) {
                        editPaymentRow(recordIndex);
                    } else {
                        const supplier = e.currentTarget.querySelector('td:nth-child(2)').textContent;
                        const amount = e.currentTarget.querySelector('td:nth-child(3)').textContent;
                        const fallbackIndex = paymentsData.findIndex(record => 
                            record.supplier === supplier && 
                            formatCurrency(record.amount) === amount
                        );
                        if (fallbackIndex !== -1) {
                            editPaymentRow(fallbackIndex);
                        }
                    }
                }
            });
        }
        
        tableBody.appendChild(row);
    });
}

        function filterPaymentsTable() {
    const searchText = document.getElementById('searchPaymentsInput').value.toLowerCase();
    const statusFilter = document.getElementById('paymentsStatusFilter').value;
    
    const rows = document.querySelectorAll('#paymentsTable tbody tr');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
            row.style.display = (searchText || statusFilter) ? 'none' : '';
            if (!searchText && !statusFilter) {
                visibleCount++;
            }
            return;
        }
        
        let rowText = '';
        row.querySelectorAll('td').forEach(cell => {
            rowText += cell.textContent.toLowerCase() + ' ';
        });
        
        // Статус теперь в 6-й ячейке (индекс 5)
        const statusCell = row.querySelector('td:nth-child(6)').textContent;
        const statusMatch = !statusFilter || statusCell === statusFilter;
        const searchMatch = !searchText || rowText.includes(searchText);
        
        if (statusMatch && searchMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
            
    if (visibleCount === 0 && (searchText || statusFilter)) {
        const tableBody = document.querySelector('#paymentsTable tbody');
        let noDataRow = tableBody.querySelector('tr[data-no-results]');
        
        if (!noDataRow) {
            noDataRow = document.createElement('tr');
            noDataRow.setAttribute('data-no-results', 'true');
            noDataRow.innerHTML = `
                <td colspan="6" style="text-align: center; color: #8f98a0; padding: 20px;">
                    По вашему запросу ничего не найдено
                </td>
            `;
            tableBody.appendChild(noDataRow);
        }
    } else {
        const noDataRow = document.querySelector('#paymentsTable tr[data-no-results]');
        if (noDataRow) {
            noDataRow.remove();
        }
    }
}

        function clearPaymentsFilters() {
            document.getElementById('searchPaymentsInput').value = '';
            document.getElementById('paymentsStatusFilter').value = '';
            filterPaymentsTable();
        }

        function showAddPaymentForm() {
    if (!isAdmin) {
        alert('Только администратор может добавлять платежи');
        return;
    }
    
    document.getElementById('modalPaymentTitle').textContent = 'Добавить платеж';
    document.getElementById('editPaymentIndex').value = '';
    document.getElementById('editPaymentForm').reset();
    const deleteBtn = document.querySelector('#editPaymentModal .delete-btn');
    if (deleteBtn) deleteBtn.style.display = 'none';
    document.getElementById('editPaymentModal').style.display = 'block';
    
    // Инициализируем автозаполнение для договора
    setTimeout(autoFillPaymentContract, 100);
}

function editPaymentRow(index) {
    if (!isAdmin) return;
    
    const item = paymentsData[index];
    document.getElementById('modalPaymentTitle').textContent = 'Редактировать платеж';
    document.getElementById('editPaymentIndex').value = index;
    
    document.getElementById('editPaymentDate').value = formatDateForInput(item.date);
    document.getElementById('editPaymentSupplier').value = item.supplier || '';
    document.getElementById('editPaymentAmount').value = item.amount || '';
    document.getElementById('editPaymentContract').value = item.contract || '';
    document.getElementById('editPaymentLink').value = item.link || '';
    document.getElementById('editPaymentStatus').value = item.status || 'План';
    
    const deleteBtn = document.querySelector('#editPaymentModal .delete-btn');
    if (deleteBtn) deleteBtn.style.display = 'inline-block';
    document.getElementById('editPaymentModal').style.display = 'block';
    
    // Инициализируем автозаполнение для договора
    setTimeout(autoFillPaymentContract, 100);
}
        function savePaymentChanges(event) {
    event.preventDefault();
    
    const index = document.getElementById('editPaymentIndex').value;
    const recordId = document.getElementById('editPaymentIndex').value ? 
        paymentsData[index]?.recordId || generateUniqueId() : 
        generateUniqueId();
    
    const item = {
        recordId: recordId,
        status: document.getElementById('editPaymentStatus').value,
        date: formatDateForDisplay(document.getElementById('editPaymentDate').value),
        amount: document.getElementById('editPaymentAmount').value,
        supplier: document.getElementById('editPaymentSupplier').value,
        contract: document.getElementById('editPaymentContract').value,
        link: document.getElementById('editPaymentLink').value,
    };
    
    if (index === '') {
        paymentsData.push(item);
    } else {
        paymentsData[index] = item;
    }
    
    // Сортируем платежи по убыванию даты после сохранения
    paymentsData.sort((a, b) => {
        const timeA = getTimeFromRecordId(a.recordId) || 0;
        const timeB = getTimeFromRecordId(b.recordId) || 0;
        return timeB - timeA;
    });
    
    saveAllData();
    updatePaymentsTable();
    updateContractsList();
    closePaymentModal();
    markChangesMade();
    refreshStatusStatsIfOpen();
}

        function deletePaymentRecord() {
    if (!isAdmin) {
        alert('Только администратор может удалять платежи');
        return;
    }
    
    const index = document.getElementById('editPaymentIndex').value;
    
    if (index === '') {
        alert('Нельзя удалить новый платеж');
        return;
    }
    
    if (confirm('Вы уверены, что хотите удалить этот платеж?')) {
        paymentsData.splice(index, 1);
        
        // Обновляем таблицу после удаления
        saveAllData();
        updatePaymentsTable();
        closePaymentModal();
        markChangesMade();
        refreshStatusStatsIfOpen();
    }
}

        function closePaymentModal() {
            document.getElementById('editPaymentModal').style.display = 'none';
        }
// ========== ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ ПОДРАЗДЕЛЕНИЯМИ ==========

let departmentsList = []; // Массив для хранения подразделений

// Загрузка списка подразделений
function loadDepartmentsList() {
    const saved = localStorage.getItem('departmentsList');
    if (saved) {
        departmentsList = JSON.parse(saved);
    } else {
        // Инициализируем из существующих данных, если список пустой
        const departmentsFromData = [...new Set(accountingData.map(item => item.department).filter(Boolean))];
        departmentsList = departmentsFromData.sort();
        saveDepartmentsList();
    }
}

// Сохранение списка подразделений
function saveDepartmentsList() {
    localStorage.setItem('departmentsList', JSON.stringify(departmentsList));
    updateDepartmentsFilter(); // Обновляем datalist
}

// Показать модальное окно подразделений
function showDepartmentsModal() {
    if (!isAdmin) {
        alert('Только администратор может управлять подразделениями');
        return;
    }
    
    closeSettingsMenu(); // Закрываем меню настроек
    document.getElementById('departmentsModal').style.display = 'block';
    renderDepartmentsList();
    document.getElementById('newDepartmentInput').value = '';
    document.getElementById('newDepartmentInput').focus();
}

// Закрыть модальное окно подразделений
function closeDepartmentsModal() {
    document.getElementById('departmentsModal').style.display = 'none';
}

// Отобразить список подразделений
function renderDepartmentsList() {
    const container = document.getElementById('departmentsListContainer');
    if (!container) return;
    
    if (departmentsList.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #8f98a0; padding: 20px;">Список подразделений пуст</div>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
    
    departmentsList.forEach((dept, index) => {
        html += `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                        background: rgba(42, 71, 94, 0.5); padding: 10px; border-radius: 4px; 
                        border: 1px solid #3d4450;">
                <span style="color: #c7d5e0; font-weight: bold;">${escapeString(dept)}</span>
                <div style="display: flex; gap: 5px;">
                    <button onclick="editDepartment(${index})" 
                            style="padding: 5px 10px; background: linear-gradient(135deg, #7a9eb5 0%, #5a7a90 100%); 
                                   color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        ✏️
                    </button>
                    <button onclick="removeDepartment(${index})" 
                            style="padding: 5px 10px; background: linear-gradient(135deg, #be463c 0%, #8c2c24 100%); 
                                   color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        ✕
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Добавить новое подразделение
function addNewDepartment() {
    const input = document.getElementById('newDepartmentInput');
    const newDept = input.value.trim();
    
    if (!newDept) {
        alert('Введите название подразделения');
        return;
    }
    
    // Проверяем, нет ли уже такого подразделения
    if (departmentsList.includes(newDept)) {
        alert('Такое подразделение уже есть в списке');
        return;
    }
    
    departmentsList.push(newDept);
    departmentsList.sort(); // Сортируем по алфавиту
    saveDepartmentsList();
    renderDepartmentsList();
    
    input.value = '';
    input.focus();
    
    showAutosaveNotification('Подразделение добавлено');
}

// Удалить подразделение
function removeDepartment(index) {
    if (!confirm('Вы уверены, что хотите удалить это подразделение?')) {
        return;
    }
    
    departmentsList.splice(index, 1);
    saveDepartmentsList();
    renderDepartmentsList();
    showAutosaveNotification('Подразделение удалено');
}

// Редактировать подразделение
function editDepartment(index) {
    const oldName = departmentsList[index];
    const newName = prompt('Введите новое название подразделения:', oldName);
    
    if (!newName || newName.trim() === '') return;
    
    const trimmedName = newName.trim();
    
    // Проверяем, нет ли уже такого названия (кроме текущего)
    if (departmentsList.includes(trimmedName) && departmentsList[index] !== trimmedName) {
        alert('Такое подразделение уже есть в списке');
        return;
    }
    
    departmentsList[index] = trimmedName;
    departmentsList.sort(); // Сортируем заново
    saveDepartmentsList();
    renderDepartmentsList();
    showAutosaveNotification('Подразделение обновлено');
}

        // Вспомогательная функция для форматирования валюты
        function formatCurrency(value) {
            if (!value) return '';
            const number = parseFloat(value);
            if (isNaN(number)) return value;
            return number.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' руб.';
        }

        // ========== ФУНКЦИИ ДЛЯ СТРАНИЦЫ УРЕГУЛИРОВАНИЯ ==========
        function updateSettlementTable() {
            const tableBody = document.querySelector('#settlementTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (settlementData.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="6" style="text-align: center; color: #8f98a0; padding: 20px;">
                        Нет данных об урегулировании. Добавьте первую запись.
                    </td>
                `;
                tableBody.appendChild(emptyRow);
                return;
            }
            
            settlementData.forEach((item, index) => {
                const row = document.createElement('tr');
                if (isAdmin) {
                    row.classList.add('clickable-row');
                    row.style.cursor = 'pointer';
                }
                if (item.status === 'Выполнено') row.classList.add('status-completed');
                if (item.status === 'Иное') row.classList.add('status-other');
                
                row.classList.add('clickable-row');
                if (!isAdmin) {
                row.classList.add('guest-mode');
                }
                row.innerHTML = `
                    <td>${item.note || ''}</td>
                    <td>${item.status || ''}</td>
                    <td>${item.supplier || ''}</td>
                    <td>${item.remark || ''}</td>
                    <td>${item.outgoing || ''}</td>
                    <td>${item.incoming || ''}</td>
                `;
                
                if (isAdmin) {
                    row.addEventListener('dblclick', function(e) {
                        // Проверяем, что клик не по кнопке или другому интерактивному элементу
                        if (!e.target.closest('button') && !e.target.closest('input')) {
                            editSettlementRow(index);
                        }
                    });
                }
                
                tableBody.appendChild(row);
            });
        }

        function filterSettlementTable() {
            const searchText = document.getElementById('searchSettlementInput').value.toLowerCase();
            const statusFilter = document.getElementById('settlementStatusFilter').value;
            
            const rows = document.querySelectorAll('#settlementTable tbody tr');
            
            rows.forEach(row => {
                let rowText = '';
                row.querySelectorAll('td').forEach(cell => {
                    rowText += cell.textContent.toLowerCase() + ' ';
                });
                
                const statusMatch = !statusFilter || row.querySelector('td:nth-child(2)').textContent === statusFilter;
                const searchMatch = !searchText || rowText.includes(searchText);
                
                row.style.display = (statusMatch && searchMatch) ? '' : 'none';
            });
        }

        function clearSettlementFilters() {
            document.getElementById('searchSettlementInput').value = '';
            document.getElementById('settlementStatusFilter').value = '';
            filterSettlementTable();
        }

        function showAddSettlementForm() {
            if (!isAdmin) {
                alert('Только администратор может добавлять записи');
                return;
            }
            
            document.getElementById('modalSettlementTitle').textContent = 'Добавить запись урегулирования';
            document.getElementById('editSettlementIndex').value = '';
            document.getElementById('editSettlementForm').reset();
            const deleteBtn = document.querySelector('#editSettlementModal .delete-btn');
            if (deleteBtn) deleteBtn.style.display = 'none';
            document.getElementById('editSettlementModal').style.display = 'block';
        }

        function editSettlementRow(index) {
            if (!isAdmin) return;
            
            const item = settlementData[index];
            document.getElementById('modalSettlementTitle').textContent = 'Редактировать запись урегулирования';
            document.getElementById('editSettlementIndex').value = index;
            document.getElementById('editSettlementNote').value = item.note || '';
            document.getElementById('editSettlementStatus').value = item.status || 'В работе';
            document.getElementById('editSettlementSupplier').value = item.supplier || '';
            document.getElementById('editSettlementRemark').value = item.remark || '';
            document.getElementById('editSettlementOutgoing').value = item.outgoing || '';
            document.getElementById('editSettlementIncoming').value = item.incoming || '';
            const deleteBtn = document.querySelector('#editSettlementModal .delete-btn');
            if (deleteBtn) deleteBtn.style.display = 'inline-block';
            document.getElementById('editSettlementModal').style.display = 'block';
        }

        function saveSettlementChanges(event) {
            event.preventDefault();
            
            const index = document.getElementById('editSettlementIndex').value;
            const item = {
                note: document.getElementById('editSettlementNote').value,
                status: document.getElementById('editSettlementStatus').value,
                supplier: document.getElementById('editSettlementSupplier').value,
                remark: document.getElementById('editSettlementRemark').value,
                outgoing: document.getElementById('editSettlementOutgoing').value,
                incoming: document.getElementById('editSettlementIncoming').value
            };
            
            if (index === '') {
                settlementData.push(item);
            } else {
                settlementData[index] = item;
            }
            
            saveAllData();
            updateSettlementTable();
            closeSettlementModal();
            markChangesMade();
            refreshStatusStatsIfOpen();
        }

        function closeSettlementModal() {
            document.getElementById('editSettlementModal').style.display = 'none';
        }

        // ========== ФУНКЦИИ ДЛЯ СТРАНИЦЫ ПОЧТОВЫЙ РЕЕСТР ==========
        function updateMailTable() {
    const tableBody = document.querySelector('#mailTable tbody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    if (mailData.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
            <td colspan="7" style="text-align: center; color: #8f98a0; padding: 20px;">
                Нет данных в почтовом реестре. Добавьте первую запись.
            </td>
        `;
        tableBody.appendChild(emptyRow);
        return;
    }
    
    // СОРТИРОВКА ПО ДАТЕ (УБЫВАНИЕ - СНАЧАЛА НОВЫЕ)
    const sortedMailData = [...mailData].sort((a, b) => {
        // Извлекаем timestamp из recordId
        const timeA = getTimeFromRecordId(a.recordId) || 0;
        const timeB = getTimeFromRecordId(b.recordId) || 0;
        
        // Сортировка по убыванию (новые сначала)
        return timeB - timeA;
    });
    
    sortedMailData.forEach((item) => {
        const row = document.createElement('tr');
        
        // Добавляем уникальный ID записи в data-атрибут
        row.dataset.recordId = item.recordId || '';
                       
        
        row.innerHTML = `
            <td>${item.date || ''}</td>
            <td>${item.supplier || ''}</td>
            <td>${item.document || ''}</td>
            <td>${item.sheets || ''}</td>
            <td>${item.address || ''}</td>
            <td>${item.sender || ''}</td>
        `;
        
// ВСЕГДА добавляем класс для подсветки
row.classList.add('clickable-row');
if (!isAdmin) {
    row.classList.add('guest-mode');
}

// Только для администратора добавляем обработчик редактирования
if (isAdmin) {
    row.addEventListener('dblclick', function(e) {
        if (!e.target.closest('button') && !e.target.closest('input')) {
            const recordId = e.currentTarget.dataset.recordId;
            
            // Ищем запись по recordId
            const recordIndex = mailData.findIndex(record => record.recordId === recordId);
            if (recordIndex !== -1) {
                editMailRow(recordIndex);
            } else {
                // Если не нашли по recordId, пробуем найти по другим параметрам
                const date = e.currentTarget.querySelector('td:nth-child(1)').textContent;
                const supplier = e.currentTarget.querySelector('td:nth-child(2)').textContent;
                const fallbackIndex = mailData.findIndex(record => 
                    record.date === date && 
                    record.supplier === supplier
                );
                if (fallbackIndex !== -1) {
                    editMailRow(fallbackIndex);
                }
            }
        }
    });
}
        
        tableBody.appendChild(row);
    });
}

        function filterMailTable() {
            const searchText = document.getElementById('searchMailInput').value.toLowerCase();
            const dateFilter = document.getElementById('mailDateFilter').value;
            
            const rows = document.querySelectorAll('#mailTable tbody tr');
            
            rows.forEach(row => {
                let rowText = '';
                row.querySelectorAll('td').forEach(cell => {
                    rowText += cell.textContent.toLowerCase() + ' ';
                });
                
                const dateCell = row.querySelector('td:first-child').textContent;
                const formattedDateCell = formatDateForInput(dateCell);
                const dateMatch = !dateFilter || formattedDateCell === dateFilter;
                const searchMatch = !searchText || rowText.includes(searchText);
                
                row.style.display = (dateMatch && searchMatch) ? '' : 'none';
            });
        }

        function clearMailFilters() {
            document.getElementById('searchMailInput').value = '';
            document.getElementById('mailDateFilter').value = '';
            filterMailTable();
        }

        function printMailTable() {
            window.print();
        }

        function showAddMailForm() {
            if (!isAdmin) {
                alert('Только администратор может добавлять записи');
                return;
            }
            
            document.getElementById('modalMailTitle').textContent = 'Добавить запись в почтовый реестр';
            document.getElementById('editMailIndex').value = '';
            document.getElementById('editMailForm').reset();
            const deleteBtn = document.querySelector('#editMailModal .delete-btn');
            if (deleteBtn) deleteBtn.style.display = 'none';
            document.getElementById('editMailSender').value = 'Сидорченко А.А.';
            document.getElementById('editMailModal').style.display = 'block';
            
            // Инициализируем автозаполнение адреса
            setTimeout(autoFillCounterpartyAddress, 100);
        }

        function editMailRow(index) {
    if (!isAdmin) return;
    
    const item = mailData[index];
    document.getElementById('modalMailTitle').textContent = 'Редактировать запись в почтовый реестр';
    document.getElementById('editMailIndex').value = index;
    document.getElementById('editMailDate').value = formatDateForInput(item.date);
    document.getElementById('editMailSupplier').value = item.supplier || '';
    document.getElementById('editMailDocument').value = item.document || '';
    document.getElementById('editMailSheets').value = item.sheets || '';
    document.getElementById('editMailAddress').value = item.address || '';
    document.getElementById('editMailSender').value = item.sender || 'Сидорченко А.А.';
    
    // Показываем кнопку удаления
    const deleteBtn = document.querySelector('#editMailModal .delete-btn');
    if (deleteBtn) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.onclick = function() { deleteMailRecord(); }
    }
    
    document.getElementById('editMailModal').style.display = 'block';
}

        function saveMailChanges(event) {
            event.preventDefault();
            
            const index = document.getElementById('editMailIndex').value;
            const item = {
                date: formatDateForDisplay(document.getElementById('editMailDate').value),
                supplier: document.getElementById('editMailSupplier').value,
                document: document.getElementById('editMailDocument').value,
                sheets: document.getElementById('editMailSheets').value,
                address: document.getElementById('editMailAddress').value,
                sender: document.getElementById('editMailSender').value,
            };
            
            if (index === '') {
                mailData.push(item);
            } else {
                mailData[index] = item;
            }
            
            saveAllData();
            updateMailTable();
            closeMailModal();
            markChangesMade();
            refreshStatusStatsIfOpen();
        }

        function closeMailModal() {
            document.getElementById('editMailModal').style.display = 'none';
        }

        // ========== ФУНКЦИИ ДЛЯ СТРАНИЦЫ РЕЕСТР ДОВЕРЕННОСТЕЙ ==========
        function updateProxyTable() {
    const tableBody = document.querySelector('#proxyTable tbody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    if (proxyData.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
            <td colspan="8" style="text-align: center; color: #8f98a0; padding: 20px;">
                Нет данных о доверенностях. Добавьте первую доверенность.
            </td>
        `;
        tableBody.appendChild(emptyRow);
        return;
    }
    
    // СОРТИРОВКА ПО ДАТЕ (УБЫВАНИЕ - СНАЧАЛА НОВЫЕ)
    const sortedProxyData = [...proxyData].sort((a, b) => {
        // Извлекаем timestamp из recordId
        const timeA = getTimeFromRecordId(a.recordId) || 0;
        const timeB = getTimeFromRecordId(b.recordId) || 0;
        
        // Сортировка по убыванию (новые сначала)
        return timeB - timeA;
    });
    
    sortedProxyData.forEach((item) => {
        const row = document.createElement('tr');
        
        // Добавляем уникальный ID записи в data-атрибут
        row.dataset.recordId = item.recordId || '';
        
        // Добавляем классы для подсветки в зависимости от статуса
        if (item.status === 'Выполнено') {
            row.classList.add('status-completed');
        }
        
        
        row.innerHTML = `
            <td>${item.date || ''}</td>
            <td>${item.supplier || ''}</td>
            <td>${item.phone || ''}</td>
            <td>${item.contract || ''}</td>
            <td>${item.product || ''}</td>
            <td>${item.address || ''}</td>
            <td>${item.driver || ''}</td>
            <td>${item.status || 'В работе'}</td>
        `;
        
// ВСЕГДА добавляем класс для подсветки
row.classList.add('clickable-row');
if (!isAdmin) {
    row.classList.add('guest-mode');
}

// Только для администратора добавляем обработчик редактирования
if (isAdmin) {
    row.addEventListener('dblclick', function(e) {
        if (!e.target.closest('button') && !e.target.closest('input')) {
            const recordId = e.currentTarget.dataset.recordId;
            
            // Ищем запись по recordId
            const recordIndex = proxyData.findIndex(record => record.recordId === recordId);
            if (recordIndex !== -1) {
                editProxyRow(recordIndex);
            } else {
                // Если не нашли по recordId, пробуем найти по другим параметрам
                const date = e.currentTarget.querySelector('td:nth-child(1)').textContent;
                const supplier = e.currentTarget.querySelector('td:nth-child(2)').textContent;
                const fallbackIndex = proxyData.findIndex(record => 
                    record.date === date && 
                    record.supplier === supplier
                );
                if (fallbackIndex !== -1) {
                    editProxyRow(fallbackIndex);
                }
            }
        }
    });
}
        
        tableBody.appendChild(row);
    });
    
    filterProxyTable();
}

       function filterProxyTable() {
    const searchText = document.getElementById('searchProxyInput').value.toLowerCase();
    const statusFilter = document.getElementById('proxyStatusFilter').value;

    const rows = document.querySelectorAll('#proxyTable tbody tr');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        // Пропускаем строку с сообщением "нет данных" (colspan теперь 8)
        if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
            row.style.display = (searchText || statusFilter) ? 'none' : '';
            if (!searchText && !statusFilter) visibleCount++;
            return;
        }
        
        let rowText = '';
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
            rowText += cell.textContent.toLowerCase() + ' ';
        });
        
        // Статус теперь в 8-й ячейке (индекс 7)
        const statusCell = cells[7] ? cells[7].textContent.trim() : '';
        const statusMatch = !statusFilter || statusCell === statusFilter;
        const searchMatch = !searchText || rowText.includes(searchText);
        
        if (statusMatch && searchMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    if (visibleCount === 0 && (searchText || statusFilter)) {
        const tableBody = document.querySelector('#proxyTable tbody');
        let noDataRow = tableBody.querySelector('tr[data-no-results]');
        if (!noDataRow) {
            noDataRow = document.createElement('tr');
            noDataRow.setAttribute('data-no-results', 'true');
            noDataRow.innerHTML = `
                <td colspan="8" style="text-align: center; color: #8f98a0; padding: 20px;">
                    По вашему запросу ничего не найдено
                </td>
            `;
            tableBody.appendChild(noDataRow);
        }
    } else {
        const noDataRow = document.querySelector('#proxyTable tr[data-no-results]');
        if (noDataRow) noDataRow.remove();
    }
}

        function clearProxyFilters() {
    document.getElementById('searchProxyInput').value = '';
    document.getElementById('proxyStatusFilter').value = '';
    filterProxyTable();
}

        function showAddProxyForm() {
    if (!isAdmin) {
        alert('Только администратор может добавлять доверенности');
        return;
    }
    
    document.getElementById('modalProxyTitle').textContent = 'Добавить доверенность';
    document.getElementById('editProxyIndex').value = '';
    document.getElementById('editProxyForm').reset();
    
    // Устанавливаем статус по умолчанию
    document.getElementById('editProxyStatus').value = 'В работе';
    
    // Устанавливаем сегодняшнюю дату по умолчанию
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('editProxyDate').value = today;
    
    const deleteBtn = document.querySelector('#editProxyModal .delete-btn');
    if (deleteBtn) deleteBtn.style.display = 'none';
    document.getElementById('editProxyModal').style.display = 'block';
    
    // Инициализируем автозаполнение адреса и телефона
    setTimeout(autoFillProxyCounterpartyAddress, 100);
}

        function editProxyRow(index) {
    if (!isAdmin) return;
    
    const item = proxyData[index];
    document.getElementById('modalProxyTitle').textContent = 'Редактировать доверенность';
    document.getElementById('editProxyIndex').value = index;
    document.getElementById('editProxyDate').value = formatDateForInput(item.date);
    document.getElementById('editProxySupplier').value = item.supplier || '';
    document.getElementById('editProxyPhone').value = item.phone || '';
    document.getElementById('editProxyDocument').value = item.contract || '';
    document.getElementById('editProxyProduct').value = item.product || '';
    document.getElementById('editProxyAddress').value = item.address || '';
    document.getElementById('editProxyDriver').value = item.driver || '';
    document.getElementById('editProxyStatus').value = item.status || 'В работе';
    
    const deleteBtn = document.querySelector('#editProxyModal .delete-btn');
    if (deleteBtn) deleteBtn.style.display = 'inline-block';
    document.getElementById('editProxyModal').style.display = 'block';
    
    // Инициализируем автозаполнение адреса и телефона
    setTimeout(autoFillProxyCounterpartyAddress, 100);
}
        function saveProxyChanges(event) {
    event.preventDefault();
    
    const index = document.getElementById('editProxyIndex').value;
    const recordId = document.getElementById('editProxyIndex').value ? 
        proxyData[index]?.recordId || generateUniqueId() : 
        generateUniqueId();
    
    const item = {
        recordId: recordId,
        date: formatDateForDisplay(document.getElementById('editProxyDate').value),
        supplier: document.getElementById('editProxySupplier').value,
        phone: document.getElementById('editProxyPhone').value,
        contract: document.getElementById('editProxyDocument').value,
        product: document.getElementById('editProxyProduct').value,
        address: document.getElementById('editProxyAddress').value,
        driver: document.getElementById('editProxyDriver').value,
        status: document.getElementById('editProxyStatus').value || 'В работе'
    };
    
    if (index === '') {
        proxyData.push(item);
    } else {
        proxyData[index] = item;
    }
    
    // Сортируем доверенности по убыванию даты после сохранения
    proxyData.sort((a, b) => {
        const timeA = getTimeFromRecordId(a.recordId) || 0;
        const timeB = getTimeFromRecordId(b.recordId) || 0;
        return timeB - timeA;
    });
    
    saveAllData();
    updateProxyTable();
    closeProxyModal();
    markChangesMade();
    refreshStatusStatsIfOpen();
}

        function closeProxyModal() {
            document.getElementById('editProxyModal').style.display = 'none';
        }

        // ========== ФУНКЦИИ ДЛЯ МЕНЮ НАСТРОЕК ==========
function toggleSettingsMenu() {
    const settingsMenu = document.getElementById('settingsMenu');
    const settingsButton = document.getElementById('settingsButton');
    
    if (settingsMenu.classList.contains('show')) {
        // Закрываем меню
        settingsMenu.classList.remove('show');
        settingsButton.classList.remove('active');
        setTimeout(() => {
            settingsMenu.style.display = 'none';
        }, 300);
    } else {
        // Открываем меню
        settingsMenu.style.display = 'flex';
        
        if (isAdmin) {
            // Для администратора показываем все кнопки
            const adminButtons = settingsMenu.querySelectorAll('.admin-only');
            adminButtons.forEach(btn => {
                btn.style.display = 'flex';
            });
            
            const importBtn = settingsMenu.querySelector('.import-btn');
            if (importBtn) importBtn.style.display = 'flex';
        } else {
            // Для гостя показываем только кнопку импорта
            const adminButtons = settingsMenu.querySelectorAll('.admin-only');
            adminButtons.forEach(btn => {
                btn.style.display = 'none';
            });
            
            const importBtn = settingsMenu.querySelector('.import-btn');
            if (importBtn) importBtn.style.display = 'flex';
        }
        
        setTimeout(() => {
            settingsMenu.classList.add('show');
            settingsButton.classList.add('active');
        }, 10);
    }
}
function closeSettingsMenu() {
    const settingsMenu = document.getElementById('settingsMenu');
    const settingsButton = document.getElementById('settingsButton');
    
    settingsMenu.classList.remove('show');
    settingsButton.classList.remove('active');
    setTimeout(() => {
        settingsMenu.style.display = 'none';
        
        // Восстанавливаем отображение кнопок в зависимости от режима
        if (isAdmin) {
            // Для администратора показываем все кнопки
            const adminButtons = settingsMenu.querySelectorAll('.admin-only');
            adminButtons.forEach(btn => {
                btn.style.display = 'flex';
            });
        } else {
            // Для гостя показываем только кнопку импорта
            const importBtn = settingsMenu.querySelector('.import-btn');
            if (importBtn) importBtn.style.display = 'flex';
            
            // Скрываем административные кнопки
            const adminButtons = settingsMenu.querySelectorAll('.admin-only');
            adminButtons.forEach(btn => {
                btn.style.display = 'none';
            });
        }
    }, 300);
}
// Закрытие меню при клике вне его области
document.addEventListener('click', function(event) {
    const settingsMenu = document.getElementById('settingsMenu');
    const settingsButton = document.getElementById('settingsButton');
    
    if (settingsMenu && settingsMenu.classList.contains('show')) {
        const isClickInsideMenu = settingsMenu.contains(event.target);
        const isClickOnButton = settingsButton.contains(event.target);
        
        if (!isClickInsideMenu && !isClickOnButton) {
            closeSettingsMenu();
        }
    }
});
        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
        function updateSuppliersList() {
    const datalist = document.getElementById('suppliersList');
    const filterDatalist = document.getElementById('suppliersListFilter');
    
    if (!datalist || !filterDatalist) return;
    
    // Очищаем списки
    datalist.innerHTML = '';
    filterDatalist.innerHTML = '';
    
    // Собираем уникальных поставщиков из разных источников
    const suppliers = new Set();
    
    // Из контрагентов
    counterpartiesData.forEach(item => {
        if (item.supplier && item.supplier.trim()) {
            suppliers.add(item.supplier.trim());
        }
    });
    
    // Из учета закупок
    accountingData.forEach(item => {
        if (item.supplier && item.supplier.trim()) {
            suppliers.add(item.supplier.trim());
        }
    });
    
    // Сортируем по алфавиту
    const sortedSuppliers = Array.from(suppliers).sort((a, b) => 
        a.localeCompare(b, 'ru', { sensitivity: 'base' })
    );
    
    // Заполняем оба datalist
    sortedSuppliers.forEach(supplier => {
        const option1 = document.createElement('option');
        option1.value = supplier;
        datalist.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = supplier;
        filterDatalist.appendChild(option2);
    });
}
        function updateApplicationsList() {
            const datalist = document.getElementById('applicationsList');
            const filterDatalist = document.getElementById('applicationsListFilter');
            
            if (!datalist || !filterDatalist) return;
            
            datalist.innerHTML = '';
            filterDatalist.innerHTML = '';
            
            const applications = [...new Set(accountingData.map(item => item.docNumber))];
            
            applications.forEach(app => {
                if (app) {
                    const option = document.createElement('option');
                    option.value = app;
                    datalist.appendChild(option);
                    
                    const filterOption = document.createElement('option');
                    filterOption.value = app;
                    filterDatalist.appendChild(filterOption);
                }
            });
        }
function updateDepartmentsFilter() {
    const departmentFilter = document.getElementById('departmentFilter');
    const departmentsListFilter = document.getElementById('departmentsListFilter');
    const departmentsListDatalist = document.getElementById('departmentsList');
    
    if (!departmentsListFilter || !departmentsListDatalist) return;
    
    // Очищаем datalist
    departmentsListFilter.innerHTML = '<option value="">Все подразделения</option>';
    departmentsListDatalist.innerHTML = '';
    
    // Добавляем подразделения в datalist
    departmentsList.forEach(dept => {
        if (dept) {
            // Для фильтра
            const filterOption = document.createElement('option');
            filterOption.value = dept;
            filterOption.textContent = dept;
            departmentsListFilter.appendChild(filterOption);
            
            // Для модального окна
            const modalOption = document.createElement('option');
            modalOption.value = dept;
            modalOption.textContent = dept;
            departmentsListDatalist.appendChild(modalOption);
        }
    });
}        
function parseDate(dateString) {
            if (!dateString || dateString.trim() === '') return null;
            
            // Формат DD.MM.YYYY
            if (dateString.includes('.')) {
                const parts = dateString.split('.');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    
                    if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                        return new Date(year, month, day);
                    }
                }
            }
            
            // Формат YYYY-MM-DD (для input type="date")
            if (dateString.includes('-')) {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }
            
            return null;
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            
            // Если дата в формате YYYY-MM-DD (из input type="date")
            if (dateString.includes('-')) {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}.${month}.${year}`;
                }
            }
            
            // Если дата уже в формате DD.MM.YYYY, возвращаем как есть
            return dateString;
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            
            // Если дата уже в формате YYYY-MM-DD, возвращаем как есть
            if (dateString.includes('-')) {
                return dateString;
            }
            
            // Конвертируем из формата DD.MM.YYYY в YYYY-MM-DD
            if (dateString.includes('.')) {
                const parts = dateString.split('.');
                if (parts.length === 3) {
                    const day = parts[0].padStart(2, '0');
                    const month = parts[1].padStart(2, '0');
                    const year = parts[2];
                    return `${year}-${month}-${day}`;
                }
            }
            
            return dateString;
        }

        function escapeString(str) {
            if (!str) return '';
            return str.replace(/'/g, "&#39;").replace(/"/g, "&quot;").replace(/\n/g, " ");
        }

        // ========== ФУНКЦИИ БЫСТРЫХ ФИЛЬТРОВ ==========
        function updateQuickFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const departmentFilter = document.getElementById('departmentFilter').value;
    const supplierFilter = document.getElementById('supplierFilter').value;
    const quickFiltersContainer = document.getElementById('quickApplicationFilters');
    
    if (!quickFiltersContainer) {
        console.error('Контейнер быстрых фильтров не найден');
        return;
    }
    
    // Очищаем контейнер
    quickFiltersContainer.innerHTML = '';
    
    // УСЛОВИЯ СКРЫТИЯ БЫСТРЫХ ФИЛЬТРОВ:
    // 1. Если статус не выбран или статус "Выполнено", "Приход" (убрали "Иное")
    // 2. Если заполнен фильтр по подразделению
    // 3. Если заполнен фильтр по поставщику
    if (!statusFilter || 
        statusFilter === 'Выполнено' || 
        statusFilter === 'Приход' ||  // Убрали "Иное" отсюда
        departmentFilter.trim() !== '' ||
        supplierFilter.trim() !== '') {
        
        quickFiltersContainer.style.display = 'none';
        return;
    }
    
    // Проверяем наличие данных
    if (!accountingData || accountingData.length === 0) {
        quickFiltersContainer.innerHTML = '<span style="color: #8f98a0; font-style: italic;">Нет данных для фильтрации</span>';
        quickFiltersContainer.style.display = 'flex';
        return;
    }
    
    const applicationsWithStatus = new Set();
    
    // Собираем уникальные номера заявок с выбранным статусом
    accountingData.forEach(item => {
        if (item.docNumber && item.status === statusFilter) {
            applicationsWithStatus.add(item.docNumber);
        }
    });
    
    // Если нет заявок с выбранным статусом
    if (applicationsWithStatus.size === 0) {
        quickFiltersContainer.innerHTML = '<span style="color: #8f98a0; font-style: italic;">Нет заявок с выбранным статусом</span>';
        quickFiltersContainer.style.display = 'flex';
        return;
    }
    
    // Создаем контейнер для заголовка
    const label = document.createElement('div');
    label.className = 'quick-filters-label';
    label.textContent = 'Заявки:';
    quickFiltersContainer.appendChild(label);
    
    // Создаем контейнер для кнопок фильтров
    const filtersContainer = document.createElement('div');
    filtersContainer.className = 'quick-filters';
    
    // Преобразуем Set в массив и сортируем
    const sortedApplications = Array.from(applicationsWithStatus).sort((a, b) => {
        const numA = parseInt(a.replace(/\D/g, '')) || 0;
        const numB = parseInt(b.replace(/\D/g, '')) || 0;
        return numA - numB;
    });
    
    // Создаем кнопки для каждой заявки
    sortedApplications.forEach(app => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = `quick-filter-btn status-${getStatusClass(statusFilter)}`;
        button.textContent = app;
        button.title = `Показать заявку ${app} (статус: ${statusFilter})`;
        
        button.onclick = () => {
            // Удаляем активный класс со всех кнопок
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Добавляем активный класс текущей кнопке
            button.classList.add('active');
            
            // Устанавливаем фильтры
            document.getElementById('applicationFilter').value = app;
            document.getElementById('statusFilter').value = statusFilter;
            
            // Применяем фильтрацию
            filterByApplicationAndStatus(app, statusFilter);
        };
        
        filtersContainer.appendChild(button);
    });
    
    quickFiltersContainer.appendChild(filtersContainer);
    quickFiltersContainer.style.display = 'flex';
}

        function getStatusClass(status) {
    const statusClasses = {
        'В работе': 'working',
        'Поставка': 'supply',
        'Приход': 'receipt',
        'Выполнено': 'completed',
        'Иное': 'other'
    };
    return statusClasses[status] || 'other';
}

        function filterByApplicationAndStatus(applicationNumber, status) {
    const searchText = document.getElementById('searchAccountingInput').value.toLowerCase();
    const rows = document.querySelectorAll('#accountingTable tbody tr');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        // Пропускаем строку с сообщением "нет данных"
        if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
            row.style.display = 'none';
            return;
        }
        
        const cells = row.querySelectorAll('td');
        if (cells.length < 4) {
            row.style.display = 'none';
            return;
        }
        // Показываем блок комментариев при выборе заявки
    const commentBlock = document.querySelector('.comment-control');
    if (commentBlock && applicationNumber) {
        commentBlock.classList.remove('hidden');
        }
        const appCell = cells[1] ? cells[1].textContent.trim() : '';
        const statusCell = cells[2] ? cells[2].textContent : '';
        
        let rowText = '';
        cells.forEach(cell => {
            rowText += cell.textContent.toLowerCase() + ' ';
        });
        
        const appMatch = appCell === applicationNumber;
        const statusMatch = status ? (statusCell === status) : true;
        const searchMatch = !searchText || rowText.includes(searchText);
        
        if (appMatch && statusMatch && searchMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Показываем сообщение, если нет видимых строк
    if (visibleCount === 0 && (searchText || applicationNumber || status)) {
        const tableBody = document.querySelector('#accountingTable tbody');
        let noDataRow = tableBody.querySelector('tr[data-no-results]');
        
        if (!noDataRow) {
            noDataRow = document.createElement('tr');
            noDataRow.setAttribute('data-no-results', 'true');
            noDataRow.innerHTML = `
                <td colspan="20" style="text-align: center; color: #8f98a0; padding: 20px;">
                    По вашему запросу ничего не найдено
                </td>
            `;
            tableBody.appendChild(noDataRow);
        }
    } else {
        const noDataRow = document.querySelector('#accountingTable tr[data-no-results]');
        if (noDataRow) {
            noDataRow.remove();
        }
    }
    
    // Устанавливаем значения в поля фильтров
    document.getElementById('applicationFilter').value = applicationNumber;
    document.getElementById('statusFilter').value = status;
    
    updateCommentField();
    updateCommentBlockVisibility();
}

        function clearQuickFilters() {
            const quickFiltersContainer = document.getElementById('quickApplicationFilters');
            if (quickFiltersContainer) {
                quickFiltersContainer.innerHTML = '<span style="color: #8f98a0; font-style: italic;">Выберите статус чтобы увидеть заявки</span>';
            }
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function handleStatusChange() {
    const status = document.getElementById('statusFilter').value;
    
    // Обновляем быстрые фильтры
    updateQuickFilters();
    
    // Применяем фильтрацию
    const applicationFilter = document.getElementById('applicationFilter').value;
    const supplierFilter = document.getElementById('supplierFilter').value;
    
    if (applicationFilter && status) {
        filterByApplicationAndStatus(applicationFilter, status);
    } else {
        filterAccountingTable();
    }
}

        // ========== ФУНКЦИИ КОММЕНТАРИЕВ ==========
        function saveApplicationComment() {
    // Проверка прав администратора
    if (!isAdmin) {
        showAutosaveNotification('Только администратор может изменять комментарии');
        return;
    }
    
    const application = document.getElementById('applicationFilter').value.trim();
    const comment = document.getElementById('applicationComment').value;
    
    if (application) {
        // Очищаем комментарий от лишних пробелов в начале и конце
        const cleanComment = comment.trim();
        
        // Обновляем поле ввода
        document.getElementById('applicationComment').value = cleanComment;
        
        applicationComments[application] = cleanComment;
        localStorage.setItem('applicationComments', JSON.stringify(applicationComments));
        showAutosaveNotification('Комментарий сохранен');
        updateApplicationCommentsAnalytics();
    }
}

        function updateCommentField() {
            const application = document.getElementById('applicationFilter').value;
            const commentInput = document.getElementById('applicationComment');
            
            if (commentInput) {
                commentInput.value = applicationComments[application] || '';
            }
            updateCommentBlockVisibility();
        }

// ========== ФУНКЦИЯ ДЛЯ УПРАВЛЕНИЯ ВИДИМОСТЬЮ БЛОКА КОММЕНТАРИЕВ ==========
function updateCommentBlockVisibility() {
    const commentBlock = document.querySelector('.comment-control');
    const applicationFilter = document.getElementById('applicationFilter');
    // Получаем список всех возможных заявок (он находится в datalist)
    const datalist = document.getElementById('applicationsListFilter');
    
    if (!commentBlock || !applicationFilter) return;
    
    const currentValue = applicationFilter.value.trim();
    let isValidSelection = false;

    // ПРОВЕРКА 1: Совпадает ли введенное значение с одной из заявок в списке?
    if (datalist && currentValue !== '') {
        // Пробегаем по всем опциям списка
        for (let i = 0; i < datalist.options.length; i++) {
            if (datalist.options[i].value === currentValue) {
                isValidSelection = true;
                break; // Нашли совпадение, выходим из цикла
            }
        }
    }

    // ПРОВЕРКА 2: Нажат ли быстрый фильтр?
    const activeQuickBtn = document.querySelector('.quick-filter-btn.active');
    
    // Показываем ТОЛЬКО если есть совпадение со списком ИЛИ активен быстрый фильтр
    if (isValidSelection || activeQuickBtn) {
        commentBlock.classList.remove('hidden');
        commentBlock.style.display = 'flex';
    } else {
        commentBlock.classList.add('hidden');
        commentBlock.style.display = 'none';
    }
}
  


// ========== ФУНКЦИЯ ОБНОВЛЕНИЯ ДОСТУПА К КОММЕНТАРИЯМ ==========
function updateCommentFieldPermissions() {
    const commentInput = document.getElementById('applicationComment');
    const commentButton = document.getElementById('saveCommentBtn');
    
    if (!commentInput || !commentButton) return;
    
    if (isAdmin) {
        commentInput.removeAttribute('readonly');
        commentInput.removeAttribute('disabled');
        commentButton.removeAttribute('disabled');
        commentInput.style.backgroundColor = '#2a475e';
        commentInput.style.color = '#ffd700';
        commentInput.style.fontWeight = 'bold';
        commentInput.placeholder = 'Комментарий к заявке...';
    } else {
        // Для гостя: те же цвета, но недоступно для редактирования
        commentInput.setAttribute('readonly', 'true');
        commentInput.setAttribute('disabled', 'true');
        commentButton.setAttribute('disabled', 'true');
        commentInput.style.backgroundColor = '#2a475e'; // Тот же фон что и у админа
        commentInput.style.color = '#ffd700'; // Тот же жёлтый цвет что и у админа
        commentInput.style.fontWeight = 'bold'; // Та же жирность шрифта
        commentInput.placeholder = 'Комментарии (только просмотр)';
    }
}
        // ========== ФУНКЦИИ УДАЛЕНИЯ ЗАПИСЕЙ ==========
        function deleteAccountingRecord() {
    if (!isAdmin) {
        alert('Только администратор может удалять записи');
        return;
    }
    
    const recordId = document.getElementById('editAccountingRecordId').value;
    
    if (!recordId) {
        alert('Нельзя удалить новую запись');
        return;
    }
    
    if (confirm('Вы уверены, что хотите удалить эту запись?')) {
        // Ищем по recordId вместо индекса
        const index = accountingData.findIndex(item => item.recordId === recordId);
        if (index !== -1) {
            accountingData.splice(index, 1);
            saveAllData();
            updateAccountingTable();
            updateQuickFilters();
            updateYearsFilter();
            filterAccountingTable();
            closeAccountingModal();
            markChangesMade();
            updateAccountingBadge();
            updateOverdueButton();
            updateSuppliersFilterList();
            refreshStatusStatsIfOpen();
        }
    }
}

        function deleteCounterpartyRecord() {
    const index = document.getElementById('editCounterpartyIndex').value;
    
    if (index === '') {
        alert('Нельзя удалить нового контрагента');
        return;
    }
    
    if (confirm('Вы уверены, что хотите удалить этого контрагента?')) {
        counterpartiesData.splice(index, 1);
        
        // Обновляем таблицу после удаления
        saveAllData();
        updateCounterpartiesTable();
        updateSuppliersList();
        closeCounterpartyModal();
        markChangesMade();
    }
}

        function deleteSettlementRecord() {
            const index = document.getElementById('editSettlementIndex').value;
            
            if (index === '') {
                alert('Нельзя удалить новую запись');
                return;
            }
            
            if (confirm('Вы уверены, что хотите удалить эту запись?')) {
                settlementData.splice(index, 1);
                saveAllData();
                updateSettlementTable();
                closeSettlementModal();
                markChangesMade();
            }
        }

        function deleteMailRecord() {
    if (!isAdmin) {
        alert('Только администратор может удалять записи');
        return;
    }
    
    const index = document.getElementById('editMailIndex').value;
    
    if (index === '' || index === undefined) {
        alert('Нельзя удалить новую запись');
        return;
    }
    
    if (confirm('Вы уверены, что хотите удалить эту запись?')) {
        mailData.splice(index, 1);
        
        // Обновляем таблицу после удаления
        saveAllData();
        updateMailTable();
        closeMailModal();
        markChangesMade();
        refreshStatusStatsIfOpen();
    }
}
function refreshStatusStatsIfOpen() {
    const modal = document.getElementById('statusStatsModal');
    if (modal && modal.style.display === 'block') {
        initializeStatsYearFilter();
        calculateStatusStats();
    }
}       
function deleteProxyRecord() {
    const index = document.getElementById('editProxyIndex').value;
    
    if (index === '') {
        alert('Нельзя удалить новую доверенность');
        return;
    }
    
    if (confirm('Вы уверены, что хотите удалить эту доверенность?')) {
        proxyData.splice(index, 1);
        
        // Обновляем таблицу после удаления
        saveAllData();
        updateProxyTable();
        updateContractsList(); 
        closeProxyModal();
        markChangesMade();
        refreshStatusStatsIfOpen();
    }
}

        // ========== ФУНКЦИИ ИЗМЕНЕНИЯ ШИРИНЫ СТОЛБЦОВ ==========
        function initColumnResize() {
            // Инициализируем для всех видимых таблиц
            const tables = document.querySelectorAll('table');
            
            tables.forEach(table => {
                if (table.offsetParent !== null) { // Проверяем, что таблица видима
                    const headers = table.querySelectorAll('th');
                    
                    headers.forEach(header => {
                        const resizeHandle = header.querySelector('.resize-handle');
                        if (!resizeHandle) return;
                        
                        // Удаляем старые обработчики (если есть)
                        const newHandle = resizeHandle.cloneNode(true);
                        resizeHandle.replaceWith(newHandle);
                        
                        newHandle.addEventListener('mousedown', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            startResizing(header, e, table);
                        });
                    });
                }
            });
        }

        function startResizing(header, e, table) {
            resizingColumn = header;
            startX = e.clientX;
            startWidth = parseInt(document.defaultView.getComputedStyle(header).width, 10);
            currentTable = table;
            
            document.body.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        }

        function handleResize(e) {
            if (!resizingColumn || !currentTable) return;
            
            const dx = e.clientX - startX;
            const newWidth = Math.max(50, startWidth + dx);
            
            resizingColumn.style.width = newWidth + 'px';
            
            // Обновляем ширину в текущей таблице
            const colIndex = Array.from(resizingColumn.parentNode.children).indexOf(resizingColumn);
            const rows = currentTable.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td, th');
                if (cells[colIndex]) {
                    cells[colIndex].style.width = newWidth + 'px';
                }
            });
        }

        function stopResizing() {
            if (!resizingColumn) return;
            
            document.body.classList.remove('resizing');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            resizingColumn = null;
            currentTable = null;
            
            // Сохраняем новые ширины в localStorage
            saveColumnWidths();
            markChangesMade();
        }

        function saveColumnWidths() {
            const tables = {
                'accounting': document.querySelector('#accountingTable'),
                'counterparties': document.querySelector('#counterpartiesTable'),
                'settlement': document.querySelector('#settlementTable'),
                'mail': document.querySelector('#mailTable'),
                'proxy': document.querySelector('#proxyTable')
            };
            
            const allWidths = {};
            
            Object.keys(tables).forEach(tableName => {
                const table = tables[tableName];
                if (!table) return;
                
                const headers = table.querySelectorAll('thead th');
                const widths = [];
                
                headers.forEach(header => {
                    widths.push(header.style.width || '');
                });
                
                allWidths[tableName] = widths;
            });
            
            localStorage.setItem('tableColumnWidths', JSON.stringify(allWidths));
        }

        function loadColumnWidths() {
            const savedWidths = localStorage.getItem('tableColumnWidths');
            if (!savedWidths) return;
            
            try {
                const allWidths = JSON.parse(savedWidths);
                
                Object.keys(allWidths).forEach(tableName => {
                    const tableSelector = `#${tableName}Table`;
                    const table = document.querySelector(tableSelector);
                    if (!table) return;
                    
                    const widths = allWidths[tableName];
                    const headers = table.querySelectorAll('thead th');
                    const rows = table.querySelectorAll('tbody tr');
                    
                    headers.forEach((header, index) => {
                        if (widths[index] && widths[index] !== '') {
                            header.style.width = widths[index];
                            
                            // Применяем ко всем ячейкам в столбце
                            rows.forEach(row => {
                                const cells = row.querySelectorAll('td');
                                if (cells[index]) {
                                    cells[index].style.width = widths[index];
                                }
                            });
                        }
                    });
                });
            } catch (error) {
                console.error('Ошибка загрузки ширины столбцов:', error);
            }
        }

 

        function calculateMonthlyStats() {
    const monthlyStats = {};
    const currentYear = new Date().getFullYear();
    
    accountingData.forEach(item => {
        // Пытаемся извлечь дату из номера заявки
        let date = extractDateFromDocNumber(item.docNumber);
        
        // Если дата найдена и это текущий год
        if (date && !isNaN(date.getTime())) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            
            // Учитываем только текущий год
            if (year === currentYear) {
                const monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                const monthName = getMonthName(month);
                
                if (!monthlyStats[monthKey]) {
                    monthlyStats[monthKey] = {
                        count: 0,
                        name: monthName
                    };
                }
                
                monthlyStats[monthKey].count++;
            }
        }
    });
    
    // Преобразуем в простой объект для графика
    const result = {};
    Object.keys(monthlyStats).sort().forEach(monthKey => {
        result[monthlyStats[monthKey].name] = monthlyStats[monthKey].count;
    });
    
    return result;
}

        function extractDateFromDocNumber(docNumber) {
    if (!docNumber) return null;
    
    // Приводим к строке и очищаем
    const cleanDocNumber = String(docNumber).trim();
    
    // Ищем даты в разных форматах внутри номера заявки
    // 1. Формат с префиксом и датой (например: "ЗАП-2024-12-25")
    // 2. Формат с датой в конце (например: "123-456-01.12.2024")
    // 3. Различные комбинации
    
    const datePatterns = [
        // Формат DD.MM.YYYY в любом месте
        /\b(\d{1,2})\.(\d{1,2})\.(\d{4})\b/,
        // Формат DD-MM-YYYY в любом месте
        /\b(\d{1,2})-(\d{1,2})-(\d{4})\b/,
        // Формат YYYY-MM-DD в любом месте
        /\b(\d{4})-(\d{1,2})-(\d{1,2})\b/,
        // Формат DD/MM/YYYY в любом месте
        /\b(\d{1,2})\/(\d{1,2})\/(\d{4})\b/,
        // Формат без разделителей (например, 01012024)
        /\b(\d{2})(\d{2})(\d{4})\b/,
        // Формат с русскими буквами и датой (например, "Заявка от 25.12.2024")
        /от\s+(\d{1,2})\.(\d{1,2})\.(\d{4})/i,
        // Формат с номером и датой (например, "№123 от 25.12.2024")
        /№?\s*\d+\s+от\s+(\d{1,2})\.(\d{1,2})\.(\d{4})/i
    ];
    
    for (const pattern of datePatterns) {
        const match = cleanDocNumber.match(pattern);
        if (match) {
            let day, month, year;
            
            // Определяем порядок компонентов даты в зависимости от формата
            if (pattern === /\b(\d{4})-(\d{1,2})-(\d{1,2})\b/) {
                // Формат YYYY-MM-DD
                year = parseInt(match[1]);
                month = parseInt(match[2]);
                day = parseInt(match[3]);
            } else if (pattern === /\b(\d{2})(\d{2})(\d{4})\b/) {
                // Формат без разделителей
                day = parseInt(match[1]);
                month = parseInt(match[2]);
                year = parseInt(match[3]);
            } else if (pattern === /от\s+(\d{1,2})\.(\d{1,2})\.(\d{4})/i || 
                       pattern === /№?\s*\d+\s+от\s+(\d{1,2})\.(\d{1,2})\.(\d{4})/i) {
                // Форматы с "от" (например, "от 25.12.2024")
                day = parseInt(match[1]);
                month = parseInt(match[2]);
                year = parseInt(match[3]);
            } else {
                // Форматы DD.MM.YYYY, DD-MM-YYYY, DD/MM/YYYY
                day = parseInt(match[1]);
                month = parseInt(match[2]);
                year = parseInt(match[3]);
            }
            
            // Проверяем валидность даты
            if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 2000 && year <= 2100) {
                const date = new Date(year, month - 1, day);
                if (!isNaN(date.getTime()) && 
                    date.getDate() === day && 
                    date.getMonth() === month - 1 && 
                    date.getFullYear() === year) {
                    return date;
                }
            }
        }
    }
    
    return null;
}

        function getMonthName(monthNumber) {
            const months = [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];
            return months[monthNumber - 1] || 'Неизвестно';
        }

        function getMostActiveMonth(monthlyStats) {
    if (Object.keys(monthlyStats).length === 0) return 'Нет данных';
    
    let maxCount = 0;
    let mostActiveMonth = '';
    
    Object.keys(monthlyStats).forEach(monthName => {
        if (monthlyStats[monthName] > maxCount) {
            maxCount = monthlyStats[monthName];
            mostActiveMonth = monthName;
        }
    });
    
    return mostActiveMonth || 'Нет данных';
}

        function renderMonthlyChart(monthlyStats) {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx || !window.Chart) return;
            
            // Уничтожаем предыдущий график, если он существует
            if (analyticsCharts.monthlyChart) {
                analyticsCharts.monthlyChart.destroy();
            }
            
            const months = Object.keys(monthlyStats);
            const counts = Object.values(monthlyStats);
            
            // Создаем градиент для графика
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(102, 192, 244, 0.6)');
            gradient.addColorStop(1, 'rgba(102, 192, 244, 0.1)');
            
            analyticsCharts.monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: '',
                        data: counts,
                        backgroundColor: gradient,
                        borderColor: '#66c0f4',
                        borderWidth: 2,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            backgroundColor: 'rgba(27, 40, 56, 0.9)',
                            titleColor: '#66c0f4',
                            bodyColor: '#c7d5e0',
                            borderColor: '#3d4450',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Позиций: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#c7d5e0',
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: '#3d4450'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#c7d5e0',
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: '#3d4450'
                            }
                        }
                    }
                }
            });
        }

        function renderAllCharts() {
            // Дополнительные графики можно добавить здесь
        }

        // функция для применения стилей к таблицам аналитики
        function applyAnalyticsTableStyles() {
    setTimeout(() => {
        const tables = [
            '#weeklyDeliveriesTable table',
            '#weeklyPaymentsTable table', 
            '#overdueTable table'
        ];
        
        tables.forEach(selector => {
            const table = document.querySelector(selector);
            if (table) {
                table.style.tableLayout = 'fixed';
                table.style.width = '100%';
                
                // Применяем одинаковые стили ко всем ячейкам
                const cells = table.querySelectorAll('th, td');
                cells.forEach(cell => {
                    cell.style.padding = '6px 8px';
                    cell.style.border = '1px solid #3d4450';
                    cell.style.wordWrap = 'break-word';
                    cell.style.overflow = 'hidden';
                    cell.style.textOverflow = 'ellipsis';
                });
                
                // Инициализируем изменение ширины
                initAnalyticsTableResize(selector);
            }
        });
    }, 100);
}

        // ========== ФУНКЦИИ ДЛЯ БЛОКА ИНФОРМАЦИИ ПО ПОСТАВЩИКУ ==========
        function initializeSupplierAnalytics() {
            updateAnalyticsSuppliersList();
            
            const supplierSelect = document.getElementById('analyticsSupplierSelect');
            if (supplierSelect) {
                supplierSelect.addEventListener('input', function() {
                    updateSupplierAnalytics();
                });
            }
        }

        function updateAnalyticsSuppliersList() {
            const datalist = document.getElementById('analyticsSuppliersList');
            if (!datalist) return;
            
            datalist.innerHTML = '';
            
            // Добавляем контрагентов из базы данных
            counterpartiesData.forEach(item => {
                if (item.supplier && item.supplier.trim() !== '') {
                    const option = document.createElement('option');
                    option.value = item.supplier;
                    datalist.appendChild(option);
                }
            });
            
            // Показываем сообщение, если контрагентов нет
            const noSupplierSelected = document.getElementById('noSupplierSelected');
            const supplierAnalyticsContent = document.getElementById('supplierAnalyticsContent');
            
            if (noSupplierSelected && supplierAnalyticsContent) {
                if (counterpartiesData.length === 0) {
                    noSupplierSelected.style.display = 'block';
                    supplierAnalyticsContent.style.display = 'none';
                    noSupplierSelected.textContent = 'В базе нет контрагентов. Добавьте контрагентов на странице "Контрагенты".';
                } else {
                    noSupplierSelected.style.display = 'block';
                    supplierAnalyticsContent.style.display = 'none';
                    noSupplierSelected.textContent = 'Выберите поставщика для просмотра аналитики';
                }
            }
        }

        function updateSupplierAnalytics() {
            const supplierName = document.getElementById('analyticsSupplierSelect').value.trim();
            const noSupplierSelected = document.getElementById('noSupplierSelected');
            const supplierAnalyticsContent = document.getElementById('supplierAnalyticsContent');
            
            if (!supplierName) {
                if (noSupplierSelected) noSupplierSelected.style.display = 'block';
                if (supplierAnalyticsContent) supplierAnalyticsContent.style.display = 'none';
                return;
            }
            
            // Ищем контрагента в базе
            const counterparty = counterpartiesData.find(item => 
                item.supplier && item.supplier.trim() === supplierName
            );
            
            if (!counterparty) {
                if (noSupplierSelected) {
                    noSupplierSelected.style.display = 'block';
                    noSupplierSelected.textContent = 'Контрагент не найден в базе';
                }
                if (supplierAnalyticsContent) supplierAnalyticsContent.style.display = 'none';
                return;
            }
            
            // Считаем статистику по поставщику
            const supplierAccounting = accountingData.filter(item => 
                item.supplier && item.supplier.trim() === supplierName
            );
            
            const supplierSettlement = settlementData.filter(item => 
                item.supplier && item.supplier.trim() === supplierName
            );
            
            // Обновляем статистику
            document.getElementById('supplierPositionsCount').textContent = supplierAccounting.length;
            
            const totalAmount = supplierAccounting.reduce((sum, item) => {
                const amount = parseFloat(item.amount?.replace(/[^\d.,]/g, '')?.replace(',', '.')) || 0;
                return sum + amount;
            }, 0);
            
            document.getElementById('supplierTotalAmount').textContent = totalAmount.toLocaleString('ru-RU') + ' руб.';
            
            const percentage = accountingData.length > 0 ? 
                ((supplierAccounting.length / accountingData.length) * 100).toFixed(1) : '0';
            document.getElementById('supplierPercentage').textContent = percentage + '%';
            
            document.getElementById('supplierSettlementCount').textContent = supplierSettlement.length;
            
            // Показываем контент
            if (noSupplierSelected) noSupplierSelected.style.display = 'none';
            if (supplierAnalyticsContent) supplierAnalyticsContent.style.display = 'block';
        }

        // ========== ФУНКЦИИ ИМПОРТА/ЭКСПОРТА ==========
        function exportJSON() {
    closeSettingsMenu();
    
    // Проверяем права администратора
    if (!isAdmin) {
        alert('Только администратор может экспортировать данные');
        return;
    }
    
    const allData = {
        accountingData: accountingData.map(item => ({
            recordId: item.recordId || generateUniqueId(), // Сохраняем или генерируем recordId
            docNumber: item.docNumber || '',
            status: item.status || '',
            id: item.id || '',
            name: item.name || '',
            quantity: item.quantity || '',
            unit: item.unit || '',
            purchaseName: item.purchaseName || '',
            purchaseQuantity: item.purchaseQuantity || '',
            purchaseUnit: item.purchaseUnit || '',
            amount: item.amount || '',
            supplier: item.supplier || '',
            department: item.department || '',
            contract: item.contract || '',
            paymentTerms: item.paymentTerms || '',
            deliveryDays: item.deliveryDays || '',
            deliveryTerms: item.deliveryTerms || '',
            date: item.date || '',
            planFact: item.planFact || item.plan || '',
            fact: item.fact || '',
            shipmentDoc: item.shipmentDoc || ''
        })),
        counterpartiesData: counterpartiesData.map(item => ({
            recordId: item.recordId || generateUniqueId(),
            supplier: item.supplier || '',
            inn: item.inn || '',
            phone: item.phone || '',
            contact: item.contact || '',
            email: item.email || '',
            address: item.address || '',
            material: item.material || '',
            blacklisted: item.blacklisted || false,
            blacklistComment: item.blacklistComment || ''
        })),
        paymentsData: paymentsData.map(item => ({
            recordId: item.recordId || generateUniqueId(),
            status: item.status || '',
            date: item.date || '',
            amount: item.amount || '',
            supplier: item.supplier || '',
            contract: item.contract || '',
            link: item.link || ''
        })),
        settlementData: settlementData.map(item => ({
            recordId: item.recordId || generateUniqueId(),
            note: item.note || '',
            status: item.status || '',
            supplier: item.supplier || '',
            remark: item.remark || '',
            outgoing: item.outgoing || '',
            incoming: item.incoming || ''
        })),
        mailData: mailData.map(item => ({
            recordId: item.recordId || generateUniqueId(),
            date: item.date || '',
            supplier: item.supplier || '',
            document: item.document || '',
            sheets: item.sheets || '',
            address: item.address || '',
            sender: item.sender || ''
        })),
        proxyData: proxyData.map(item => ({
            recordId: item.recordId || generateUniqueId(),
            date: item.date || '',
            supplier: item.supplier || '',
            phone: item.phone || '',
            contract: item.contract || '',
            product: item.product || '',
            address: item.address || '',
            driver: item.driver || '',
            status: item.status || ''
        })),
        applicationComments: applicationComments,
        departmentsList: departmentsList,
        exportDate: new Date().toISOString(),
        version: '1.1', // Увеличиваем версию для поддержки recordId
        exportInfo: {
            totalRecords: accountingData.length + counterpartiesData.length + paymentsData.length + 
                         settlementData.length + mailData.length + proxyData.length,
            accountingRecords: accountingData.length,
            counterpartiesRecords: counterpartiesData.length,
            paymentsRecords: paymentsData.length,
            settlementRecords: settlementData.length,
            mailRecords: mailData.length,
            proxyRecords: proxyData.length
        }
    };

    try {
        const dataStr = JSON.stringify(allData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `uchet_backup.json`;

        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        showAutosaveNotification('Данные экспортированы в JSON файл');
    } catch (error) {
        console.error('Ошибка экспорта данных:', error);
        alert('Ошибка экспорта данных. Проверьте консоль для деталей.');
    }
}

        function importJSON() {
    closeSettingsMenu();
    
    if (!confirm('ВНИМАНИЕ: Импорт данных заменит все текущие записи. Продолжить?')) {
        return;
    }
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(event) {
            try {
                const importedData = JSON.parse(event.target.result);
                
                // Проверяем версию файла
                const fileVersion = importedData.version || '1.0';
                
                // Восстанавливаем данные
                if (importedData.accountingData) {
                    accountingData = importedData.accountingData;
                    accountingData.forEach(item => {
    // поддержка нового формата
    if (item.planFact && !item.plan) {
        item.plan = item.planFact;
    }

    // поддержка старого формата (на будущее)
    if (item.plan && !item.planFact) {
        item.planFact = item.plan;
    }
});
                    
                    // Для старых версий без recordId, генерируем новые ID
                    if (fileVersion === '1.0') {
                        accountingData.forEach(item => {
                            if (!item.recordId) {
                                item.recordId = generateUniqueId();
                            }
                        });
                    }
                }
                
                if (importedData.counterpartiesData) {
                    counterpartiesData = importedData.counterpartiesData;
                    if (fileVersion === '1.0') {
                        counterpartiesData.forEach(item => {
                            if (!item.recordId) {
                                item.recordId = generateUniqueId();
                            }
                        });
                    }
                }
                
                if (importedData.paymentsData) {
                    paymentsData = importedData.paymentsData;
                    if (fileVersion === '1.0') {
                        paymentsData.forEach(item => {
                            if (!item.recordId) {
                                item.recordId = generateUniqueId();
                            }
                        });
                    }
                }
                
                if (importedData.settlementData) {
                    settlementData = importedData.settlementData;
                    if (fileVersion === '1.0') {
                        settlementData.forEach(item => {
                            if (!item.recordId) {
                                item.recordId = generateUniqueId();
                            }
                        });
                    }
                }
                
                if (importedData.mailData) {
                    mailData = importedData.mailData;
                    if (fileVersion === '1.0') {
                        mailData.forEach(item => {
                            if (!item.recordId) {
                                item.recordId = generateUniqueId();
                            }
                        });
                    }
                }
                
                if (importedData.proxyData) {
                    proxyData = importedData.proxyData;
                    if (fileVersion === '1.0') {
                        proxyData.forEach(item => {
                            if (!item.recordId) {
                                item.recordId = generateUniqueId();
                            }
                            if (item.contract === undefined) item.contract = '';
                        });
                    }
                }
                
                if (importedData.applicationComments) {
                    applicationComments = importedData.applicationComments;
                }
                
                if (importedData.departmentsList) {
                    departmentsList = importedData.departmentsList;
                    saveDepartmentsList();
                }
                
                // Сохраняем все данные
                saveAllData();
                
                // Обновляем интерфейс
                updateAllTables();
                
                // Показываем статистику импорта
                const importStats = {
                    accounting: importedData.accountingData ? importedData.accountingData.length : 0,
                    counterparties: importedData.counterpartiesData ? importedData.counterpartiesData.length : 0,
                    payments: importedData.paymentsData ? importedData.paymentsData.length : 0,
                    settlement: importedData.settlementData ? importedData.settlementData.length : 0,
                    mail: importedData.mailData ? importedData.mailData.length : 0,
                    proxy: importedData.proxyData ? importedData.proxyData.length : 0
                };
                
                showAutosaveNotification(
                    `Данные импортированы: ${importStats.accounting} записей учета, ` +
                    `${importStats.counterparties} контрагентов, ${importStats.payments} платежей`
                );
                
                // Показываем подробную информацию об импорте
                setTimeout(() => {
                    if (confirm(
                        `Импорт завершен успешно!\n\n` +
                        `Статистика импорта:\n` +
                        `• Учет: ${importStats.accounting} записей\n` +
                        `• Контрагенты: ${importStats.counterparties}\n` +
                        `• Платежи: ${importStats.payments}\n` +
                        `• Урегулирование: ${importStats.settlement}\n` +
                        `• Почтовый реестр: ${importStats.mail}\n` +
                        `• Доверенности: ${importStats.proxy}\n\n` +
                        `Обновить страницу для полного применения изменений?`
                    )) {
                        location.reload();
                    }
                }, 500);
                
            } catch (error) {
                console.error('Ошибка импорта данных:', error);
                alert(`Ошибка импорта данных: ${error.message}\n\nПроверьте формат файла.`);
            }
        };
        
        reader.readAsText(file);
    };
    
    input.click();
}

        // ========== ФУНКЦИИ ЭКСПОРТА В EXCEL ==========
function exportToExcel(type) {
    let table, filename;
    
    switch(type) {
        case 'main':
            table = document.getElementById('accountingTable');
            filename = 'Учет_закупок_' + new Date().toISOString().split('T')[0] + '.csv';
            break;
        case 'counterparties':
            table = document.getElementById('counterpartiesTable');
            filename = 'Контрагенты_' + new Date().toISOString().split('T')[0] + '.csv';
            break;
        case 'payments':
            table = document.getElementById('paymentsTable');
            filename = 'Платежи_' + new Date().toISOString().split('T')[0] + '.csv';
            break;
        case 'settlement':
            table = document.getElementById('settlementTable');
            filename = 'Урегулирование_' + new Date().toISOString().split('T')[0] + '.csv';
            break;
        case 'mail':
            table = document.getElementById('mailTable');
            filename = 'Почтовый_реестр_' + new Date().toISOString().split('T')[0] + '.csv';
            break;
        case 'proxy':
            table = document.getElementById('proxyTable');
            filename = 'Доверенности_' + new Date().toISOString().split('T')[0] + '.csv';
            break;
        default:
            return;
    }
    
    if (!table) {
        alert('Таблица не найдена');
        return;
    }
    
    // Собираем данные только из видимых строк
    const visibleRows = [];
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        // Проверяем, видима ли строка
        if (row.style.display !== 'none' && 
            !row.querySelector('td[colspan]') && // Пропускаем строки с сообщениями
            row.cells.length > 1) { // Пропускаем строки "нет данных"
            const rowData = [];
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                rowData.push(cell.textContent.trim());
            });
            visibleRows.push(rowData);
        }
    });
    
    // Если нет видимых строк
    if (visibleRows.length === 0) {
        alert('Нет данных для экспорта');
        return;
    }
    
    // Собираем заголовки
    const headers = [];
    const headerCells = table.querySelectorAll('thead th');
    headerCells.forEach(header => {
        headers.push(header.textContent.trim());
    });
    
    // Формируем CSV
    let csvContent = '\uFEFF'; // BOM для корректного отображения кириллицы в Excel
    
    // Добавляем заголовки
    csvContent += headers.join(';') + '\n';
    
    // Добавляем данные
    visibleRows.forEach(row => {
        csvContent += row.join(';') + '\n';
    });
    
    // Создаем и скачиваем файл
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAutosaveNotification('Данные экспортированы в CSV');
}

        // ========== ИСПРАВЛЕННАЯ ФУНКЦИЯ ПОИСКА ==========
function showCounterpartyInfo(supplierName) {
    if (!supplierName || supplierName.trim() === '') {
        alert('Не указан контрагент');
        return;
    }

    // Функция для очистки строки от "мусора"
    const normalize = (str) => {
        if (!str) return '';
        return str
            .toString()
            .trim()                         // Удаляем пробелы по краям
            .toLowerCase()                  // Приводим к нижнему регистру
            .replace(/['"«»]/g, '')         // Удаляем любые кавычки
            .replace(/\s+/g, ' ');          // Заменяем множественные пробелы и переносы на один пробел
    };

    const targetName = normalize(supplierName);

    // Находим контрагента в базе с использованием нормализации
    const counterparty = counterpartiesData.find(item => 
        item.supplier && normalize(item.supplier) === targetName
    );
    
    if (!counterparty) {
        alert(`Контрагент "${supplierName.trim()}" не найден в базе.\n\nСовет: проверьте наличие лишних пробелов или точность написания.`);
        return;
    }
    
    currentCounterpartyInfo = counterparty;
    
    // Заполняем содержимое
    const content = document.getElementById('counterpartyInfoContent');
    if (!content) return;
    
    let html = `
        <div class="info-row">
            <div class="info-label">Контрагент:</div>
            <div class="info-value supplier-name">${escapeString(counterparty.supplier) || 'Не указано'}</div>
        </div>
    `;
    
    // Добавляем остальные поля
    const fields = [
        { label: 'ИНН:', value: counterparty.inn, key: 'inn' },
        { label: 'Телефон:', value: counterparty.phone, key: 'phone' },
        { label: 'Контактное лицо:', value: counterparty.contact, key: 'contact' },
        { label: 'Email:', value: counterparty.email, key: 'email' },
        { label: 'Почтовый адрес:', value: counterparty.address, key: 'address' },
        { label: 'Материал:', value: counterparty.material, key: 'material' }
    ];
    
    fields.forEach(field => {
        if (counterparty[field.key]) {
            html += `
                <div class="info-row">
                    <div class="info-label">${field.label}</div>
                    <div class="info-value">${escapeString(counterparty[field.key])}</div>
                </div>
            `;
        }
    });
    
    // Черный список
    if (counterparty.blacklisted) {
        html += `
            <div class="blacklist-warning">
                <div class="blacklist-title">
                    <span>⚠️</span>
                    <span>В ЧЕРНОМ СПИСКЕ</span>
                </div>
        `;
        
        if (counterparty.blacklistComment) {
            html += `
                <div class="blacklist-comment">
                    <strong>Причина:</strong> ${escapeString(counterparty.blacklistComment)}
                </div>
            `;
        }
        
        html += `</div>`;
    }
    
    content.innerHTML = html;
    
    // Показываем модальное окно
    document.getElementById('counterpartyInfoModal').style.display = 'block';
}

function closeCounterpartyInfoModal() {
    document.getElementById('counterpartyInfoModal').style.display = 'none';
    currentCounterpartyInfo = null;
}
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик для ссылки "Редактировать (для администратора)"
    const showAdminFormLink = document.getElementById('show-admin-form');
    if (showAdminFormLink) {
        showAdminFormLink.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('admin-form').style.display = 'block';
            this.style.display = 'none';
            document.getElementById('admin-password').focus();
        });
    }
});
// Также добавьте функцию для закрытия по клику на любое место модального окна
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('counterpartyInfoModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            // Закрываем при клике на само модальное окно (фон) или на крестик
            if (e.target === modal || e.target.classList.contains('close')) {
                closeCounterpartyInfoModal();
            }
        });
        
        // Запрещаем закрытие при клике на содержимое
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
    }
});

// Добавить обработчик клика вне модального окна
document.addEventListener('click', function(event) {
    const modal = document.getElementById('counterpartyInfoModal');
    if (event.target === modal) {
        closeCounterpartyInfoModal();
    }
});

        // ========== ФУНКЦИИ ДЛЯ АВТОЗАПОЛНЕНИЯ АДРЕСОВ ==========
        function autoFillCounterpartyAddress() {
            const supplierInput = document.getElementById('editMailSupplier');
            const addressInput = document.getElementById('editMailAddress');
            
            if (!supplierInput || !addressInput) return;
            
            supplierInput.addEventListener('change', function() {
                const supplierName = this.value.trim();
                
                if (!supplierName) {
                    addressInput.value = '';
                    return;
                }
                
                // Ищем контрагента в базе данных
                const counterparty = counterpartiesData.find(item => 
                    item.supplier && item.supplier.trim() === supplierName
                );
                
                // Если нашли контрагента и у него есть адрес - заполняем поле
                if (counterparty && counterparty.address) {
                    addressInput.value = counterparty.address;
                } else {
                    addressInput.value = '';
                }
            });
        }

        function autoFillProxyCounterpartyAddress() {
            const supplierInput = document.getElementById('editProxySupplier');
            const addressInput = document.getElementById('editProxyAddress');
            const phoneInput = document.getElementById('editProxyPhone');
            
            if (!supplierInput || !addressInput) return;
            
            supplierInput.addEventListener('change', function() {
                const supplierName = this.value.trim();
                
                if (!supplierName) {
                    addressInput.value = '';
                    if (phoneInput) phoneInput.value = '';
                    return;
                }
                
                // Ищем контрагента в базе данных
                const counterparty = counterpartiesData.find(item => 
                    item.supplier && item.supplier.trim() === supplierName
                );
                
                // Если нашли контрагента - заполняем поля
                if (counterparty) {
                    if (counterparty.address) {
                        addressInput.value = counterparty.address;
                    }
                    if (phoneInput && counterparty.phone) {
                        phoneInput.value = counterparty.phone;
                    }
                } else {
                    addressInput.value = '';
                    if (phoneInput) phoneInput.value = '';
                }
            });
        }
        // ========== ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ ДАННЫМИ ==========
        function refreshData() {
            console.log('Обновление данных...');
            
            // Перезагружаем данные из localStorage
            loadAllData();
            
            // Обновляем все таблицы
            updateAllTables();
            
            // Обновляем списки
            updateSuppliersList();
            updateApplicationsList();
            updateQuickFilters();
            updateOverdueButton();
            updateWeeklyDeliveriesButton();
               
            // Обновляем бейдж
            updateAccountingBadge();
            
            // Показываем уведомление
            showAutosaveNotification('Данные обновлены');
            
            console.log('Данные успешно обновлены');
        }

        function confirmClearAllData() {
            if (!isAdmin) {
                alert('Только администратор может удалять все данные');
                return;
            }
            
            if (confirm('ВНИМАНИЕ! Вы собираетесь удалить ВСЕ данные из системы. Это действие невозможно отменить.\n\nВы уверены, что хотите продолжить?')) {
                if (confirm('Это окончательное подтверждение. Все данные будут безвозвратно удалены.\n\nНажмите ОК для удаления всех данных.')) {
                    clearAllData();
                }
            }
        }

        function clearAllData() {
    try {
        // Очищаем все массивы данных
        accountingData = [];
        counterpartiesData = [];
        paymentsData = [];
        settlementData = [];
        mailData = [];
        proxyData = [];
        applicationComments = {};
        departmentsList = [];
        
        // Очищаем localStorage
        localStorage.removeItem('accountingData');
        localStorage.removeItem('counterpartiesData');
        localStorage.removeItem('paymentsData');
        localStorage.removeItem('settlementData');
        localStorage.removeItem('mailData');
        localStorage.removeItem('proxyData');
        localStorage.removeItem('applicationComments');
        localStorage.removeItem('departmentsList');
        
        // Сохраняем пустые данные (чтобы структура осталась)
        saveAllData();
        
        // Обновляем интерфейс
        updateAllTables();
        
        // Показываем уведомление
        showAutosaveNotification('Все данные успешно очищены');
        
        // Обновляем кнопки и фильтры
        updateAccountingBadge();
        updateOverdueButton();
        updateWeeklyDeliveriesButton();
        updateSuppliersFilterList();
        updateYearsFilter();
        
    } catch (error) {
        console.error('Ошибка очистки данных:', error);
        alert('Ошибка при очистке данных');
    }
}

        // ========== ФУНКЦИИ ДЛЯ БЕЙДЖА УЧЕТА ==========
        function countWorkingApplications() {
            if (!accountingData || accountingData.length === 0) return 0;
            
            return accountingData.filter(item => item.status === 'В работе').length;
        }

        function updateAccountingBadge() {
            const badge = document.getElementById('accountingBadge');
            if (!badge) return;
            
            const count = countWorkingApplications();
            
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count.toString();
                badge.style.display = 'flex';
                
                // Добавляем класс warning если количество больше 5
                if (count > 20) {
                    badge.classList.add('warning');
                } else {
                    badge.classList.remove('warning');
                }
            } else {
                badge.style.display = 'none';
            }
        }

        // ========== ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ СТРАНИЦАМИ ==========
        let pageTransitionTimeout = null;

function showPage(pageId) {
    // Показываем окно загрузки
    const blurOverlay = document.querySelector('.page-transition-blur');
    const loadingSpinner = document.querySelector('.loading-spinner-blur');
    
    if (blurOverlay && loadingSpinner) {
        blurOverlay.classList.add('active');
        loadingSpinner.classList.add('active');
    }
    
    // Сохраняем текущее состояние активной кнопки быстрых фильтров (если есть)
    const activeQuickFilterBtn = document.querySelector('.quick-filter-btn.active');
    let savedQuickFilterState = null;
    
    if (activeQuickFilterBtn && activeQuickFilterBtn.textContent) {
        savedQuickFilterState = {
            application: activeQuickFilterBtn.textContent.trim(),
            status: document.getElementById('statusFilter')?.value || ''
        };
    }
    
    // Скрываем все страницы с анимацией
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Показываем выбранную страницу
    const activePage = document.getElementById(pageId);
    if (activePage) {
        setTimeout(() => {
            activePage.classList.add('active');
        }, 10);
    }
    
    // Обновляем активный пункт меню в сайдбаре
    document.querySelectorAll('.sidebar-cell.menu-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const activeMenuItem = document.querySelector(`.sidebar-cell.menu-item[data-page="${pageId}"]`);
    if (activeMenuItem) {
        activeMenuItem.classList.add('active');
    }
    
    // Убираем активный класс со всех подпунктов меню настроек
    document.querySelectorAll('#settingsMenu .sidebar-cell.menu-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Закрываем меню настроек при переключении страниц
    closeSettingsMenu();
    
    // Обновляем таблицы в зависимости от выбранной страницы
    setTimeout(() => {
        switch(pageId) {
            case 'accounting':
                updateAccountingTable();
                
                // Восстанавливаем состояние активных фильтров
                if (showOverdueMode) {
                    // Восстанавливаем фильтр просроченных
                    showOverdueOnly();
                    const overdueBtn = document.getElementById('overdueBtn');
                    if (overdueBtn) {
                        const count = countOverdueRecords();
                        overdueBtn.style.background = 'linear-gradient(135deg, rgba(190, 70, 60, 0.9) 0%, rgba(140, 44, 36, 0.9) 100%)';
                        overdueBtn.style.boxShadow = '0 0 10px rgba(190, 70, 60, 0.5)';
                        overdueBtn.textContent = `Скрыть просроченные (${count})`;
                    }
                    // Сбрасываем режим поставок на неделю, если он был
                    showWeeklyDeliveriesMode = false;
                    const weeklyDeliveriesBtn = document.getElementById('weeklyDeliveriesBtn');
                    if (weeklyDeliveriesBtn) {
                        weeklyDeliveriesBtn.style.background = 'linear-gradient(135deg, #ffd700 0%, #ffa500 100%)';
                        weeklyDeliveriesBtn.style.boxShadow = 'none';
                        weeklyDeliveriesBtn.textContent = `Поставки на неделю (${countWeeklyDeliveries()})`;
                    }
                } else if (showWeeklyDeliveriesMode) {
                    // Восстанавливаем фильтр поставок на неделю
                    showWeeklyDeliveriesOnly();
                    const weeklyDeliveriesBtn = document.getElementById('weeklyDeliveriesBtn');
                    if (weeklyDeliveriesBtn) {
                        const count = countWeeklyDeliveries();
                        weeklyDeliveriesBtn.style.background = 'linear-gradient(135deg, #ffd700 0%, #ffa500 100%)';
                        weeklyDeliveriesBtn.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.5)';
                        weeklyDeliveriesBtn.textContent = `Скрыть поставки на неделю (${count})`;
                    }
                    // Сбрасываем режим просроченных, если он был
                    showOverdueMode = false;
                    const overdueBtn = document.getElementById('overdueBtn');
                    if (overdueBtn) {
                        overdueBtn.style.background = 'linear-gradient(135deg, rgba(190, 70, 60, 0.6) 0%, rgba(140, 44, 36, 0.6) 100%)';
                        overdueBtn.style.boxShadow = 'none';
                        overdueBtn.textContent = `Просроченные (${countOverdueRecords()})`;
                    }
                } else {
                    // Иначе применяем обычную фильтрацию
                    filterAccountingTable();
                    updateOverdueButton();
                    updateWeeklyDeliveriesButton();
                }
                
                updateCommentBlockVisibility();
                
                // Восстанавливаем состояние активной кнопки быстрых фильтров (если было сохранено)
                // Только если не активны специальные фильтры (просроченные/поставки на неделю)
                if (!showOverdueMode && !showWeeklyDeliveriesMode && savedQuickFilterState && savedQuickFilterState.application && savedQuickFilterState.status) {
                    // Устанавливаем значения фильтров
                    document.getElementById('applicationFilter').value = savedQuickFilterState.application;
                    document.getElementById('statusFilter').value = savedQuickFilterState.status;
                    
                    // Обновляем быстрые фильтры
                    updateQuickFilters();
                    
                    // Ждем, пока кнопки создадутся, затем восстанавливаем активное состояние
                    setTimeout(() => {
                        const quickFilterButtons = document.querySelectorAll('.quick-filter-btn');
                        quickFilterButtons.forEach(btn => {
                            if (btn.textContent.trim() === savedQuickFilterState.application) {
                                // Убираем активный класс со всех кнопок
                                document.querySelectorAll('.quick-filter-btn').forEach(b => {
                                    b.classList.remove('active');
                                });
                                // Добавляем активный класс нужной кнопке
                                btn.classList.add('active');
                            }
                        });
                        
                        // Применяем фильтрацию
                        filterByApplicationAndStatus(savedQuickFilterState.application, savedQuickFilterState.status);
                    }, 50);
                }
                break;
                
            case 'counterparties':
                updateCounterpartiesTable();
                filterCounterpartiesTable();
                break;
                
            case 'payments':
                updatePaymentsTable();
                filterPaymentsTable();
                break;
                
            case 'settlement':
                updateSettlementTable();
                filterSettlementTable();
                break;
                
            case 'mail-registry':
                updateMailTable();
                filterMailTable();
                break;
                
            case 'proxy-registry':
                updateProxyTable();
                filterProxyTable();
                break;
        }
        // Принудительно применяем фиксированные ширины после обновления таблиц
        setTimeout(() => {
            applyFixedTableLayouts();
            loadColumnWidths();
        }, 100);
        
        // Скрываем окно загрузки после обновления страницы
        setTimeout(() => {
            if (blurOverlay && loadingSpinner) {
                blurOverlay.classList.remove('active');
                loadingSpinner.classList.remove('active');
            }
        }, 200);
        
    }, 100); // Небольшая задержка для плавности перехода
}

// В функции updateQuickFilters добавьте автоматическую активацию кнопки по текущим фильтрам
function updateQuickFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const departmentFilter = document.getElementById('departmentFilter').value;
    const supplierFilter = document.getElementById('supplierFilter').value;
    const quickFiltersContainer = document.getElementById('quickApplicationFilters');
    
    if (!quickFiltersContainer) {
        console.error('Контейнер быстрых фильтров не найден');
        return;
    }
    
    // Очищаем контейнер
    quickFiltersContainer.innerHTML = '';
    
    // УСЛОВИЯ СКРЫТИЯ БЫСТРЫХ ФИЛЬТРОВ:
    // 1. Если статус не выбран или статус "Выполнено", "Приход"
    // 2. Если заполнен фильтр по подразделению
    // 3. Если заполнен фильтр по поставщику
    if (!statusFilter || 
        statusFilter === 'Выполнено' || 
        statusFilter === 'Приход' || 
        departmentFilter.trim() !== '' ||
        supplierFilter.trim() !== '') {
        
        quickFiltersContainer.style.display = 'none';
        return;
    }
    
    // Проверяем наличие данных
    if (!accountingData || accountingData.length === 0) {
        quickFiltersContainer.innerHTML = '<span style="color: #8f98a0; font-style: italic;">Нет данных для фильтрации</span>';
        quickFiltersContainer.style.display = 'flex';
        return;
    }
    
    const applicationsWithStatus = new Set();
    
    // Собираем уникальные номера заявок с выбранным статусом
    accountingData.forEach(item => {
        if (item.docNumber && item.status === statusFilter) {
            applicationsWithStatus.add(item.docNumber);
        }
    });
    
    // Если нет заявок с выбранным статусом
    if (applicationsWithStatus.size === 0) {
        quickFiltersContainer.innerHTML = '<span style="color: #8f98a0; font-style: italic;">Нет заявок с выбранным статусом</span>';
        quickFiltersContainer.style.display = 'flex';
        return;
    }
    
    // Создаем контейнер для заголовка
    const label = document.createElement('div');
    label.className = 'quick-filters-label';
    label.textContent = 'Заявки:';
    quickFiltersContainer.appendChild(label);
    
    // Создаем контейнер для кнопок фильтров
    const filtersContainer = document.createElement('div');
    filtersContainer.className = 'quick-filters';
    
    // Преобразуем Set в массив и сортируем
    const sortedApplications = Array.from(applicationsWithStatus).sort((a, b) => {
        const numA = parseInt(a.replace(/\D/g, '')) || 0;
        const numB = parseInt(b.replace(/\D/g, '')) || 0;
        return numA - numB;
    });
    
    // Получаем текущее значение фильтра заявки
    const currentApplicationFilter = document.getElementById('applicationFilter').value.trim();
    
    // Создаем кнопки для каждой заявки
    sortedApplications.forEach(app => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = `quick-filter-btn status-${getStatusClass(statusFilter)}`;
        button.textContent = app;
        button.title = `Показать заявку ${app} (статус: ${statusFilter})`;
        
        // ===== ДОБАВЛЕНО: Автоматически активируем кнопку, если она соответствует текущему фильтру =====
        if (app === currentApplicationFilter) {
            button.classList.add('active');
        }
        
        button.onclick = () => {
            // Удаляем активный класс со всех кнопок
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Добавляем активный класс текущей кнопке
            button.classList.add('active');
            
            // Устанавливаем фильтры
            document.getElementById('applicationFilter').value = app;
            document.getElementById('statusFilter').value = statusFilter;
            
            // Применяем фильтрацию
            filterByApplicationAndStatus(app, statusFilter);
        };
        
        filtersContainer.appendChild(button);
    });
    
    quickFiltersContainer.appendChild(filtersContainer);
    quickFiltersContainer.style.display = 'flex';
}

// В функции filterByApplicationAndStatus также добавьте обновление активной кнопки
function filterByApplicationAndStatus(applicationNumber, status) {
    const searchText = document.getElementById('searchAccountingInput').value.toLowerCase();
    const rows = document.querySelectorAll('#accountingTable tbody tr');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        // Пропускаем строку с сообщением "нет данных"
        if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
            row.style.display = 'none';
            return;
        }
        
        const cells = row.querySelectorAll('td');
        if (cells.length < 4) {
            row.style.display = 'none';
            return;
        }
        
        const appCell = cells[1] ? cells[1].textContent.trim() : '';
        const statusCell = cells[2] ? cells[2].textContent : '';
        
        let rowText = '';
        cells.forEach(cell => {
            rowText += cell.textContent.toLowerCase() + ' ';
        });
        
        const appMatch = appCell === applicationNumber;
        const statusMatch = status ? (statusCell === status) : true;
        const searchMatch = !searchText || rowText.includes(searchText);
        
        if (appMatch && statusMatch && searchMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Показываем блок комментариев при выборе заявки
    const commentBlock = document.querySelector('.comment-control');
    if (commentBlock && applicationNumber) {
        commentBlock.classList.remove('hidden');
    }
    
    // ===== ДОБАВЛЕНО: Обновляем активную кнопку в быстрых фильтрах =====
    // Удаляем активный класс со всех кнопок
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Находим и активируем кнопку, соответствующую выбранной заявке
    const quickFilterButtons = document.querySelectorAll('.quick-filter-btn');
    quickFilterButtons.forEach(btn => {
        if (btn.textContent.trim() === applicationNumber) {
            btn.classList.add('active');
        }
    });
    
    // Показываем сообщение, если нет видимых строк
    if (visibleCount === 0 && (searchText || applicationNumber || status)) {
        const tableBody = document.querySelector('#accountingTable tbody');
        let noDataRow = tableBody.querySelector('tr[data-no-results]');
        
        if (!noDataRow) {
            noDataRow = document.createElement('tr');
            noDataRow.setAttribute('data-no-results', 'true');
            noDataRow.innerHTML = `
                <td colspan="20" style="text-align: center; color: #8f98a0; padding: 20px;">
                    По вашему запросу ничего не найдено
                </td>
            `;
            tableBody.appendChild(noDataRow);
        }
    } else {
        const noDataRow = document.querySelector('#accountingTable tr[data-no-results]');
        if (noDataRow) {
            noDataRow.remove();
        }
    }
    
    // Устанавливаем значения в поля фильтров
    document.getElementById('applicationFilter').value = applicationNumber;
    document.getElementById('statusFilter').value = status;
    
    updateCommentField();
}
function startPageLoadCheck(pageId, blurElement, spinnerElement) {
    let checkCount = 0;
    const maxChecks = 30; // Максимум 3 секунды (30 * 100мс)
    const pageElement = document.getElementById(pageId);
    
    function checkPageLoaded() {
        checkCount++;
        
        // Проверяем, полностью ли загружена страница
        const isPageLoaded = isPageContentFullyLoaded(pageId);
        
        if (isPageLoaded || checkCount >= maxChecks) {
            // Страница загружена или превышен лимит проверок
            hideBlur(blurElement, spinnerElement);
        } else {
            // Продолжаем проверку
            setTimeout(checkPageLoaded, 100);
        }
    }
    
    // Начинаем проверку
    setTimeout(checkPageLoaded, 100);
}

function isPageContentFullyLoaded(pageId) {
    const page = document.getElementById(pageId);
    if (!page) return true;
    
    switch (pageId) {
        case 'accounting':
            // Проверяем, что таблица учета заполнена
            const accountingRows = document.querySelectorAll('#accountingTable tbody tr');
            return accountingRows.length > 1 || 
                   (accountingRows.length === 1 && !accountingRows[0].querySelector('td[colspan]'));
            
        case 'counterparties':
            // Проверяем таблицу контрагентов
            const counterpartyRows = document.querySelectorAll('#counterpartiesTable tbody tr');
            return counterpartyRows.length > 1 || 
                   (counterpartyRows.length === 1 && !counterpartyRows[0].querySelector('td[colspan]'));
            
        case 'payments':
            // Проверяем таблицу платежей
            const paymentRows = document.querySelectorAll('#paymentsTable tbody tr');
            return paymentRows.length > 1 || 
                   (paymentRows.length === 1 && !paymentRows[0].querySelector('td[colspan]'));
            
        case 'settlement':
            // Проверяем таблицу урегулирования
            const settlementRows = document.querySelectorAll('#settlementTable tbody tr');
            return settlementRows.length > 1 || 
                   (settlementRows.length === 1 && !settlementRows[0].querySelector('td[colspan]'));
            
        case 'mail-registry':
            // Проверяем почтовый реестр
            const mailRows = document.querySelectorAll('#mailTable tbody tr');
            return mailRows.length > 1 || 
                   (mailRows.length === 1 && !mailRows[0].querySelector('td[colspan]'));
            
        case 'proxy-registry':
            // Проверяем реестр доверенностей
            const proxyRows = document.querySelectorAll('#proxyTable tbody tr');
            return proxyRows.length > 1 || 
                   (proxyRows.length === 1 && !proxyRows[0].querySelector('td[colspan]'));
            
        default:
            return true;
    }
}

function hideBlur(blurElement, spinnerElement) {
    // Минимальное время показа блюра - 1.5 секунды
    pageTransitionTimeout = setTimeout(() => {
        if (blurElement && spinnerElement) {
            blurElement.classList.remove('active');
            spinnerElement.classList.remove('active');
        }
        pageTransitionTimeout = null;
    }, 1500); // 1.5 секунды
}

// Переопределяем обработчики кликов в сайдбаре
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.sidebar-cell.menu-item[data-page]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const pageId = this.dataset.page;
            showPage(pageId);
        });
    });
});

        function initializePageElements(pageId) {
    console.log('Инициализация страницы:', pageId);
    
    switch(pageId) {
        case 'accounting':
            filterAccountingTable();
            updateQuickFilters();
            updateCommentField();
            updateCommentFieldPermissions();
            updateCommentBlockVisibility();
            break;
        case 'counterparties':
            filterCounterpartiesTable();
            break;
        case 'settlement':
            filterSettlementTable();
            break;
        case 'mail-registry':
            filterMailTable();
            break;
        case 'proxy-registry':
            filterProxyTable();
            break;
        case 'payments':
            filterPaymentsTable();
            break;
    }
}
// ========== ФУНКЦИИ ДЛЯ СТРАНИЦЫ ВХОДА ==========

// Проверяем, был ли уже выполнен вход в текущей сессии
let hasLoggedInThisSession = false;

// Показываем страницу входа при загрузке
function showLoginPage() {
    document.getElementById('login-page').classList.add('active');
    document.querySelector('.sidebar').style.display = 'none';
    document.querySelector('.main-content').style.display = 'none';
}

// Скрываем страницу входа
function hideLoginPage() {
    document.getElementById('login-page').classList.remove('active');
    document.querySelector('.sidebar').style.display = 'block';
    document.querySelector('.main-content').style.display = 'block';
}

// Основная функция запуска приложения
function startApplication() {
    // Показываем индикатор загрузки
    document.getElementById('startButton').style.display = 'none';
    document.getElementById('loginLoading').classList.add('active');
    
    // Имитация загрузки (можно убрать setTimeout в рабочей версии)
    setTimeout(() => {
        // Проверяем, есть ли сохраненная авторизация
        const savedAuth = localStorage.getItem('userAuth');
        
        if (savedAuth) {
            try {
                const auth = JSON.parse(savedAuth);
                if (auth && typeof auth.isAdmin !== 'undefined' && auth.currentUser) {
                    isAdmin = auth.isAdmin;
                    currentUser = auth.currentUser;
                } else {
                    // Если данные некорректные, используем гостевой режим
                    isAdmin = false;
                    currentUser = 'guest';
                }
            } catch (e) {
                console.error('Ошибка при загрузке данных авторизации:', e);
                isAdmin = false;
                currentUser = 'guest';
            }
        } else {
            // Нет сохраненной авторизации - гостевой режим
            isAdmin = false;
            currentUser = 'guest';
        }
        
        // Отмечаем, что вход выполнен в этой сессии
        hasLoggedInThisSession = true;
        
        // Сохраняем состояние авторизации
        localStorage.setItem('userAuth', JSON.stringify({ 
            isAdmin, 
            currentUser 
        }));
        
        // Инициализируем приложение
        initializeApp();
        
        // Скрываем страницу входа
        hideLoginPage();
        
        // Показываем уведомление о режиме
        setTimeout(() => {
            if (isAdmin) {
                showAutosaveNotification('Режим администратора активен');
            } else {
                showAutosaveNotification('Гостевой режим активен');
            }
        }, 500);
        
    }, 1000); // Задержка для эффекта загрузки
}

// Модифицируем функцию initializeApp для проверки страницы входа
function initializeApp() {
    // Загружаем все данные
    loadAllData();
    
    // Показываем основной интерфейс (уже показан в hideLoginPage)
    document.querySelector('.sidebar').style.display = 'block';
    document.querySelector('.main-content').style.display = 'block';
    
    if (!currentUser) {
        isAdmin = false;
        currentUser = 'guest';
    }
    
    // Обновляем интерфейс
    updateUserInterface();
    resetAllFilters();
}

// Модифицируем функцию toggleUserMode для сброса сессии при выходе администратора
function toggleUserMode() {
    // Если уже в режиме администратора, переключаем в гостевой без пароля
    if (isAdmin) {
        isAdmin = false;
        currentUser = 'guest';
        updateUserInterface();
        resetAllFilters();
        showAutosaveNotification('Включен гостевой режим');
        
        // Обновляем сохраненную авторизацию
        localStorage.setItem('userAuth', JSON.stringify({ 
            isAdmin, 
            currentUser 
        }));
        return;
    }
    
    // Если в гостевом режиме, запрашиваем пароль для перехода в административный
    showAdminPasswordModal();
}
// Функция для принудительного обновления таблицы учета
function forceTableUpdate() {
    const table = document.getElementById('accountingTable');
    if (table) {
        // Принудительный рефлоу
        void table.offsetWidth;
        
        // Обновление стилей
        table.style.display = 'none';
        setTimeout(() => {
            table.style.display = '';
        }, 10);
    }
}
        function initializeCurrentPage() {
            // Находим активную страницу и принудительно вызываем showPage для неё
            const activePage = document.querySelector('.page.active');
            if (activePage) {
                const pageId = activePage.id;
                initializePageElements(pageId);
            }
        }

                // ========== ИНИЦИАЛИЗАЦИЯ ==========
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthOnLoad();
            
            // Добавляем глобальные обработчики событий для изменения ширины
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResizing);
            
            const adminPassword = document.getElementById('admin-password');
            if (adminPassword) {
                adminPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loginAsAdmin();
                    }
                });
            }
            
            window.addEventListener('beforeunload', function(e) {
                if (changesMade) {
                    e.preventDefault();
                    e.returnValue = 'У вас есть несохраненные изменения. Вы уверены, что хотите уйти?';
                    return e.returnValue;
                }
            });

            window.onclick = function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            };

            // Обработчик события для чекбокса черного списка
            const blacklistedCheckbox = document.getElementById('editBlacklisted');
            if (blacklistedCheckbox) {
                blacklistedCheckbox.addEventListener('change', toggleBlacklistComment);
            }

            // Обработчик для поля выбора поставщика в аналитике
            const supplierSelect = document.getElementById('analyticsSupplierSelect');
            if (supplierSelect) {
                supplierSelect.addEventListener('input', function() {
                    updateSupplierAnalytics();
                });
            }
            // Инициализируем валидацию для поля заявки
            const appInput = document.getElementById('editDocNumber');
            if (appInput) {
            appInput.addEventListener('input', function() {
            formatApplicationNumber(this);
        });
        
        autoCompleteApplicationDate();
    }
            // Добавляем небольшую задержку для полной инициализации DOM
            setTimeout(() => {
                initializeCurrentPage();
            }, 100);
        });
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM загружен, начинаем инициализацию...');
    
    // Проверяем и загружаем данные
    checkAuthOnLoad();
    
    // Инициализируем другие элементы интерфейса
    initializeCurrentPage();
    
    // Добавляем глобальные обработчики событий
    document.addEventListener('mousemove', handleResize);
    document.addEventListener('mouseup', stopResizing);
    
    // Инициализация изменения ширины столбцов
    setTimeout(() => {
        initColumnResize();
        loadColumnWidths();
    }, 500);
    
    console.log('Данные загружены:', {
        accounting: accountingData.length,
        counterparties: counterpartiesData.length,
        payments: paymentsData.length
    });
});
// ========== ФИКСИРОВАННЫЙ МАСШТАБ 100% ==========
function setFixedZoom() {
    // Устанавливаем масштаб 100% для body (нормальный размер)
    document.body.style.zoom = '100%';
    
    // Для Firefox и других браузеров, которые не поддерживают zoom
    document.body.style.transform = 'scale(1)';
    document.body.style.transformOrigin = 'top left';
    
    // Фиксируем ширину/высоту для корректного отображения
    document.body.style.width = '100%';
    document.body.style.height = '100%';
    
    // Предотвращаем изменение масштаба пользователем
    document.addEventListener('wheel', function(e) {
        if (e.ctrlKey) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // Предотвращаем изменение масштаба через меню браузера
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '0')) {
            e.preventDefault();
        }
    });
    
    // Сохраняем настройку масштаба в localStorage
    localStorage.setItem('fixedZoom', '100%');
}

// Проверяем, нужно ли применить фиксированный масштаб
function applyFixedZoom() {
    const savedZoom = localStorage.getItem('fixedZoom');
    const isFirstVisit = !savedZoom;
    
    // Если это первый заход или масштаб не установлен, применяем 100%
    if (isFirstVisit || savedZoom !== '100%') {
        setFixedZoom();
    } else {
        // Восстанавливаем сохраненный масштаб
        document.body.style.zoom = savedZoom;
        document.body.style.transform = `scale(${parseInt(savedZoom) / 100})`;
        document.body.style.transformOrigin = 'top left';
        document.body.style.width = `${100 / (parseInt(savedZoom) / 100)}%`;
        document.body.style.height = `${100 / (parseInt(savedZoom) / 100)}%`;
    }
    
    // Блокируем стандартное меню масштаба
    disableBrowserZoom();
}

// Блокировка стандартного масштаба браузера
function disableBrowserZoom() {
    // Убираем стандартное поведение Ctrl + колесико
    document.addEventListener('wheel', function(e) {
        if (e.ctrlKey) {
            e.preventDefault();
            return false;
        }
    }, { passive: false });
    
    // Блокируем Ctrl + '+'/'-'/'0'
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '0' || 
                          e.key === '=' || e.code === 'NumpadAdd' || 
                          e.code === 'NumpadSubtract')) {
            e.preventDefault();
            return false;
        }
    });
    
    // Блокируем контекстное меню
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        return false;
    });
}

// Применяем фиксированный масштаб при загрузке страницы
window.addEventListener('load', function() {
    setTimeout(applyFixedZoom, 100);
});

// Также применяем при полной загрузке DOM
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(applyFixedZoom, 50);
});

// Восстанавливаем масштаб при изменении размера окна
window.addEventListener('resize', function() {
    setTimeout(applyFixedZoom, 100);
});
function resetAllFilters() {
    // Сброс фильтров на странице Учета
    clearAccountingFilters();
    
    // Сброс фильтров на странице Контрагентов
    if (document.getElementById('searchCounterpartiesInput')) {
        document.getElementById('searchCounterpartiesInput').value = '';
        showOnlyBlacklisted = false;
        const blacklistBtn = document.getElementById('blacklistFilterBtn');
        if (blacklistBtn) {
            blacklistBtn.textContent = 'Показать черный список';
            blacklistBtn.style.background = '';
        }
        filterCounterpartiesTable();
    }
    
    // Сброс фильтров на странице Платежей
    if (document.getElementById('searchPaymentsInput')) {
        document.getElementById('searchPaymentsInput').value = '';
        document.getElementById('paymentsStatusFilter').value = '';
        filterPaymentsTable();
    }
    
    // Сброс фильтров на странице Урегулирования
    if (document.getElementById('searchSettlementInput')) {
        document.getElementById('searchSettlementInput').value = '';
        document.getElementById('settlementStatusFilter').value = '';
        filterSettlementTable();
    }
    
    // Сброс фильтров на странице Почтового реестра
    if (document.getElementById('searchMailInput')) {
        document.getElementById('searchMailInput').value = '';
        document.getElementById('mailDateFilter').value = '';
        filterMailTable();
    }
    
    // Сброс фильтров на странице Реестра доверенностей
    if (document.getElementById('searchProxyInput')) {
        document.getElementById('searchProxyInput').value = '';
        document.getElementById('proxyStatusFilter').value = '';
        filterProxyTable();
    }
    
    // Скрываем блок комментариев
    const commentBlock = document.querySelector('.comment-control');
    if (commentBlock) {
        commentBlock.classList.add('hidden');
    }
    
    // Скрываем меню настроек если открыто
    closeSettingsMenu();
    
    showAutosaveNotification('Все фильтры сброшены');
}
// Запускаем приложение при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Всегда показываем страницу входа при новой загрузке
    showLoginPage();
    
    // Инициализируем данные, но не показываем основной интерфейс
    loadAllData();
    initializeRecordIds();
    
    // Добавляем обработчик клавиши Enter на странице входа
    document.getElementById('login-page').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && document.getElementById('login-page').classList.contains('active')) {
            startApplication();
        }
    });
});
    


</script>
<!-- Блюр экрана при переключении страниц -->
<div id="pageTransitionBlur" class="page-transition-blur"></div>
<div id="loadingSpinnerBlur" class="loading-spinner-blur"></div>

<datalist id="contractsList"></datalist>
<datalist id="applicationsList"></datalist>
<datalist id="applicationsListFilter"></datalist>
<datalist id="paymentTermsList">
    <option value="100 % предоплата">
    </option><option value="100 % отсрочка 10 к.дн.">
</option></datalist>
<!-- Страница входа -->
<div id="login-page" class="">
    <div class="login-container">
        <h1 class="login-title">Учет закупок</h1>
        <p class="login-subtitle">Добро пожаловать в систему управления закупками</p>
        
        <button class="start-button" id="startButton" onclick="startApplication()"> START </button>
        
        <div class="login-loading" id="loginLoading">
            <div class="loading-spinner"></div>
            <p style="color: #66c0f4; margin-top: 10px;">Загрузка системы...</p>
        </div>
        
       <div class="login-footer">
    <p style="font-size: 12px; margin-top: 5px;">
        <strong>ВНИМАНИЕ:</strong> Данное приложение предназначено исключительно для демонстрации и тестирования функционала системы управления заказами.<br><br>
        <strong>Конфиденциальность и хранение данных:</strong><br>
        Все данные, которые вы вводите в приложении (наименования организаций, реквизиты, контракты, суммы и прочая информация), <strong>не передаются на сторонние серверы и не обрабатываются внешними сервисами</strong>. Введенная информация сохраняется исключительно <strong>локально на вашем устройстве</strong> в памяти вашего браузера. Для этого используется технология <code>LocalStorage</code>, где данные хранятся в формате <strong>JSON</strong>.<br><br>
        <strong>Перенос данных:</strong><br>
        Для обеспечения мобильности и возможности восстановления информации предусмотрены функции <strong>импорта и экспорта</strong> данных в виде JSON-файла. Вы можете самостоятельно сохранить резервную копию своих данных на диск или перенести их в другой браузер.
    </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const rows = document.querySelectorAll('tr.clickable-row');
  rows.forEach(row => {
    let clickTimer = null;

    row.addEventListener('click', () => {
      clickTimer = setTimeout(() => {
        row.classList.toggle('selected-row');
      }, 200);
    });

    row.addEventListener('dblclick', () => {
      if (clickTimer) clearTimeout(clickTimer);
      if (window.isAdmin) {
        row.dispatchEvent(new Event('editRow'));
      }
    });
  });
});
</script>
<style>
.selected-row {
  outline: 2px solid #6c5ce7;
}
</style>



</body>
</html>